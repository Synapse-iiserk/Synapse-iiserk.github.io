<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iFINN | Algorithm Simulation Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark:#0b0e11;--bg-panel:#1e2329;--bg-elev:#11151c;
            --border:#2b3139;--text-main:#eaecef;--text-muted:#848e9c;
            --primary:#fcd535;--up:#0ecb81;--down:#f6465d;
        }
        *{box-sizing:border-box;margin:0;padding:0;}
        body{background:var(--bg-dark);color:var(--text-main);font-family:'Space Grotesk','Inter',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
        ::-webkit-scrollbar{width:5px;height:5px;}
        ::-webkit-scrollbar-track{background:var(--bg-dark);}
        ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

        header{height:52px;min-height:52px;background:var(--bg-panel);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:20;}

        .tab-bar{display:flex;background:var(--bg-panel);border-bottom:1px solid var(--border);padding:0 20px;gap:2px;}
        .main-tab{padding:10px 20px;font-size:12px;font-weight:600;color:var(--text-muted);border-bottom:2px solid transparent;cursor:pointer;transition:all .15s;letter-spacing:.03em;user-select:none;}
        .main-tab.active{color:var(--primary);border-bottom-color:var(--primary);}
        .main-tab:hover:not(.active){color:var(--text-main);}

        .tab-content{flex:1;overflow:hidden;display:none;}
        .tab-content.active{display:flex;}
        .sim-layout{flex:1;display:grid;grid-template-columns:300px 1fr;overflow:hidden;gap:1px;background:var(--border);}
        .config-panel{background:var(--bg-panel);overflow-y:auto;padding:16px 12px;display:flex;flex-direction:column;gap:10px;}
        .sim-main{background:var(--bg-elev);overflow-y:auto;padding:20px;}

        .card{background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:14px;}
        .label{font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted);margin-bottom:5px;}
        .ctrl{width:100%;background:#11151c;border:1px solid var(--border);color:var(--text-main);border-radius:5px;padding:7px 10px;font-size:13px;font-family:inherit;outline:none;transition:border-color .18s;}
        .ctrl:focus{border-color:var(--primary);}
        .btn-primary{width:100%;background:var(--primary);color:#000;font-weight:700;font-size:13px;border:none;border-radius:6px;padding:11px;cursor:pointer;letter-spacing:.03em;transition:opacity .15s,transform .1s;}
        .btn-primary:hover{opacity:.9;}.btn-primary:active{transform:scale(.98);}.btn-primary:disabled{opacity:.4;cursor:not-allowed;}
        .btn-danger{width:100%;background:#f6465d22;color:#f6465d;font-weight:700;font-size:13px;border:1px solid #f6465d44;border-radius:6px;padding:11px;cursor:pointer;transition:all .15s;}
        .btn-danger:hover{background:#f6465d;color:#fff;}
        .btn-sec{background:var(--border);color:var(--text-muted);font-size:12px;border:none;border-radius:5px;padding:7px 12px;cursor:pointer;font-family:inherit;transition:background .15s;}
        .btn-sec:hover{background:#3a424e;color:#fff;}

        .search-wrap{position:relative;}
        .search-drop{position:absolute;top:100%;left:0;right:0;background:#1e2329;border:1px solid var(--border);border-top:none;border-radius:0 0 6px 6px;max-height:200px;overflow-y:auto;z-index:100;display:none;}
        .search-drop.show{display:block;}
        .sdrop-item{padding:8px 10px;font-size:12px;cursor:pointer;display:flex;justify-content:space-between;border-bottom:1px solid #2b3139;}
        .sdrop-item:hover{background:#2b3139;}

        .algo-grid{display:flex;flex-wrap:wrap;gap:5px;}
        .algo-chip{font-size:10px;padding:3px 7px;border-radius:4px;border:1px solid var(--border);cursor:pointer;background:#11151c;color:var(--text-muted);user-select:none;transition:all .15s;}
        .algo-chip.active{background:rgba(252,213,53,.15);border-color:var(--primary);color:var(--primary);}

        .progress-track{background:var(--border);border-radius:4px;height:6px;overflow:hidden;}
        .progress-fill{height:100%;background:var(--primary);border-radius:4px;transition:width .1s linear;width:0%;}

        .results-table{width:100%;border-collapse:collapse;font-size:12px;}
        .results-table th{text-align:left;padding:8px 10px;font-size:10px;text-transform:uppercase;letter-spacing:.07em;color:var(--text-muted);border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;}
        .results-table th:hover{color:var(--text-main);}
        .results-table th.sort-asc::after{content:' ‚ñ≤';}.results-table th.sort-desc::after{content:' ‚ñº';}
        .results-table td{padding:8px 10px;border-bottom:1px solid #1e2329;vertical-align:middle;}
        .results-table tr:hover td{background:rgba(255,255,255,.02);}
        .acc-bar-wrap{background:#11151c;border-radius:3px;height:6px;width:80px;display:inline-block;vertical-align:middle;overflow:hidden;}
        .acc-bar{height:100%;border-radius:3px;}
        .grade{font-size:11px;font-weight:700;padding:2px 7px;border-radius:4px;}
        .grade-S{background:rgba(252,213,53,.2);color:#fcd535;}.grade-A{background:rgba(14,203,129,.2);color:#0ecb81;}
        .grade-B{background:rgba(41,182,246,.2);color:#29b6f6;}.grade-C{background:rgba(255,112,67,.2);color:#ff7043;}.grade-D{background:rgba(246,70,93,.15);color:#f6465d;}

        .stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
        .stat-box{background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;padding:12px;text-align:center;}
        .stat-val{font-size:20px;font-weight:700;}
        .stat-lbl{font-size:9px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted);margin-top:3px;}

        canvas.equity{width:100%;height:160px;border-radius:6px;display:block;}
        .ensemble-box{border:1px solid var(--border);border-radius:8px;padding:16px 20px;display:flex;align-items:center;gap:16px;}
        .esig{font-size:28px;font-weight:800;letter-spacing:-.02em;}

        .log-console{background:#080a0d;border:1px solid var(--border);border-radius:6px;padding:10px;font-family:'Courier New',monospace;font-size:11px;height:120px;overflow-y:auto;color:#848e9c;}
        .log-ok{color:#0ecb81;}.log-warn{color:#fcd535;}.log-err{color:#f6465d;}.log-info{color:#29b6f6;}

        [data-tip]{position:relative;cursor:help;}
        [data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:#2b3139;color:#eaecef;font-size:10px;padding:4px 8px;border-radius:4px;white-space:nowrap;pointer-events:none;z-index:200;}

        /* LIVE TRADING */
        .portfolio-header{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:18px;}
        .pstat{background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:14px;text-align:center;}
        .pstat-val{font-size:22px;font-weight:800;line-height:1;}
        .pstat-lbl{font-size:9px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted);margin-top:4px;}

        .countdown-ring{position:relative;display:inline-flex;align-items:center;justify-content:center;}
        .countdown-ring svg{transform:rotate(-90deg);}
        .countdown-val{position:absolute;font-size:18px;font-weight:800;font-family:'Courier New',monospace;}

        .algo-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;margin-bottom:16px;}
        .algo-card{background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:12px;transition:border-color .2s;}
        .algo-card.signal-buy{border-color:#0ecb8155;}
        .algo-card.signal-sell{border-color:#f6465d55;}
        .algo-card.signal-hold{border-color:#fcd53533;}
        .algo-card.verified-win{border-color:#0ecb81;background:rgba(14,203,129,.05);}
        .algo-card.verified-loss{border-color:#f6465d;background:rgba(246,70,93,.05);}
        .acard-name{font-size:11px;font-weight:700;margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .acard-signal{font-size:16px;font-weight:800;line-height:1;}
        .acard-alloc{font-size:10px;color:var(--text-muted);margin-top:3px;}
        .acard-pnl{font-size:13px;font-weight:700;margin-top:6px;}
        .acard-result{font-size:18px;margin-top:2px;}
        .signal-badge{display:inline-block;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:800;letter-spacing:.06em;}
        .badge-buy{background:rgba(14,203,129,.2);color:#0ecb81;}
        .badge-sell{background:rgba(246,70,93,.2);color:#f6465d;}
        .badge-hold{background:rgba(252,213,53,.15);color:#fcd535;}

        .session-log{background:#080a0d;border:1px solid var(--border);border-radius:6px;padding:10px;font-family:'Courier New',monospace;font-size:11px;height:160px;overflow-y:auto;color:#848e9c;}
        .round-row{display:flex;align-items:center;gap:10px;padding:8px 10px;border-bottom:1px solid #1e2329;font-size:12px;}
        .round-row:last-child{border-bottom:none;}
        .amount-group{display:flex;gap:6px;}
        .amount-group .ctrl{flex:1;}
        .idle-art{font-size:70px;text-align:center;margin-bottom:14px;opacity:.35;}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        .pulse{animation:pulse 1.5s ease-in-out infinite;}
        .rank-badge{font-size:9px;font-weight:700;padding:2px 5px;border-radius:3px;margin-right:6px;}
    </style>
</head>
<body>

<header>
    <div style="display:flex;align-items:center;gap:14px">
        <a href="/chart.html" style="color:var(--text-muted);font-size:18px;text-decoration:none">‚Üê</a>
        <h1 style="font-size:17px;font-weight:700;letter-spacing:-.02em">
            <span style="color:#fcd535">iFINN</span>
            <span style="color:#3a424e;margin:0 6px">|</span>
            <span style="font-size:13px;font-weight:600">Algorithm Lab</span>
        </h1>
        <span style="font-size:10px;background:#2b3139;color:#848e9c;padding:2px 8px;border-radius:4px">v3.0</span>
    </div>
    <div style="display:flex;align-items:center;gap:14px;font-size:11px;font-family:'Courier New',monospace">
        <span id="hdr-symbol" style="color:#fff;font-weight:700">--</span>
        <span id="hdr-price" style="color:#fcd535">--</span>
        <span id="hdr-status" style="color:#848e9c">IDLE</span>
    </div>
</header>

<div class="tab-bar">
    <div class="main-tab active" id="mtab-backtest" onclick="switchTab('backtest')">üìä Walk-Forward Backtest</div>
    <div class="main-tab" id="mtab-live" onclick="switchTab('live')">üî¥ Live Paper Trading</div>
</div>

<!-- ‚ïê‚ïê TAB 1: BACKTEST ‚ïê‚ïê -->
<div class="tab-content active" id="tab-backtest">
<div class="sim-layout">
<aside class="config-panel">
    <div class="card">
        <div class="label">Symbol</div>
        <div class="search-wrap">
            <input id="bt-sym" class="ctrl" type="text" placeholder="BTC, ETH‚Ä¶" autocomplete="off">
            <div id="bt-sym-drop" class="search-drop"></div>
        </div>
        <div id="bt-sym-sel" style="margin-top:6px;font-size:11px;color:var(--text-muted)">No symbol selected</div>
    </div>
    <div class="card">
        <div class="label">Timeframe</div>
        <select id="bt-tf" class="ctrl" onchange="updateBtLbl()">
            <option value="1m">1 Minute</option><option value="5m">5 Minutes</option>
            <option value="15m">15 Minutes</option><option value="1h" selected>1 Hour</option>
            <option value="4h">4 Hours</option><option value="1d">1 Day</option>
        </select>
    </div>
    <div class="card">
        <div class="label">Historical Candles</div>
        <select id="bt-limit" class="ctrl">
            <option value="200">200 candles</option><option value="500" selected>500 candles</option><option value="1000">1000 candles</option>
        </select>
    </div>
    <div class="card">
        <div class="label">Prediction Horizon</div>
        <div style="display:flex;gap:8px;align-items:center">
            <input id="bt-horizon" class="ctrl" type="number" value="5" min="1" max="100" style="width:65px" oninput="updateBtLbl()">
            <span style="font-size:11px;color:var(--text-muted)">candles ahead</span>
        </div>
        <div id="bt-horizon-lbl" style="margin-top:4px;font-size:10px;color:#3a424e">= 5h on 1H</div>
    </div>
    <div class="card">
        <div class="label">Warm-up Period</div>
        <div style="display:flex;gap:8px;align-items:center">
            <input id="bt-warmup" class="ctrl" type="number" value="100" min="50" max="300" style="width:65px">
            <span style="font-size:11px;color:var(--text-muted)">candles</span>
        </div>
    </div>
    <div class="card">
        <div class="label" style="margin-bottom:8px">Algorithms</div>
        <div class="algo-grid" id="bt-chips"></div>
        <div style="display:flex;gap:6px;margin-top:8px">
            <button class="btn-sec" onclick="btAll(1)">All</button>
            <button class="btn-sec" onclick="btAll(0)">None</button>
        </div>
    </div>
    <button id="bt-run" class="btn-primary" onclick="runBT()" disabled>‚ñ∂ RUN BACKTEST</button>
    <button id="bt-csv" class="btn-sec" onclick="exportBT()" style="display:none;width:100%">‚Üì Export CSV</button>
    <p style="font-size:10px;color:#3a424e;line-height:1.5">Walk-forward: signals use only past data, compared against price N candles later. Zero lookahead bias.</p>
</aside>
<main class="sim-main">
    <div id="bt-idle"><div class="idle-art">üî¨</div><h2 style="text-align:center;font-size:20px;font-weight:700;margin-bottom:8px">Walk-Forward Backtest</h2><p style="text-align:center;font-size:13px;color:var(--text-muted);max-width:500px;margin:0 auto;line-height:1.6">Select a symbol, configure parameters, click <strong style="color:#fcd535">Run Backtest</strong>.</p></div>
    <div id="bt-running" style="display:none">
        <div style="font-size:12px;font-weight:700;color:var(--text-muted);margin-bottom:10px">Simulation Progress</div>
        <div class="progress-track" style="margin-bottom:6px"><div class="progress-fill" id="bt-fill"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:10px;color:#3a424e;margin-bottom:14px;font-family:'Courier New',monospace"><span id="bt-prog-lbl">Loading‚Ä¶</span><span id="bt-prog-pct">0%</span></div>
        <div class="log-console" id="bt-log"></div>
    </div>
    <div id="bt-results" style="display:none">
        <div class="stat-grid" id="bt-stats" style="margin-bottom:18px"></div>
        <div class="ensemble-box" id="bt-ensemble" style="margin-bottom:18px"></div>
        <div class="card" style="margin-bottom:18px"><div class="label" style="margin-bottom:10px">Equity Curve ‚Äî Top 3</div><canvas class="equity" id="bt-equity"></canvas><div id="bt-eq-legend" style="display:flex;gap:14px;margin-top:8px;font-size:10px"></div></div>
        <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                <div class="label">Algorithm Performance</div>
                <input id="bt-filter" class="ctrl" type="text" placeholder="Filter‚Ä¶" style="width:120px;font-size:11px;padding:4px 8px">
            </div>
            <div style="overflow-x:auto">
                <table class="results-table" id="bt-table">
                    <thead><tr>
                        <th onclick="btSort('rank')">Rank</th><th onclick="btSort('name')">Algorithm</th>
                        <th onclick="btSort('signals')" data-tip="Candles that fired a signal">Signals</th>
                        <th onclick="btSort('correct')">Correct</th><th onclick="btSort('accuracy')">Accuracy</th><th></th>
                        <th onclick="btSort('avgReturn')">Avg Ret%</th><th onclick="btSort('sharpe')">Sharpe</th>
                        <th onclick="btSort('maxStreak')">Streak</th><th onclick="btSort('grade')">Grade</th>
                    </tr></thead>
                    <tbody id="bt-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>
</div>
</div>

<!-- ‚ïê‚ïê TAB 2: LIVE PAPER TRADING ‚ïê‚ïê -->
<div class="tab-content" id="tab-live">
<div class="sim-layout">
<aside class="config-panel">
    <div class="card">
        <div class="label">Symbol</div>
        <div class="search-wrap">
            <input id="lv-sym" class="ctrl" type="text" placeholder="BTCUSDT‚Ä¶" autocomplete="off">
            <div id="lv-sym-drop" class="search-drop"></div>
        </div>
        <div id="lv-sym-sel" style="margin-top:6px;font-size:11px;color:var(--text-muted)">No symbol selected</div>
    </div>
    <div class="card">
        <div class="label">Candle Timeframe</div>
        <select id="lv-tf" class="ctrl" onchange="updateLvDuration()">
            <option value="1m" selected>1 Minute</option><option value="3m">3 Minutes</option>
            <option value="5m">5 Minutes</option><option value="15m">15 Minutes</option>
            <option value="30m">30 Minutes</option>
        </select>
        <div style="margin-top:5px;font-size:10px;color:#3a424e">Waits one candle close per round</div>
    </div>
    <div class="card">
        <div class="label">Session Duration</div>
        <select id="lv-rounds" class="ctrl" onchange="updateLvDuration()">
            <option value="5">5 rounds</option><option value="10" selected>10 rounds</option>
            <option value="15">15 rounds</option><option value="20">20 rounds</option><option value="30">30 rounds</option>
        </select>
        <div id="lv-dur-lbl" style="margin-top:5px;font-size:10px;color:#3a424e">‚âà 10 minutes</div>
    </div>
    <div class="card">
        <div class="label">Starting Capital</div>
        <div class="amount-group">
            <input id="lv-amount" class="ctrl" type="number" value="100" min="1" step="1" oninput="updateLvPerAlgo()">
            <select id="lv-cur" class="ctrl" style="width:82px" onchange="updateLvPerAlgo()">
                <option value="INR">INR</option><option value="USD">USD</option><option value="EUR">EUR</option>
                <option value="GBP">GBP</option><option value="JPY">JPY</option><option value="SGD">SGD</option><option value="AED">AED</option>
            </select>
        </div>
        <div id="lv-usdt-eq" style="margin-top:5px;font-size:10px;color:#3a424e">‚âà 1.19 USDT</div>
    </div>
    <div class="card">
        <div class="label">Allocation Mode</div>
        <select id="lv-alloc" class="ctrl">
            <option value="equal">Equal split per algorithm</option>
            <option value="weighted">Accuracy-weighted (uses prior backtest)</option>
        </select>
    </div>
    <div class="card">
        <div class="label" style="margin-bottom:8px">Algorithms</div>
        <div class="algo-grid" id="lv-chips"></div>
        <div style="display:flex;gap:6px;margin-top:8px">
            <button class="btn-sec" onclick="lvAll(1)">All</button>
            <button class="btn-sec" onclick="lvAll(0)">None</button>
        </div>
        <div id="lv-per-algo" style="margin-top:8px;font-size:11px;color:var(--text-muted)">-- per algorithm</div>
    </div>
    <button id="lv-start" class="btn-primary" onclick="startSession()" disabled>‚ñ∂ START SESSION</button>
    <button id="lv-stop" class="btn-danger" onclick="stopSession()" style="display:none">‚¨õ STOP SESSION</button>
    <button id="lv-csv" class="btn-sec" onclick="exportLive()" style="display:none;width:100%">‚Üì Export CSV</button>
    <p style="font-size:10px;color:#3a424e;line-height:1.5">Paper trading only ‚Äî no real money. Each algo gets an equal share of capital, predicts direction, and result is verified at candle close.</p>
</aside>
<main class="sim-main">
    <!-- IDLE -->
    <div id="lv-idle">
        <div class="idle-art">üì°</div>
        <h2 style="text-align:center;font-size:20px;font-weight:700;margin-bottom:8px">Live Paper Trading</h2>
        <p style="text-align:center;font-size:13px;color:var(--text-muted);max-width:540px;margin:0 auto;line-height:1.6">
            Split capital across algorithms. Each round: predict ‚Üí wait candle close ‚Üí verify with real price ‚Üí track P&amp;L. Runs automatically for your chosen duration.
        </p>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:24px auto 0;max-width:600px">
            <div class="card" style="text-align:center"><div style="font-size:24px;margin-bottom:6px">üí∞</div><div style="font-size:11px;font-weight:700;margin-bottom:4px">Capital Split</div><div style="font-size:10px;color:var(--text-muted)">Equal (or weighted) share per active algorithm</div></div>
            <div class="card" style="text-align:center"><div style="font-size:24px;margin-bottom:6px">‚è±</div><div style="font-size:11px;font-weight:700;margin-bottom:4px">Real Verification</div><div style="font-size:10px;color:var(--text-muted)">Fetches real Binance price after candle closes</div></div>
            <div class="card" style="text-align:center"><div style="font-size:24px;margin-bottom:6px">üîÅ</div><div style="font-size:11px;font-weight:700;margin-bottom:4px">Auto-Scheduler</div><div style="font-size:10px;color:var(--text-muted)">Repeats for your chosen number of rounds</div></div>
        </div>
    </div>

    <!-- ACTIVE SESSION -->
    <div id="lv-session" style="display:none">
        <div class="portfolio-header">
            <div class="pstat"><div class="pstat-val" id="lv-total">--</div><div class="pstat-lbl">Total Capital</div></div>
            <div class="pstat"><div class="pstat-val" id="lv-pnl">--</div><div class="pstat-lbl">Net P&amp;L</div></div>
            <div class="pstat"><div class="pstat-val" id="lv-round-disp">0/0</div><div class="pstat-lbl">Round</div></div>
            <div class="pstat"><div class="pstat-val" id="lv-wr">--%</div><div class="pstat-lbl">Win Rate</div></div>
            <div class="pstat" style="display:flex;align-items:center;justify-content:center;flex-direction:column">
                <div class="countdown-ring" style="margin-bottom:4px">
                    <svg width="60" height="60" viewBox="0 0 60 60">
                        <circle cx="30" cy="30" r="26" fill="none" stroke="#2b3139" stroke-width="4"/>
                        <circle id="lv-cd-ring" cx="30" cy="30" r="26" fill="none" stroke="#fcd535" stroke-width="4" stroke-dasharray="163.4" stroke-dashoffset="0" stroke-linecap="round"/>
                    </svg>
                    <span class="countdown-val" id="lv-cd-num">--</span>
                </div>
                <div class="pstat-lbl" id="lv-cd-lbl">Next close</div>
            </div>
        </div>
        <div id="lv-phase" style="background:#fcd53515;border:1px solid #fcd53533;border-radius:6px;padding:10px 16px;margin-bottom:14px;font-size:12px;display:flex;align-items:center;gap:10px">
            <span class="pulse" id="lv-phase-icon" style="font-size:14px">üì°</span>
            <span id="lv-phase-txt">Initialising‚Ä¶</span>
        </div>
        <div class="algo-cards" id="lv-cards"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
            <div class="card"><div class="label" style="margin-bottom:8px">Round History</div><div id="lv-history" style="max-height:160px;overflow-y:auto"></div></div>
            <div class="card"><div class="label" style="margin-bottom:8px">Portfolio Equity</div><canvas id="lv-eq-mini" style="width:100%;height:130px;display:block"></canvas></div>
        </div>
        <div class="card"><div class="label" style="margin-bottom:6px">Session Log</div><div class="session-log" id="lv-log"></div></div>
    </div>

    <!-- POST SESSION -->
    <div id="lv-done" style="display:none">
        <div style="text-align:center;margin-bottom:20px">
            <div style="font-size:40px;margin-bottom:8px" id="lv-done-emoji">üèÜ</div>
            <h2 style="font-size:22px;font-weight:800;margin-bottom:4px" id="lv-done-title">Session Complete</h2>
            <p style="font-size:13px;color:var(--text-muted)" id="lv-done-sub"></p>
        </div>
        <div class="stat-grid" id="lv-done-stats" style="margin-bottom:18px"></div>
        <div class="card" style="margin-bottom:18px"><div class="label" style="margin-bottom:10px">Algorithm Standings</div><div id="lv-standings"></div></div>
        <div class="card" style="margin-bottom:14px"><div class="label" style="margin-bottom:8px">Equity Curve</div><canvas id="lv-eq-final" style="width:100%;height:160px;display:block"></canvas></div>
        <div style="display:flex;gap:10px">
            <button class="btn-primary" onclick="resetSession()" style="flex:1">‚Ü∫ New Session</button>
            <button class="btn-sec" onclick="exportLive()" style="flex:1">‚Üì Export CSV</button>
        </div>
    </div>
</main>
</div>
</div>

<script>
const API = 'https://api.binance.com/api/v3';

// FX
const FX = {INR:83.5,USD:1,EUR:0.92,GBP:0.79,JPY:149.5,SGD:1.34,AED:3.67};
(async()=>{try{const r=await fetch('https://open.er-api.com/v6/latest/USD');const d=await r.json();if(d.rates)Object.keys(FX).forEach(k=>{if(d.rates[k])FX[k]=d.rates[k];});}catch(_){}})();
const toUSDT=(v,c)=>v/(FX[c]||1);

// Symbols
let symbols=[];
(async()=>{try{const r=await fetch(`${API}/exchangeInfo`);const d=await r.json();symbols=d.symbols.filter(s=>s.status==='TRADING').map(s=>({symbol:s.symbol,base:s.baseAsset,quote:s.quoteAsset}));}catch(_){}})();

const ALGOS=[
    {key:'sma',name:'SMA (20)',group:'Trend'},{key:'ema',name:'EMA (20)',group:'Trend'},
    {key:'ichimoku',name:'Ichimoku',group:'Trend'},{key:'adx',name:'ADX/DI (14)',group:'Trend'},
    {key:'rsi',name:'RSI (14)',group:'Momentum'},{key:'macd',name:'MACD',group:'Momentum'},
    {key:'stoch',name:'Stochastic',group:'Momentum'},{key:'cci',name:'CCI (20)',group:'Momentum'},
    {key:'willr',name:'Williams %R',group:'Momentum'},{key:'squeeze',name:'Squeeze',group:'Momentum'},
    {key:'vwap',name:'VWAP',group:'Volume'},{key:'obv',name:'OBV',group:'Volume'},
    {key:'cmf',name:'CMF (21)',group:'Volume'},{key:'mfi',name:'MFI (14)',group:'Volume'},
    {key:'bb',name:'Bollinger Bands',group:'Volatility'},{key:'keltner',name:'Keltner',group:'Volatility'},
    {key:'zscore',name:'Z-Score (20)',group:'Statistical'},{key:'lrchannel',name:'LR Channel',group:'Statistical'},
];
const btActive=new Set(ALGOS.map(a=>a.key));
const lvActive=new Set(ALGOS.map(a=>a.key));

// Math
const emaFull=(arr,n)=>{const k=2/(n+1),out=[arr[0]];for(let i=1;i<arr.length;i++)out.push(arr[i]*k+out[i-1]*(1-k));return out;};
const smaLast=(arr,n)=>{const sl=arr.slice(-n);return sl.reduce((a,b)=>a+b,0)/sl.length;};
const emaLast=(arr,n)=>{const k=2/(n+1);let e=arr[0];for(let i=1;i<arr.length;i++)e=arr[i]*k+e*(1-k);return e;};
const std=(arr)=>{const m=arr.reduce((a,b)=>a+b,0)/arr.length;return Math.sqrt(arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length);};
const trv=(h,l,pc)=>Math.max(h-l,Math.abs(h-pc),Math.abs(l-pc));
function calcRSI(cls,n=14){let g=0,l=0;for(let i=1;i<=n;i++){const d=cls[i]-cls[i-1];g+=d>0?d:0;l+=d<0?-d:0;}let ag=g/n,al=l/n;for(let i=n+1;i<cls.length;i++){const d=cls[i]-cls[i-1];ag=(ag*(n-1)+(d>0?d:0))/n;al=(al*(n-1)+(d<0?-d:0))/n;}return al===0?100:100-100/(1+ag/al);}

const SIG={
    sma({closes}){if(closes.length<22)return 0;const s=smaLast(closes,20),c=closes[closes.length-1];return c>s*1.001?1:c<s*0.999?-1:0;},
    ema({closes}){if(closes.length<22)return 0;const e=emaLast(closes.slice(-30),20),c=closes[closes.length-1];return c>e*1.001?1:c<e*0.999?-1:0;},
    rsi({closes}){if(closes.length<20)return 0;const r=calcRSI(closes.slice(-20));return r<30?1:r>70?-1:0;},
    macd({closes}){if(closes.length<40)return 0;const sl=closes.slice(-40),e12=emaFull(sl,12),e26=emaFull(sl,26);const ml=e12.map((v,i)=>v-e26[i]);const sg=emaFull(ml.slice(-15),9);return ml[ml.length-1]>sg[sg.length-1]?1:-1;},
    stoch({data}){if(data.length<17)return 0;const sl=data.slice(-14);const hi=Math.max(...sl.map(d=>d.high)),lo=Math.min(...sl.map(d=>d.low));if(hi===lo)return 0;const k=((data[data.length-1].close-lo)/(hi-lo))*100;return k<20?1:k>80?-1:0;},
    bb({closes}){if(closes.length<22)return 0;const sl=closes.slice(-20),m=sl.reduce((a,b)=>a+b,0)/20,sd=std(sl),c=closes[closes.length-1];return c<m-2*sd?1:c>m+2*sd?-1:0;},
    vwap({data}){if(data.length<5)return 0;let cpv=0,cv=0;for(const d of data){const tp=(d.high+d.low+d.close)/3;cpv+=tp*d.volume;cv+=d.volume;}const vw=cpv/cv,c=data[data.length-1].close;return c<vw*0.999?1:c>vw*1.001?-1:0;},
    obv({data}){if(data.length<10)return 0;let o=0;const arr=[0];for(let i=1;i<data.length;i++){o+=data[i].close>data[i-1].close?data[i].volume:data[i].close<data[i-1].close?-data[i].volume:0;arr.push(o);}const r=arr.slice(-5);return r[4]-r[0]>0?1:-1;},
    cmf({data}){if(data.length<23)return 0;const sl=data.slice(-21);let n=0,de=0;for(const d of sl){const hl=d.high-d.low;if(!hl)continue;n+=((d.close-d.low)-(d.high-d.close))/hl*d.volume;de+=d.volume;}const v=de?n/de:0;return v>0.05?1:v<-0.05?-1:0;},
    mfi({data}){if(data.length<16)return 0;const sl=data.slice(-15);let pos=0,neg=0;for(let i=1;i<sl.length;i++){const tp=(sl[i].high+sl[i].low+sl[i].close)/3,ptp=(sl[i-1].high+sl[i-1].low+sl[i-1].close)/3,mf=tp*sl[i].volume;if(tp>ptp)pos+=mf;else if(tp<ptp)neg+=mf;}const r=neg===0?100:100-100/(1+pos/neg);return r<20?1:r>80?-1:0;},
    adx({data}){if(data.length<30)return 0;let smTR=0.001,smP=0,smM=0;for(let i=1;i<data.length;i++){const p=14,tr=trv(data[i].high,data[i].low,data[i-1].close);const dmp=Math.max(0,data[i].high-data[i-1].high)>Math.max(0,data[i-1].low-data[i].low)?Math.max(0,data[i].high-data[i-1].high):0;const dmm=Math.max(0,data[i-1].low-data[i].low)>Math.max(0,data[i].high-data[i-1].high)?Math.max(0,data[i-1].low-data[i].low):0;smTR=smTR-smTR/p+tr;smP=smP-smP/p+dmp;smM=smM-smM/p+dmm;}const pdi=100*smP/smTR,mdi=100*smM/smTR;return Math.abs(pdi-mdi)<15?0:pdi>mdi?1:-1;},
    cci({data}){if(data.length<22)return 0;const sl=data.slice(-20),tps=sl.map(d=>(d.high+d.low+d.close)/3);const m=tps.reduce((a,b)=>a+b,0)/20,mad=tps.reduce((a,b)=>a+Math.abs(b-m),0)/20;const c=mad?((tps[tps.length-1]-m)/(0.015*mad)):0;return c<-100?1:c>100?-1:0;},
    willr({data}){if(data.length<16)return 0;const sl=data.slice(-14);const hi=Math.max(...sl.map(d=>d.high)),lo=Math.min(...sl.map(d=>d.low));if(hi===lo)return 0;const r=((hi-data[data.length-1].close)/(hi-lo))*-100;return r<-80?1:r>-20?-1:0;},
    ichimoku({data}){if(data.length<55)return 0;const mid=n=>{const s=data.slice(-n);return(Math.max(...s.map(d=>d.high))+Math.min(...s.map(d=>d.low)))/2;};const sA=(mid(9)+mid(26))/2,sB=(()=>{const s=data.slice(-52);return(Math.max(...s.map(d=>d.high))+Math.min(...s.map(d=>d.low)))/2;})(),c=data[data.length-1].close;return c>Math.max(sA,sB)?1:c<Math.min(sA,sB)?-1:0;},
    keltner({data}){if(data.length<22)return 0;const cls=data.map(d=>d.close),em=emaLast(cls.slice(-20),20);let atr=0;const sl=data.slice(-11);for(let i=1;i<sl.length;i++)atr=(atr*9+trv(sl[i].high,sl[i].low,sl[i-1].close))/10;const c=cls[cls.length-1];return c<em-2*atr?1:c>em+2*atr?-1:0;},
    zscore({closes}){if(closes.length<22)return 0;const sl=closes.slice(-20),m=sl.reduce((a,b)=>a+b,0)/20,sd=std(sl)||1;const z=(closes[closes.length-1]-m)/sd;return z<-2?1:z>2?-1:0;},
    lrchannel({closes}){if(closes.length<50)return 0;const n=Math.min(100,closes.length),sl=closes.slice(-n);let sx=0,sy=0,sxy=0,sx2=0;for(let i=0;i<n;i++){sx+=i;sy+=sl[i];sxy+=i*sl[i];sx2+=i*i;}const D=n*sx2-sx*sx,slope=D?((n*sxy-sx*sy)/D):0,ic=(sy-slope*sx)/n;const fit=slope*(n-1)+ic,rsd=Math.sqrt(sl.reduce((a,b,i)=>a+(b-(ic+slope*i))**2,0)/n);const c=closes[closes.length-1];return c<fit-rsd?1:c>fit+rsd?-1:0;},
    squeeze({data}){if(data.length<32)return 0;const cls=data.map(d=>d.close),sl=cls.slice(-20);const m=sl.reduce((a,b)=>a+b,0)/20;const hh=Math.max(...data.slice(-20).map(d=>d.high)),ll=Math.min(...data.slice(-20).map(d=>d.low));const val=cls[cls.length-1]-((hh+ll)/2+m)/2;return val>0?1:val<0?-1:0;},
};

// Shared search binder
function bindSearch(inId,dropId,onSel){
    const inp=document.getElementById(inId),drop=document.getElementById(dropId);
    inp.addEventListener('input',()=>{
        const q=inp.value.toUpperCase().trim();
        if(!q){drop.classList.remove('show');return;}
        const m=symbols.filter(s=>s.symbol.includes(q)||s.base.includes(q)).slice(0,25);
        drop.innerHTML=m.map(s=>`<div class="sdrop-item" onclick="${onSel}('${s.symbol}')"><span style="font-weight:700">${s.symbol}</span><span style="color:var(--text-muted);font-size:10px">${s.base}/${s.quote}</span></div>`).join('')||'<div class="sdrop-item" style="color:#3a424e">No results</div>';
        drop.classList.add('show');
    });
    document.addEventListener('click',e=>{if(!e.target.closest(`#${inId}`)&&!e.target.closest(`#${dropId}`))drop.classList.remove('show');});
}

function switchTab(tab){
    ['backtest','live'].forEach(t=>{document.getElementById(`mtab-${t}`).classList.remove('active');document.getElementById(`tab-${t}`).classList.remove('active');});
    document.getElementById(`mtab-${tab}`).classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê BACKTEST ‚ïê‚ïê‚ïê‚ïê
let btSym=null,btResults=null,btSortKey='accuracy',btSortDir=-1;
bindSearch('bt-sym','bt-sym-drop','btSel');
function btSel(sym){btSym=sym;document.getElementById('bt-sym').value=sym;document.getElementById('bt-sym-drop').classList.remove('show');document.getElementById('bt-sym-sel').textContent='‚úì '+sym;document.getElementById('bt-sym-sel').style.color='#0ecb81';document.getElementById('bt-run').disabled=false;document.getElementById('hdr-symbol').textContent=sym;}
(()=>{const chips=document.getElementById('bt-chips');chips.innerHTML=ALGOS.map(a=>`<div class="algo-chip active" id="bc-${a.key}" onclick="btChip('${a.key}',this)">${a.name}</div>`).join('');})();
function btChip(k,el){btActive.has(k)?btActive.delete(k):btActive.add(k);el.classList.toggle('active');}
function btAll(on){ALGOS.forEach(a=>{on?btActive.add(a.key):btActive.delete(a.key);const el=document.getElementById(`bc-${a.key}`);on?el.classList.add('active'):el.classList.remove('active');});}
function updateBtLbl(){const tf=document.getElementById('bt-tf').value,h=parseInt(document.getElementById('bt-horizon').value)||1;const mins={1m:1,5m:5,15m:15,30m:30,'1h':60,'4h':240,'1d':1440};const t=(mins[tf]||60)*h;document.getElementById('bt-horizon-lbl').textContent=`‚âà ${t<60?t+'m':t<1440?(t/60).toFixed(1)+'h':(t/1440).toFixed(1)+'d'} lookahead`;}
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
function btLog(msg,cls=''){const el=document.getElementById('bt-log');const d=document.createElement('div');if(cls)d.className='log-'+cls;d.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;el.appendChild(d);el.scrollTop=el.scrollHeight;}
function btProg(pct,lbl){document.getElementById('bt-fill').style.width=pct+'%';document.getElementById('bt-prog-lbl').textContent=lbl;document.getElementById('bt-prog-pct').textContent=pct+'%';}

async function runBT(){
    if(!btSym)return;
    const tf=document.getElementById('bt-tf').value,limit=+document.getElementById('bt-limit').value;
    const horizon=Math.max(1,+document.getElementById('bt-horizon').value||5);
    const warmup=Math.max(50,+document.getElementById('bt-warmup').value||100);
    const chosen=ALGOS.filter(a=>btActive.has(a.key));
    if(!chosen.length){alert('Select at least one algorithm.');return;}
    document.getElementById('bt-idle').style.display='none';document.getElementById('bt-results').style.display='none';
    document.getElementById('bt-running').style.display='block';document.getElementById('bt-run').disabled=true;
    document.getElementById('bt-log').innerHTML='';btProg(0,'Fetching klines‚Ä¶');btLog(`Fetching ${limit}√ó${tf} for ${btSym}‚Ä¶`);
    let raw;try{raw=await fetch(`${API}/klines?symbol=${btSym}&interval=${tf}&limit=${limit}`).then(r=>r.json());}catch(e){btLog('Network error: '+e.message,'err');document.getElementById('bt-run').disabled=false;return;}
    if(!Array.isArray(raw)||raw.length<warmup+horizon+10){btLog('Insufficient data','err');document.getElementById('bt-run').disabled=false;return;}
    const data=raw.map(k=>({time:+k[0]/1000|0,open:+k[1],high:+k[2],low:+k[3],close:+k[4],volume:+k[5]}));
    btLog(`Loaded ${data.length} candles`,'ok');
    const acc={};chosen.forEach(a=>{acc[a.key]={name:a.name,group:a.group,key:a.key,signals:0,correct:0,returns:[],maxStreak:0,curStreak:0};});
    const te=data.length-horizon-1;
    for(let i=warmup;i<=te;i++){
        const sub=data.slice(0,i+1),cls=sub.map(d=>d.close);
        const actual=data[i+horizon].close>data[i].close?1:-1;
        const ret=(data[i+horizon].close-data[i].close)/data[i].close*100;
        for(const algo of chosen){
            let sig;try{sig=SIG[algo.key]({data:sub,closes:cls});}catch(_){sig=0;}
            if(!sig)continue;const r=acc[algo.key];r.signals++;
            const ok=sig===actual;
            if(ok){r.correct++;r.curStreak++;r.maxStreak=Math.max(r.maxStreak,r.curStreak);r.returns.push(Math.abs(ret));}
            else{r.curStreak=0;r.returns.push(-Math.abs(ret));}
        }
        if(i%50===0||i===te){btProg(Math.round(((i-warmup)/(te-warmup))*100),`Tested ${i-warmup}/${te-warmup}‚Ä¶`);await sleep(0);}
    }
    btLog('Processing‚Ä¶','ok');
    btResults=chosen.map(a=>{
        const r=acc[a.key],acc2=r.signals?r.correct/r.signals*100:0;
        const rets=r.returns,avg=rets.length?rets.reduce((a,b)=>a+b,0)/rets.length:0;
        const sd=rets.length>1?std(rets):1;const sh=sd>0?(avg/sd)*Math.sqrt(252):0;
        const g=acc2>=70?'S':acc2>=60?'A':acc2>=55?'B':acc2>=50?'C':'D';
        return{...r,accuracy:acc2,avgReturn:avg,sharpe:sh,grade:g};
    }).sort((a,b)=>b.accuracy-a.accuracy).map((r,i)=>({...r,rank:i+1}));
    btLog(`Best: ${btResults[0].name} @ ${btResults[0].accuracy.toFixed(1)}%`,'ok');
    renderBT(data,horizon,warmup);
    document.getElementById('bt-running').style.display='none';document.getElementById('bt-results').style.display='block';
    document.getElementById('bt-run').disabled=false;document.getElementById('bt-csv').style.display='inline-block';
    document.getElementById('bt-filter').oninput=()=>{const q=document.getElementById('bt-filter').value.toLowerCase();renderBTTable(btResults.filter(r=>r.name.toLowerCase().includes(q)));};
}

function renderBT(data,horizon,warmup){
    const tot=btResults.reduce((a,r)=>a+r.signals,0),cor=btResults.reduce((a,r)=>a+r.correct,0),ov=tot?(cor/tot*100):0;
    document.getElementById('bt-stats').innerHTML=[{val:btResults.length,lbl:'Algorithms',c:'#fcd535'},{val:tot.toLocaleString(),lbl:'Total Signals',c:'#29b6f6'},{val:ov.toFixed(1)+'%',lbl:'Ensemble Acc',c:ov>=55?'#0ecb81':ov>=50?'#fcd535':'#f6465d'},{val:btResults[0].name.split(' ')[0],lbl:`Best(${btResults[0].accuracy.toFixed(1)}%)`,c:'#0ecb81'}].map(s=>`<div class="stat-box"><div class="stat-val" style="color:${s.c}">${s.val}</div><div class="stat-lbl">${s.lbl}</div></div>`).join('');
    const lastData=data.slice(-102),lc=lastData.map(d=>d.close);
    let b=0,s=0,n=0;btResults.forEach(r=>{try{const sig=SIG[r.key]({data:lastData,closes:lc});if(sig===1)b++;else if(sig===-1)s++;else n++;}catch(_){}});
    const tot2=b+s+n,dom=b>s?'BUY':s>b?'SELL':'NEUTRAL',dc=dom==='BUY'?'#0ecb81':dom==='SELL'?'#f6465d':'#fcd535';
    document.getElementById('bt-ensemble').innerHTML=`<div><div class="label" style="margin-bottom:4px">Ensemble Signal (current)</div><div class="esig" style="color:${dc}">${dom}</div></div><div style="margin-left:auto;text-align:right"><div class="label">Confidence</div><div style="font-size:22px;font-weight:800">${tot2?Math.round(Math.max(b,s,n)/tot2*100):0}%</div><div style="font-size:10px;color:#3a424e;margin-top:4px">üü¢√ó${b} üî¥√ó${s} ‚ö™√ó${n}</div></div>`;
    const top3=btResults.slice(0,3),cols=['#fcd535','#0ecb81','#29b6f6'];
    const cv=document.getElementById('bt-equity');const ctx=cv.getContext('2d');const W=cv.offsetWidth||660,H=160;cv.width=W;cv.height=H;
    const curves=top3.map(algo=>{let eq=[1];for(let i=warmup;i<=data.length-horizon-2;i++){const sub=data.slice(0,i+1),cls=sub.map(d=>d.close);let sig;try{sig=SIG[algo.key]({data:sub,closes:cls});}catch(_){sig=0;}if(sig){const ret=(data[i+horizon].close-data[i].close)/data[i].close;eq.push(eq[eq.length-1]*(1+sig*ret));}else eq.push(eq[eq.length-1]);}return eq;});
    const all=curves.flat(),minV=Math.min(...all),maxV=Math.max(...all),rng=(maxV-minV)||0.01;
    ctx.fillStyle='#11151c';ctx.fillRect(0,0,W,H);
    const zy=H-8-((1-minV)/rng)*(H-20);ctx.strokeStyle='#2b3139';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(0,zy);ctx.lineTo(W,zy);ctx.stroke();ctx.setLineDash([]);
    curves.forEach((c,ci)=>{ctx.strokeStyle=cols[ci];ctx.lineWidth=ci===0?2:1.5;ctx.beginPath();c.forEach((v,i)=>{const x=(i/c.length)*W,y=H-8-((v-minV)/rng)*(H-20);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.stroke();});
    document.getElementById('bt-eq-legend').innerHTML=top3.map((a,i)=>`<span style="color:${cols[i]}">‚óè ${a.name}</span>`).join('');
    renderBTTable(btResults);
}

function renderBTTable(rows){
    document.getElementById('bt-body').innerHTML=rows.map(r=>{
        const bw=Math.min(100,r.accuracy),bc=r.accuracy>=65?'#0ecb81':r.accuracy>=55?'#fcd535':r.accuracy>=50?'#ff7043':'#f6465d';
        const rc=r.rank===1?'#fcd535':r.rank===2?'#c0c0c0':r.rank===3?'#cd7f32':'#2b3139';
        return`<tr><td><span class="rank-badge" style="background:${rc}22;color:${rc}">#${r.rank}</span></td><td><div style="font-weight:700">${r.name}</div><div style="font-size:10px;color:var(--text-muted)">${r.group}</div></td><td style="font-family:'Courier New',monospace;color:var(--text-muted)">${r.signals.toLocaleString()}</td><td style="color:#0ecb81;font-family:'Courier New',monospace">${r.correct.toLocaleString()}</td><td style="font-weight:700;color:${bc};font-family:'Courier New',monospace">${r.accuracy.toFixed(1)}%</td><td><div class="acc-bar-wrap"><div class="acc-bar" style="width:${bw}%;background:${bc}"></div></div></td><td style="color:${r.avgReturn>=0?'#0ecb81':'#f6465d'};font-family:'Courier New',monospace">${r.avgReturn>=0?'+':''}${r.avgReturn.toFixed(3)}%</td><td style="color:${r.sharpe>=1?'#0ecb81':r.sharpe>=0?'#fcd535':'#f6465d'};font-family:'Courier New',monospace">${r.sharpe.toFixed(2)}</td><td style="color:var(--text-muted);font-family:'Courier New',monospace">${r.maxStreak}</td><td><span class="grade grade-${r.grade}">${r.grade}</span></td></tr>`;
    }).join('');
}

function btSort(k){if(btSortKey===k)btSortDir*=-1;else{btSortKey=k;btSortDir=-1;}renderBTTable([...btResults].sort((a,b)=>{const va=a[k],vb=b[k];return typeof va==='string'?va.localeCompare(vb)*btSortDir:(va-vb)*btSortDir;}));}
function exportBT(){if(!btResults)return;const rows=['Rank,Algorithm,Group,Signals,Correct,Accuracy%,AvgReturn%,Sharpe,BestStreak,Grade'];btResults.forEach(r=>rows.push(`${r.rank},"${r.name}","${r.group}",${r.signals},${r.correct},${r.accuracy.toFixed(2)},${r.avgReturn.toFixed(4)},${r.sharpe.toFixed(3)},${r.maxStreak},${r.grade}`));dlCSV(rows.join('\n'),`bt_${btSym}_${Date.now()}.csv`);}

// ‚ïê‚ïê‚ïê‚ïê LIVE PAPER TRADING ‚ïê‚ïê‚ïê‚ïê
let lvSym=null,lvSess=null,lvEqHist=[],lvRoundLog=[],cdInt=null;
bindSearch('lv-sym','lv-sym-drop','lvSel');
function lvSel(sym){lvSym=sym;document.getElementById('lv-sym').value=sym;document.getElementById('lv-sym-drop').classList.remove('show');document.getElementById('lv-sym-sel').textContent='‚úì '+sym;document.getElementById('lv-sym-sel').style.color='#0ecb81';document.getElementById('lv-start').disabled=false;document.getElementById('hdr-symbol').textContent=sym;updateLvPerAlgo();}
(()=>{const chips=document.getElementById('lv-chips');chips.innerHTML=ALGOS.map(a=>`<div class="algo-chip active" id="lc-${a.key}" onclick="lvChip('${a.key}',this)">${a.name}</div>`).join('');})();
function lvChip(k,el){lvActive.has(k)?lvActive.delete(k):lvActive.add(k);el.classList.toggle('active');updateLvPerAlgo();}
function lvAll(on){ALGOS.forEach(a=>{on?lvActive.add(a.key):lvActive.delete(a.key);const el=document.getElementById(`lc-${a.key}`);on?el.classList.add('active'):el.classList.remove('active');});updateLvPerAlgo();}
function updateLvDuration(){const tf=document.getElementById('lv-tf').value,r=+document.getElementById('lv-rounds').value||10;const mins={1m:1,3m:3,5m:5,15m:15,30m:30};const t=(mins[tf]||1)*r;document.getElementById('lv-dur-lbl').textContent=`‚âà ${t<60?t+' min':(t/60).toFixed(1)+' h'} total`;}
function updateLvPerAlgo(){const n=lvActive.size||1,amt=+document.getElementById('lv-amount').value||100,cur=document.getElementById('lv-cur').value,per=(amt/n).toFixed(2);document.getElementById('lv-per-algo').textContent=`${per} ${cur} / algo`;document.getElementById('lv-usdt-eq').textContent=`‚âà ${toUSDT(amt,cur).toFixed(4)} USDT total`;}
function lvLog(msg,cls=''){const el=document.getElementById('lv-log');const d=document.createElement('div');if(cls)d.className='log-'+cls;d.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;el.appendChild(d);el.scrollTop=el.scrollHeight;}
function setPhase(icon,txt,col='#fcd535'){document.getElementById('lv-phase-icon').textContent=icon;document.getElementById('lv-phase-txt').textContent=txt;document.getElementById('lv-phase').style.borderColor=col+'55';document.getElementById('lv-phase').style.background=col+'12';}
function startCD(secs){clearInterval(cdInt);const ring=document.getElementById('lv-cd-ring'),num=document.getElementById('lv-cd-num'),circ=163.4;let rem=secs;function tick(){ring.style.strokeDashoffset=(circ*(1-rem/secs)).toFixed(2);const m=Math.floor(rem/60).toString().padStart(2,'0'),s=(rem%60).toString().padStart(2,'0');num.textContent=rem>=60?`${m}:${s}`:`${rem}s`;if(rem>0)rem--;}tick();cdInt=setInterval(tick,1000);}
function stopCD(){clearInterval(cdInt);document.getElementById('lv-cd-ring').style.strokeDashoffset='0';document.getElementById('lv-cd-num').textContent='--';}

async function fetchKlines(sym,tf,limit=200){const r=await fetch(`${API}/klines?symbol=${sym}&interval=${tf}&limit=${limit}`);const d=await r.json();return d.map(k=>({time:+k[0]/1000|0,open:+k[1],high:+k[2],low:+k[3],close:+k[4],volume:+k[5]}));}

async function startSession(){
    if(!lvSym)return;
    const chosen=ALGOS.filter(a=>lvActive.has(a.key));
    if(!chosen.length){alert('Select at least one algorithm.');return;}
    const tf=document.getElementById('lv-tf').value;
    const totalRounds=+document.getElementById('lv-rounds').value||10;
    const amount=+document.getElementById('lv-amount').value||100;
    const currency=document.getElementById('lv-cur').value;
    const allocMode=document.getElementById('lv-alloc').value;
    const perAlgo=amount/chosen.length;
    lvSess={sym:lvSym,tf,totalRounds,amount,currency,perAlgo,round:0,running:true,algos:{}};
    chosen.forEach(a=>{
        let bal=perAlgo;
        if(allocMode==='weighted'&&btResults){const f=btResults.find(r=>r.key===a.key);if(f)bal=amount*(f.accuracy/100)/chosen.reduce((s,b2)=>{const g=btResults.find(r=>r.key===b2.key);return s+(g?g.accuracy/100:0.5);},0);}
        lvSess.algos[a.key]={name:a.name,group:a.group,key:a.key,balance:bal,trades:0,wins:0,losses:0,currentSignal:0,entryPrice:0,pendingVerify:false,history:[]};
    });
    lvEqHist=[{round:0,total:amount}];lvRoundLog=[];
    document.getElementById('lv-idle').style.display='none';document.getElementById('lv-done').style.display='none';
    document.getElementById('lv-session').style.display='block';document.getElementById('lv-start').style.display='none';
    document.getElementById('lv-stop').style.display='block';document.getElementById('lv-log').innerHTML='';
    document.getElementById('lv-history').innerHTML='';
    renderCards();updatePortHdr();
    lvLog(`Session started: ${lvSym} ${tf} | ${chosen.length} algos | ${amount} ${currency}`, 'ok');
    await runRound();
}

async function runRound(){
    if(!lvSess||!lvSess.running)return;
    const s=lvSess;s.round++;
    document.getElementById('lv-round-disp').textContent=`${s.round}/${s.totalRounds}`;
    document.getElementById('hdr-status').textContent=`ROUND ${s.round}`;
    setPhase('üì°',`Round ${s.round}/${s.totalRounds} ‚Äî Fetching market data‚Ä¶`,'#fcd535');
    lvLog(`‚îÄ‚îÄ‚îÄ Round ${s.round} ‚îÄ‚îÄ‚îÄ`,'info');
    let data;try{data=await fetchKlines(s.sym,s.tf,200);}catch(e){lvLog('Fetch error: '+e.message,'err');s.running=false;endSession();return;}
    const closes=data.map(d=>d.close),entryPrice=closes[closes.length-1];
    lvLog(`Entry price: ${entryPrice.toFixed(4)}`);
    document.getElementById('hdr-price').textContent=entryPrice.toFixed(4);
    setPhase('üßÆ',`Round ${s.round} ‚Äî Generating signals‚Ä¶`,'#29b6f6');
    Object.values(s.algos).forEach(algo=>{
        let sig=0;try{sig=SIG[algo.key]({data,closes});}catch(_){}
        algo.currentSignal=sig;algo.entryPrice=entryPrice;algo.pendingVerify=sig!==0;
        if(sig!==0)lvLog(`  ${algo.name}: ${sig===1?'‚ñ≤ BUY':'‚ñº SELL'} @ ${entryPrice.toFixed(4)}`);
    });
    renderCards('predicting');
    const tfSecs={1m:60,3m:180,5m:300,15m:900,30m:1800};
    const waitSecs=tfSecs[s.tf]||60;
    setPhase('‚è±',`Round ${s.round} ‚Äî Waiting ${waitSecs}s for candle close‚Ä¶`,'#fcd535');
    lvLog(`Waiting ${waitSecs}s‚Ä¶`);startCD(waitSecs);
    await sleep(waitSecs*1000);
    if(!lvSess||!lvSess.running)return;
    stopCD();setPhase('‚úÖ',`Round ${s.round} ‚Äî Verifying results‚Ä¶`,'#0ecb81');
    let exitData;try{exitData=await fetchKlines(s.sym,s.tf,5);}catch(_){exitData=null;}
    const exitPrice=exitData?exitData[exitData.length-1].close:entryPrice;
    const actualRet=(exitPrice-entryPrice)/entryPrice;
    const actualDir=exitPrice>entryPrice?1:exitPrice<entryPrice?-1:0;
    lvLog(`Exit price: ${exitPrice.toFixed(4)} | Move: ${(actualRet*100).toFixed(3)}%`);
    let rW=0,rL=0,rPnl=0;
    Object.values(s.algos).forEach(algo=>{
        if(!algo.pendingVerify)return;
        const sig=algo.currentSignal,pnl=sig*actualRet*algo.balance,won=sig===actualDir;
        algo.balance+=pnl;algo.trades++;won?algo.wins++:algo.losses++;
        algo.history.push({round:s.round,sig,entryPrice,exitPrice,pnl,won});
        rPnl+=pnl;if(won)rW++;else rL++;
        lvLog(`  ${algo.name}: ${won?'‚úÖ WIN':'‚ùå LOSS'} | ${pnl>=0?'+':''}${pnl.toFixed(4)} ${s.currency}`);
    });
    const realTotal=Object.values(s.algos).reduce((a,b)=>a+b.balance,0);
    lvEqHist.push({round:s.round,total:realTotal});
    lvRoundLog.push({round:s.round,entryPrice,exitPrice,wins:rW,losses:rL,pnl:rPnl});
    const rc=rPnl>=0?'#0ecb81':'#f6465d';
    const rh=document.getElementById('lv-history');
    const row=document.createElement('div');row.className='round-row';
    row.innerHTML=`<span style="font-size:10px;color:var(--text-muted);width:24px">R${s.round}</span><span style="font-size:11px;font-family:'Courier New',monospace">${entryPrice.toFixed(2)}‚Üí${exitPrice.toFixed(2)}</span><span style="margin-left:auto;font-size:11px;color:${rc};font-weight:700">${rPnl>=0?'+':''}${rPnl.toFixed(3)} ${s.currency}</span><span style="margin-left:8px;font-size:10px;color:var(--text-muted)">W${rW}/L${rL}</span>`;
    rh.prepend(row);
    renderCards('verified');updatePortHdr();drawMiniEq();
    lvLog(`Round ${s.round} done. Total: ${realTotal.toFixed(2)} ${s.currency}`,'ok');
    if(s.round<s.totalRounds&&s.running){setPhase('üîÑ',`Round ${s.round} complete. Next starts in 2s‚Ä¶`,'#0ecb81');await sleep(2000);if(s.running)await runRound();}
    else endSession();
}

function stopSession(){if(lvSess)lvSess.running=false;stopCD();lvLog('Session stopped by user.','warn');endSession();}
function endSession(){
    stopCD();if(!lvSess)return;
    const s=lvSess;document.getElementById('hdr-status').textContent='DONE';
    document.getElementById('lv-stop').style.display='none';document.getElementById('lv-start').style.display='block';
    document.getElementById('lv-start').disabled=false;document.getElementById('lv-session').style.display='none';
    document.getElementById('lv-done').style.display='block';document.getElementById('lv-csv').style.display='block';
    const finalTotal=Object.values(s.algos).reduce((a,b)=>a+b.balance,0),pnl=finalTotal-s.amount,pnlP=pnl/s.amount*100;
    const won=pnl>=0;
    document.getElementById('lv-done-emoji').textContent=pnlP>5?'üèÜ':pnlP>0?'‚úÖ':pnlP>-5?'‚ö†Ô∏è':'üìâ';
    document.getElementById('lv-done-title').textContent=won?'Profitable Session!':'Loss Session';
    document.getElementById('lv-done-sub').textContent=`${s.round} rounds on ${s.sym} (${s.tf}) | Started: ${s.amount} ${s.currency} ‚Üí Final: ${finalTotal.toFixed(2)} ${s.currency}`;
    const totT=Object.values(s.algos).reduce((a,b)=>a+b.trades,0),totW=Object.values(s.algos).reduce((a,b)=>a+b.wins,0);
    document.getElementById('lv-done-stats').innerHTML=[{val:`${finalTotal.toFixed(2)} ${s.currency}`,lbl:'Final Capital',c:won?'#0ecb81':'#f6465d'},{val:`${pnl>=0?'+':''}${pnl.toFixed(2)} ${s.currency}`,lbl:'Net P&L',c:won?'#0ecb81':'#f6465d'},{val:`${pnlP>=0?'+':''}${pnlP.toFixed(2)}%`,lbl:'Return',c:won?'#0ecb81':'#f6465d'},{val:totT>0?((totW/totT)*100).toFixed(1)+'%':'--',lbl:'Win Rate',c:'#fcd535'}].map(st=>`<div class="stat-box"><div class="stat-val" style="color:${st.c}">${st.val}</div><div class="stat-lbl">${st.lbl}</div></div>`).join('');
    const ranked=Object.values(s.algos).sort((a,b)=>b.balance-a.balance);
    document.getElementById('lv-standings').innerHTML=ranked.map((a,i)=>{const rc2=i===0?'#fcd535':i===1?'#c0c0c0':i===2?'#cd7f32':'#2b3139';const c=a.balance>=s.perAlgo?'#0ecb81':'#f6465d';const wr=a.trades>0?((a.wins/a.trades)*100).toFixed(0)+'%':'--';return`<div class="round-row"><span class="rank-badge" style="background:${rc2}22;color:${rc2}">#${i+1}</span><span style="font-size:12px;font-weight:700;flex:1">${a.name}</span><span style="font-size:11px;color:var(--text-muted);margin-right:12px">${wr} | ${a.trades}T</span><span style="font-size:13px;font-weight:700;color:${c}">${a.balance.toFixed(2)} ${s.currency}</span></div>`;}).join('');
    drawFinalEq();
}
function resetSession(){lvSess=null;lvEqHist=[];lvRoundLog=[];document.getElementById('lv-done').style.display='none';document.getElementById('lv-idle').style.display='block';document.getElementById('lv-csv').style.display='none';}

function renderCards(phase='idle'){
    if(!lvSess)return;
    document.getElementById('lv-cards').innerHTML=Object.values(lvSess.algos).map(a=>{
        const sig=a.currentSignal,sigCls=sig===1?'signal-buy':sig===-1?'signal-sell':'signal-hold';
        const badge=sig===1?'BUY':sig===-1?'SELL':'HOLD',bdgCls=sig===1?'badge-buy':sig===-1?'badge-sell':'badge-hold';
        const sigC=sig===1?'#0ecb81':sig===-1?'#f6465d':'#fcd535';
        const pnl=a.balance-lvSess.perAlgo,last=a.history[a.history.length-1];
        let vrCls='',emoji='';
        if(phase==='verified'&&last&&last.round===lvSess.round){vrCls=last.won?'verified-win':'verified-loss';emoji=last.won?'‚úÖ':'‚ùå';}
        const wr=a.trades>0?((a.wins/a.trades)*100).toFixed(0)+'%':'--';
        return`<div class="algo-card ${sigCls} ${vrCls}"><div class="acard-name" title="${a.name}">${a.name}</div><div style="display:flex;align-items:center;gap:6px"><div class="acard-signal" style="color:${sigC}">${sig===0?'‚Äì':sig===1?'‚ñ≤':'‚ñº'}</div><span class="signal-badge ${bdgCls}">${badge}</span></div><div class="acard-alloc">${a.balance.toFixed(2)} ${lvSess.currency}</div><div class="acard-pnl" style="color:${pnl>=0?'#0ecb81':'#f6465d'}">${pnl>=0?'+':''}${pnl.toFixed(3)}</div><div style="display:flex;justify-content:space-between;margin-top:4px"><span style="font-size:9px;color:var(--text-muted)">W${a.wins}/L${a.losses}</span><span style="font-size:9px;color:var(--text-muted)">${wr} WR</span></div>${emoji?`<div class="acard-result">${emoji}</div>`:''}</div>`;
    }).join('');
}

function updatePortHdr(){
    if(!lvSess)return;const s=lvSess;
    const total=Object.values(s.algos).reduce((a,b)=>a+b.balance,0),pnl=total-s.amount;
    const totT=Object.values(s.algos).reduce((a,b)=>a+b.trades,0),totW=Object.values(s.algos).reduce((a,b)=>a+b.wins,0);
    document.getElementById('lv-total').textContent=`${total.toFixed(2)} ${s.currency}`;
    document.getElementById('lv-total').style.color=pnl>=0?'#0ecb81':'#f6465d';
    document.getElementById('lv-pnl').textContent=`${pnl>=0?'+':''}${pnl.toFixed(2)} ${s.currency}`;
    document.getElementById('lv-pnl').style.color=pnl>=0?'#0ecb81':'#f6465d';
    document.getElementById('lv-wr').textContent=totT>0?((totW/totT)*100).toFixed(1)+'%':'--';
}

function drawMiniEq(){
    const cv=document.getElementById('lv-eq-mini');if(!cv||lvEqHist.length<2)return;
    const ctx=cv.getContext('2d');const W=cv.offsetWidth||320,H=130;cv.width=W;cv.height=H;
    const vals=lvEqHist.map(e=>e.total),minV=Math.min(...vals),maxV=Math.max(...vals),rng=(maxV-minV)||1;
    ctx.fillStyle='#11151c';ctx.fillRect(0,0,W,H);
    const by=H-8-((lvSess.amount-minV)/rng)*(H-20);ctx.strokeStyle='#2b3139';ctx.lineWidth=1;ctx.setLineDash([3,3]);ctx.beginPath();ctx.moveTo(0,by);ctx.lineTo(W,by);ctx.stroke();ctx.setLineDash([]);
    const col=vals[vals.length-1]>=lvSess.amount?'#0ecb81':'#f6465d';ctx.strokeStyle=col;ctx.lineWidth=2;ctx.beginPath();vals.forEach((v,i)=>{const x=(i/(vals.length-1||1))*W,y=H-8-((v-minV)/rng)*(H-20);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.stroke();
}

function drawFinalEq(){
    const cv=document.getElementById('lv-eq-final');if(!cv||lvEqHist.length<2)return;
    const ctx=cv.getContext('2d');const W=cv.offsetWidth||600,H=160;cv.width=W;cv.height=H;
    const vals=lvEqHist.map(e=>e.total),minV=Math.min(...vals),maxV=Math.max(...vals),rng=(maxV-minV)||1;
    ctx.fillStyle='#11151c';ctx.fillRect(0,0,W,H);
    const by=H-12-((lvSess.amount-minV)/rng)*(H-24);ctx.strokeStyle='#2b3139';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(0,by);ctx.lineTo(W,by);ctx.stroke();ctx.setLineDash([]);
    const col=vals[vals.length-1]>=lvSess.amount?'#0ecb81':'#f6465d';
    ctx.beginPath();vals.forEach((v,i)=>{const x=(i/(vals.length-1||1))*W,y=H-12-((v-minV)/rng)*(H-24);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fillStyle=col+'22';ctx.fill();
    ctx.beginPath();vals.forEach((v,i)=>{const x=(i/(vals.length-1||1))*W,y=H-12-((v-minV)/rng)*(H-24);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.strokeStyle=col;ctx.lineWidth=2;ctx.stroke();
    ctx.fillStyle='#848e9c';ctx.font='9px monospace';ctx.textAlign='left';ctx.fillText(minV.toFixed(2),4,H-2);ctx.textAlign='right';ctx.fillText(maxV.toFixed(2),W-4,12);
}

function exportLive(){
    if(!lvSess)return;
    const s=lvSess,rows=['Round,EntryPrice,ExitPrice,Wins,Losses,RoundPnL'];
    lvRoundLog.forEach(r=>rows.push(`${r.round},${r.entryPrice},${r.exitPrice},${r.wins},${r.losses},${r.pnl.toFixed(4)}`));
    rows.push('','Algorithm,Balance,Trades,Wins,Losses,WinRate%');
    Object.values(s.algos).forEach(a=>rows.push(`"${a.name}",${a.balance.toFixed(4)},${a.trades},${a.wins},${a.losses},${a.trades>0?((a.wins/a.trades)*100).toFixed(1):0}`));
    dlCSV(rows.join('\n'),`live_${lvSym}_${Date.now()}.csv`);
}
function dlCSV(content,filename){const b=new Blob([content],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=filename;a.click();}

// Init
updateBtLbl();updateLvDuration();updateLvPerAlgo();
</script>
</body>
</html>