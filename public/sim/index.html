<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iFINN | Algorithm Simulation Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css">
    <link rel="icon" href="/favicon.svg">
</head>
<body>

<header>
    <div style="display:flex;align-items:center;gap:14px">
        <a href="/chart.html" style="color:var(--text-muted);font-size:18px;text-decoration:none">â†</a>
        <h1 style="font-size:17px;font-weight:700;letter-spacing:-.02em">
            <span style="color:#fcd535">iFINN</span>
            <span style="color:#3a424e;margin:0 6px">|</span>
            <span style="font-size:13px;font-weight:600">Algorithm Lab</span>
        </h1>
        <span style="font-size:10px;background:#2b3139;color:#848e9c;padding:2px 8px;border-radius:4px">v3.1</span>
    </div>
    <div style="display:flex;align-items:center;gap:14px;font-size:11px;font-family:'Courier New',monospace">
        <span id="hdr-symbol" style="color:#fff;font-weight:700">--</span>
        <span id="hdr-price" style="color:#fcd535">--</span>
        <span id="hdr-status" style="color:#848e9c">IDLE</span>
    </div>
</header>

<div class="tab-bar">
    <div class="main-tab active" id="mtab-backtest" onclick="switchTab('backtest')">ğŸ“Š Walk-Forward Backtest</div>
    <div class="main-tab" id="mtab-live" onclick="switchTab('live')">ğŸ”´ Live Paper Trading</div>
    <div class="main-tab" id="mtab-docs" onclick="switchTab('docs')">ğŸ“– Algorithm Docs</div>
</div>

<!-- â•â• TAB 1: BACKTEST â•â• -->
<div class="tab-content active" id="tab-backtest">
<div class="sim-layout">
<aside class="config-panel">
    <div class="card">
        <div class="label">Symbol</div>
        <div class="search-wrap">
            <input id="bt-sym" class="ctrl" type="text" placeholder="BTC, ETHâ€¦" autocomplete="off">
            <div id="bt-sym-drop" class="search-drop"></div>
        </div>
        <div id="bt-sym-sel" style="margin-top:6px;font-size:11px;color:var(--text-muted)">No symbol selected</div>
    </div>
    <div class="card">
        <div class="label">Timeframe</div>
        <select id="bt-tf" class="ctrl" onchange="updateBtLbl()">
            <option value="1m">1 Minute</option><option value="5m">5 Minutes</option>
            <option value="15m">15 Minutes</option><option value="1h" selected>1 Hour</option>
            <option value="4h">4 Hours</option><option value="1d">1 Day</option>
        </select>
    </div>
    <div class="card">
        <div class="label">Historical Candles</div>
        <select id="bt-limit" class="ctrl">
            <option value="200">200 candles</option><option value="500" selected>500 candles</option><option value="1000">1000 candles</option>
        </select>
    </div>
    <div class="card">
        <div class="label">Prediction Horizon</div>
        <div style="display:flex;gap:8px;align-items:center">
            <input id="bt-horizon" class="ctrl" type="number" value="5" min="1" max="100" style="width:65px" oninput="updateBtLbl()">
            <span style="font-size:11px;color:var(--text-muted)">candles ahead</span>
        </div>
        <div id="bt-horizon-lbl" style="margin-top:4px;font-size:10px;color:#3a424e">= 5h on 1H</div>
    </div>
    <div class="card">
        <div class="label">Warm-up Period</div>
        <div style="display:flex;gap:8px;align-items:center">
            <input id="bt-warmup" class="ctrl" type="number" value="100" min="50" max="300" style="width:65px">
            <span style="font-size:11px;color:var(--text-muted)">candles</span>
        </div>
    </div>
    <div class="card">
        <div class="label" style="margin-bottom:8px">Algorithms <span style="color:#3a424e;font-size:9px;font-weight:400;letter-spacing:0;text-transform:none">â€” 25 models</span></div>
        <div class="algo-grid" id="bt-chips"></div>
        <div style="display:flex;gap:6px;margin-top:8px">
            <button class="btn-sec" onclick="btAll(1)">All</button>
            <button class="btn-sec" onclick="btAll(0)">None</button>
        </div>
    </div>
    <button id="bt-run" class="btn-primary" onclick="runBT()" disabled>â–¶ RUN BACKTEST</button>
    <button id="bt-csv" class="btn-sec" onclick="exportBT()" style="display:none;width:100%">â†“ Export CSV</button>
    <p style="font-size:10px;color:#3a424e;line-height:1.5">Walk-forward: signals use only past data, compared against price N candles later. Zero lookahead bias.</p>
</aside>
<main class="sim-main">
    <div id="bt-idle"><div class="idle-art">ğŸ”¬</div><h2 style="text-align:center;font-size:20px;font-weight:700;margin-bottom:8px">Walk-Forward Backtest</h2><p style="text-align:center;font-size:13px;color:var(--text-muted);max-width:500px;margin:0 auto;line-height:1.6">Select a symbol, configure parameters, click <strong style="color:#fcd535">Run Backtest</strong>. Tests all 25 algorithms with zero lookahead bias.</p></div>
    <div id="bt-running" style="display:none">
        <div style="font-size:12px;font-weight:700;color:var(--text-muted);margin-bottom:10px">Simulation Progress</div>
        <div class="progress-track" style="margin-bottom:6px"><div class="progress-fill" id="bt-fill"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:10px;color:#3a424e;margin-bottom:14px;font-family:'Courier New',monospace"><span id="bt-prog-lbl">Loadingâ€¦</span><span id="bt-prog-pct">0%</span></div>
        <div class="log-console" id="bt-log"></div>
    </div>
    <div id="bt-results" style="display:none">
        <div class="stat-grid" id="bt-stats" style="margin-bottom:18px"></div>
        <div class="ensemble-box" id="bt-ensemble" style="margin-bottom:18px"></div>
        <div class="card" style="margin-bottom:18px"><div class="label" style="margin-bottom:10px">Equity Curve â€” Top 3</div><canvas class="equity" id="bt-equity"></canvas><div id="bt-eq-legend" style="display:flex;gap:14px;margin-top:8px;font-size:10px"></div></div>
        <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                <div class="label">Algorithm Performance</div>
                <input id="bt-filter" class="ctrl" type="text" placeholder="Filterâ€¦" style="width:120px;font-size:11px;padding:4px 8px">
            </div>
            <div style="overflow-x:auto">
                <table class="results-table" id="bt-table">
                    <thead><tr>
                        <th onclick="btSort('rank')">Rank</th><th onclick="btSort('name')">Algorithm</th>
                        <th onclick="btSort('signals')" data-tip="Candles that fired a non-zero signal">Signals</th>
                        <th onclick="btSort('correct')">Correct</th><th onclick="btSort('accuracy')">Accuracy</th><th></th>
                        <th onclick="btSort('avgReturn')">Avg Ret%</th><th onclick="btSort('sharpe')">Sharpe</th>
                        <th onclick="btSort('maxStreak')" class="col-streak">Streak</th><th onclick="btSort('grade')">Grade</th>
                    </tr></thead>
                    <tbody id="bt-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>
</div>
</div>

<!-- â•â• TAB 2: LIVE PAPER TRADING â•â• -->
<div class="tab-content" id="tab-live">
<div class="sim-layout">
<aside class="config-panel">
    <div class="card">
        <div class="label">Symbol</div>
        <div class="search-wrap">
            <input id="lv-sym" class="ctrl" type="text" placeholder="BTCUSDTâ€¦" autocomplete="off">
            <div id="lv-sym-drop" class="search-drop"></div>
        </div>
        <div id="lv-sym-sel" style="margin-top:6px;font-size:11px;color:var(--text-muted)">No symbol selected</div>
    </div>
    <div class="card">
        <div class="label">Candle Timeframe</div>
        <select id="lv-tf" class="ctrl" onchange="updateLvDuration()">
            <option value="1m" selected>1 Minute</option><option value="3m">3 Minutes</option>
            <option value="5m">5 Minutes</option><option value="15m">15 Minutes</option>
            <option value="30m">30 Minutes</option>
        </select>
        <div style="margin-top:5px;font-size:10px;color:#3a424e">Waits one candle close per round</div>
    </div>
    <div class="card">
        <div class="label">Session Duration</div>
        <select id="lv-rounds" class="ctrl" onchange="updateLvDuration()">
            <option value="5">5 rounds</option><option value="10" selected>10 rounds</option>
            <option value="15">15 rounds</option><option value="20">20 rounds</option><option value="30">30 rounds</option>
        </select>
        <div id="lv-dur-lbl" style="margin-top:5px;font-size:10px;color:#3a424e">â‰ˆ 10 minutes</div>
    </div>
    <div class="card">
        <div class="label">Starting Capital</div>
        <div class="amount-group">
            <input id="lv-amount" class="ctrl" type="number" value="100" min="1" step="1" oninput="updateLvPerAlgo()">
            <select id="lv-cur" class="ctrl" style="width:82px" onchange="updateLvPerAlgo()">
                <option value="INR">INR</option><option value="USD">USD</option><option value="EUR">EUR</option>
                <option value="GBP">GBP</option><option value="JPY">JPY</option><option value="SGD">SGD</option><option value="AED">AED</option>
            </select>
        </div>
        <div id="lv-usdt-eq" style="margin-top:5px;font-size:10px;color:#3a424e">â‰ˆ 1.19 USDT</div>
    </div>
    <div class="card">
        <div class="label">Allocation Mode</div>
        <select id="lv-alloc" class="ctrl">
            <option value="equal">Equal split per algorithm</option>
            <option value="weighted">Accuracy-weighted (uses prior backtest)</option>
        </select>
    </div>
    <div class="card">
        <div class="label" style="margin-bottom:8px">Algorithms</div>
        <div class="algo-grid" id="lv-chips"></div>
        <div style="display:flex;gap:6px;margin-top:8px">
            <button class="btn-sec" onclick="lvAll(1)">All</button>
            <button class="btn-sec" onclick="lvAll(0)">None</button>
        </div>
        <div id="lv-per-algo" style="margin-top:8px;font-size:11px;color:var(--text-muted)">-- per algorithm</div>
    </div>
    <button id="lv-start" class="btn-primary" onclick="startSession()" disabled>â–¶ START SESSION</button>
    <button id="lv-stop" class="btn-danger" onclick="stopSession()" style="display:none">â¬› STOP SESSION</button>
    <button id="lv-csv" class="btn-sec" onclick="exportLive()" style="display:none;width:100%">â†“ Export CSV</button>
    <p style="font-size:10px;color:#3a424e;line-height:1.5">Paper trading only â€” no real money. Each algo gets an equal share of capital, predicts direction, and result is verified at candle close. Flat candles (0% move) are skipped fairly.</p>
</aside>
<main class="sim-main">
    <!-- IDLE -->
    <div id="lv-idle">
        <div class="idle-art">ğŸ“¡</div>
        <h2 style="text-align:center;font-size:20px;font-weight:700;margin-bottom:8px">Live Paper Trading</h2>
        <p style="text-align:center;font-size:13px;color:var(--text-muted);max-width:540px;margin:0 auto;line-height:1.6">
            Split capital across 25 algorithms. Each round: predict â†’ wait candle close â†’ verify â†’ track P&amp;L.
        </p>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:24px auto 0;max-width:600px">
            <div class="card" style="text-align:center"><div style="font-size:24px;margin-bottom:6px">ğŸ’°</div><div style="font-size:11px;font-weight:700;margin-bottom:4px">Capital Split</div><div style="font-size:10px;color:var(--text-muted)">Equal (or backtest-weighted) share per algo</div></div>
            <div class="card" style="text-align:center"><div style="font-size:24px;margin-bottom:6px">â±</div><div style="font-size:11px;font-weight:700;margin-bottom:4px">Real Verification</div><div style="font-size:10px;color:var(--text-muted)">Fetches real Binance price after candle closes</div></div>
            <div class="card" style="text-align:center"><div style="font-size:24px;margin-bottom:6px">ğŸ”</div><div style="font-size:11px;font-weight:700;margin-bottom:4px">Auto-Scheduler</div><div style="font-size:10px;color:var(--text-muted)">Repeats for your chosen number of rounds</div></div>
        </div>
    </div>

    <!-- ACTIVE SESSION -->
    <div id="lv-session" style="display:none">
        <div class="portfolio-header">
            <div class="pstat">
                <div class="pstat-val" id="lv-total">--</div>
                <div style="font-size:9px;color:var(--text-muted);margin-top:2px" id="lv-total-pct"></div>
                <div class="pstat-lbl">Total Capital</div>
            </div>
            <div class="pstat">
                <div class="pstat-val" id="lv-pnl">--</div>
                <div class="pstat-lbl">Net P&amp;L</div>
            </div>
            <div class="pstat"><div class="pstat-val" id="lv-round-disp">0/0</div><div class="pstat-lbl">Round</div></div>
            <div class="pstat"><div class="pstat-val" id="lv-wr">--%</div><div class="pstat-lbl">Win Rate</div></div>
            <div class="pstat" style="display:flex;align-items:center;justify-content:center;flex-direction:column">
                <div class="countdown-ring" style="margin-bottom:4px">
                    <svg width="60" height="60" viewBox="0 0 60 60">
                        <circle cx="30" cy="30" r="26" fill="none" stroke="#2b3139" stroke-width="4"/>
                        <circle id="lv-cd-ring" cx="30" cy="30" r="26" fill="none" stroke="#fcd535" stroke-width="4" stroke-dasharray="163.4" stroke-dashoffset="0" stroke-linecap="round"/>
                    </svg>
                    <span class="countdown-val" id="lv-cd-num">--</span>
                </div>
                <div class="pstat-lbl" id="lv-cd-lbl">Next close</div>
            </div>
        </div>
        <div id="lv-phase" style="background:#fcd53515;border:1px solid #fcd53533;border-radius:6px;padding:10px 16px;margin-bottom:14px;font-size:12px;display:flex;align-items:center;gap:10px">
            <span class="pulse" id="lv-phase-icon" style="font-size:14px">ğŸ“¡</span>
            <span id="lv-phase-txt">Initialisingâ€¦</span>
        </div>
        <div class="algo-cards" id="lv-cards"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
            <div class="card"><div class="label" style="margin-bottom:8px">Round History</div><div id="lv-history" style="max-height:160px;overflow-y:auto"></div></div>
            <div class="card"><div class="label" style="margin-bottom:8px">Portfolio Equity</div><canvas id="lv-eq-mini" style="width:100%;height:130px;display:block"></canvas></div>
        </div>
        <div class="card"><div class="label" style="margin-bottom:6px">Session Log</div><div class="session-log" id="lv-log"></div></div>
    </div>

    <!-- POST SESSION -->
    <div id="lv-done" style="display:none">
        <div style="text-align:center;margin-bottom:20px">
            <div style="font-size:40px;margin-bottom:8px" id="lv-done-emoji">ğŸ†</div>
            <h2 style="font-size:22px;font-weight:800;margin-bottom:4px" id="lv-done-title">Session Complete</h2>
            <p style="font-size:13px;color:var(--text-muted)" id="lv-done-sub"></p>
        </div>
        <div class="stat-grid" id="lv-done-stats" style="margin-bottom:18px"></div>
        <div class="card" style="margin-bottom:18px"><div class="label" style="margin-bottom:10px">Algorithm Standings</div><div id="lv-standings"></div></div>
        <div class="card" style="margin-bottom:14px"><div class="label" style="margin-bottom:8px">Equity Curve</div><canvas id="lv-eq-final" style="width:100%;height:160px;display:block"></canvas></div>
        <div style="display:flex;gap:10px">
            <button class="btn-primary" onclick="resetSession()" style="flex:1">â†º New Session</button>
            <button class="btn-sec" onclick="exportLive()" style="flex:1">â†“ Export CSV</button>
        </div>
    </div>
</main>
</div>
</div>

<!-- â•â• TAB 3: ALGO DOCS â•â• -->
<div class="tab-content" id="tab-docs">
<div class="sim-main" style="padding:24px;max-width:1100px;margin:0 auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">
        <div>
            <h2 style="font-size:18px;font-weight:800;margin-bottom:4px">Algorithm Reference</h2>
            <p style="font-size:12px;color:var(--text-muted)">25 prediction models â€” formulas, signal conditions, and best-use notes</p>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
            <input id="docs-filter" class="ctrl" type="text" placeholder="Searchâ€¦" style="width:160px;font-size:12px" oninput="filterDocs()">
            <select id="docs-group" class="ctrl" style="width:120px;font-size:12px" onchange="filterDocs()">
                <option value="">All Groups</option>
                <option value="Trend">Trend</option>
                <option value="Momentum">Momentum</option>
                <option value="Volume">Volume</option>
                <option value="Volatility">Volatility</option>
                <option value="Statistical">Statistical</option>
            </select>
        </div>
    </div>
    <div id="docs-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px"></div>
</div>
</div>

<script>
const API = 'https://api.binance.com/api/v3';

// â”€â”€ FX â”€â”€
const FX={INR:83.5,USD:1,EUR:0.92,GBP:0.79,JPY:149.5,SGD:1.34,AED:3.67};
(async()=>{try{const r=await fetch('https://open.er-api.com/v6/latest/USD');const d=await r.json();if(d.rates)Object.keys(FX).forEach(k=>{if(d.rates[k])FX[k]=d.rates[k];});}catch(_){}})();
const toUSDT=(v,c)=>v/(FX[c]||1);

// â”€â”€ Symbols â”€â”€
let symbols=[];
(async()=>{try{const r=await fetch(`${API}/exchangeInfo`);const d=await r.json();symbols=d.symbols.filter(s=>s.status==='TRADING').map(s=>({symbol:s.symbol,base:s.baseAsset,quote:s.quoteAsset}));}catch(_){}})();

// â”€â”€ ALGORITHM REGISTRY (25 models) â”€â”€
const ALGOS=[
    // Trend
    {key:'sma',       name:'SMA (20)',        group:'Trend'},
    {key:'ema',       name:'EMA (20)',         group:'Trend'},
    {key:'hma',       name:'Hull MA (16)',     group:'Trend'},
    {key:'tema',      name:'TEMA (20)',        group:'Trend'},
    {key:'parabolicsar',name:'Parabolic SAR',  group:'Trend'},
    {key:'ichimoku',  name:'Ichimoku',         group:'Trend'},
    {key:'adx',       name:'ADX/DI (14)',      group:'Trend'},
    // Momentum
    {key:'rsi',       name:'RSI (14)',          group:'Momentum'},
    {key:'macd',      name:'MACD',             group:'Momentum'},
    {key:'stoch',     name:'Stochastic',       group:'Momentum'},
    {key:'stochrsi',  name:'Stoch RSI',        group:'Momentum'},
    {key:'cci',       name:'CCI (20)',          group:'Momentum'},
    {key:'willr',     name:'Williams %R',       group:'Momentum'},
    {key:'elderray',  name:'Elder Ray',         group:'Momentum'},
    {key:'roc',       name:'ROC (10)',          group:'Momentum'},
    {key:'squeeze',   name:'Squeeze',           group:'Momentum'},
    // Volume
    {key:'vwap',      name:'VWAP',             group:'Volume'},
    {key:'obv',       name:'OBV',              group:'Volume'},
    {key:'cmf',       name:'CMF (21)',          group:'Volume'},
    {key:'mfi',       name:'MFI (14)',          group:'Volume'},
    // Volatility
    {key:'bb',        name:'Bollinger Bands',   group:'Volatility'},
    {key:'keltner',   name:'Keltner Channel',   group:'Volatility'},
    {key:'donchian',  name:'Donchian (20)',     group:'Volatility'},
    // Statistical
    {key:'zscore',    name:'Z-Score (20)',      group:'Statistical'},
    {key:'lrchannel', name:'LR Channel',        group:'Statistical'},
];
const btActive=new Set(ALGOS.map(a=>a.key));
const lvActive=new Set(ALGOS.map(a=>a.key));

// â”€â”€ ALGORITHM DOCUMENTATION â”€â”€
const ALGO_DOCS={
    sma:{
        formula:'SMAâ‚‚â‚€ = Î£(close[i]) / 20',
        signal:'BUY if close > SMAÃ—1.001 | SELL if close < SMAÃ—0.999 | HOLD otherwise',
        interpretation:'The 20-period Simple Moving Average smooths price to identify dominant trend direction. Price crossing above signals upward momentum; crossing below signals downward pressure.',
        bestFor:'Medium-term trend following on liquid pairs. Works best on 1H+ timeframes.'
    },
    ema:{
        formula:'EMA = closeÃ—k + EMA_prevÃ—(1âˆ’k), k=2/(N+1), N=20',
        signal:'BUY if close > EMAÃ—1.001 | SELL if close < EMAÃ—0.999',
        interpretation:'Exponential weighting gives more importance to recent candles vs SMA. Reacts faster to price changes, reducing lag in trending markets.',
        bestFor:'Short-to-medium trend signals. Better than SMA in fast-moving markets.'
    },
    hma:{
        formula:'WMA(2Ã—WMA(N/2) âˆ’ WMA(N), âˆšN), N=16',
        signal:'BUY if HMA rising | SELL if HMA falling',
        interpretation:'Hull Moving Average dramatically reduces lag while keeping smoothness. Uses weighted moving averages and offset cancellation to produce a nearly zero-lag trend line.',
        bestFor:'Trend following where lag is critical. Excellent on 15mâ€“4H timeframes.'
    },
    tema:{
        formula:'TEMA = 3Ã—EMAâ‚ âˆ’ 3Ã—EMAâ‚‚ + EMAâ‚ƒ  (triple smoothing, N=20)',
        signal:'BUY if TEMA rising and price above TEMA | SELL if TEMA falling and price below',
        interpretation:'Triple exponential smoothing that virtually eliminates lag from a standard EMA. The 3-EMA construction cancels most delay, giving a very responsive trend signal.',
        bestFor:'Fast trend detection. Useful on 5mâ€“1H for momentum entries.'
    },
    parabolicsar:{
        formula:'SAR_t = SAR_{t-1} + Î±(EP âˆ’ SAR_{t-1}), Î±âˆˆ[0.02, 0.20]',
        signal:'BUY when price crosses above SAR (trend flips bullish) | SELL when price crosses below SAR',
        interpretation:'Parabolic SAR trails price using an accelerating factor. When price is above the dots the trend is bullish; when below, bearish. The acceleration factor increases with each new extreme point.',
        bestFor:'Trailing stop placement and trend-reversal detection. Avoid in choppy/sideways markets.'
    },
    ichimoku:{
        formula:'SenkouA = (Tenkan9 + Kijun26)/2; SenkouB = midRange(52); Cloud = {min(A,B), max(A,B)}',
        signal:'BUY if price > Cloud top | SELL if price < Cloud bottom | NEUTRAL inside cloud',
        interpretation:'The Ichimoku Cloud system provides support/resistance zones (the cloud), plus trend, momentum, and leading signals in one indicator. Price above a bullish (green) cloud is strongly bullish.',
        bestFor:'Comprehensive trend analysis on daily/4H. Best on highly liquid pairs like BTCUSDT.'
    },
    adx:{
        formula:'ADX = EMA(|+DI âˆ’ âˆ’DI| / (+DI + âˆ’DI) Ã— 100, 14); +DI and âˆ’DI from smoothed True Range',
        signal:'BUY if +DI > âˆ’DI significantly (>15pt gap) | SELL if âˆ’DI > +DI significantly',
        interpretation:'ADX measures trend strength; +DI and -DI give direction. ADX>25 confirms a strong trend. This implementation uses directional divergence (gap between lines) to emit a signal even without ADX threshold.',
        bestFor:'Confirming trend strength before entry. Combine with SMA/EMA crossovers.'
    },
    rsi:{
        formula:'RSI = 100 âˆ’ 100/(1 + AvgGain/AvgLoss), N=14  (Wilder smoothing)',
        signal:'BUY if RSI < 30 (oversold) | SELL if RSI > 70 (overbought)',
        interpretation:'RSI measures speed and magnitude of price changes on a 0â€“100 scale. Extreme readings indicate potential reversals. Wilder\'s exponential smoothing prevents sudden RSI spikes.',
        bestFor:'Mean-reversion entries in ranging markets. Combine with trend context to avoid buying falling knives.'
    },
    macd:{
        formula:'MACD = EMA(12) âˆ’ EMA(26); Signal = EMA(MACD, 9); Histogram = MACD âˆ’ Signal',
        signal:'BUY if MACD line crosses above Signal line | SELL if crosses below',
        interpretation:'MACD captures momentum by subtracting a slower EMA from a faster one. The signal line crossover is the classic entry trigger. Histogram bars show divergence strength.',
        bestFor:'Momentum confirmation on 1Hâ€“1D. Works well for identifying early trend shifts.'
    },
    stoch:{
        formula:'%K = (close âˆ’ min14) / (max14 âˆ’ min14) Ã— 100; Smoothed with %D',
        signal:'BUY if %K < 20 | SELL if %K > 80',
        interpretation:'Stochastic measures where the close sits within the recent high-low range. Values near 0 mean price closed near period lows (oversold); near 100 means near highs (overbought).',
        bestFor:'Countertrend entries at support/resistance. Combine with trend direction for better accuracy.'
    },
    stochrsi:{
        formula:'StochRSI = (RSI âˆ’ min(RSI,14)) / (max(RSI,14) âˆ’ min(RSI,14)) Ã— 100',
        signal:'BUY if StochRSI < 20 | SELL if StochRSI > 80',
        interpretation:'Applies the Stochastic formula to RSI values instead of price. More sensitive than plain RSI â€” it reaches oversold/overbought extremes more frequently, generating more signals in trending markets.',
        bestFor:'Early momentum reversal detection. Most effective on 1Hâ€“4H with liquid pairs.'
    },
    cci:{
        formula:'CCI = (TP âˆ’ SMA(TP,20)) / (0.015 Ã— MeanDeviation), TP = (H+L+C)/3',
        signal:'BUY if CCI < âˆ’100 (oversold) | SELL if CCI > +100 (overbought)',
        interpretation:'CCI measures the deviation of the typical price from its statistical mean. Values beyond Â±100 indicate the price is significantly outside its normal range, suggesting a potential reversal.',
        bestFor:'Detecting cyclical turning points in commodities and crypto. Works on all timeframes.'
    },
    willr:{
        formula:'%R = (HHâ‚â‚„ âˆ’ close) / (HHâ‚â‚„ âˆ’ LLâ‚â‚„) Ã— âˆ’100',
        signal:'BUY if %R < âˆ’80 | SELL if %R > âˆ’20',
        interpretation:'Williams %R is an inverse Stochastic indicator on a scale of âˆ’100 to 0. Readings near âˆ’100 mean price is near its 14-period low (oversold); near 0 means near its high (overbought).',
        bestFor:'Short-term overbought/oversold detection. Fast-responding; good on 5mâ€“1H.'
    },
    elderray:{
        formula:'Bull Power = High âˆ’ EMA(13); Bear Power = Low âˆ’ EMA(13)',
        signal:'BUY if Bull Power > 0 and rising while Bear Power < 0 | SELL if Bear Power declining more negative',
        interpretation:'Elder Ray measures the strength of bulls (how far highs reach above EMA) and bears (how far lows fall below EMA). A positive and rising bull power with negative bear power suggests bullish dominance.',
        bestFor:'Confirming trend direction alongside a trend-following indicator. Works on 1Hâ€“1D.'
    },
    roc:{
        formula:'ROC = (close / close[10]) âˆ’ 1 Ã— 100%',
        signal:'BUY if ROC > +0.5% | SELL if ROC < âˆ’0.5%',
        interpretation:'Rate of Change measures the percentage price change over a lookback period. Positive ROC confirms upward momentum; negative ROC confirms downward momentum. Simple but effective velocity indicator.',
        bestFor:'Momentum confirmation and divergence analysis. Best on 15mâ€“4H.'
    },
    squeeze:{
        formula:'Momentum = close âˆ’ mean(midpoint(HH20,LL20), SMA20)',
        signal:'BUY if momentum positive (expanding upward) | SELL if negative',
        interpretation:'The Squeeze Momentum indicator detects when Bollinger Bands squeeze inside Keltner Channels (low volatility compression), then fires when price breaks out. This simplified version uses midpoint-SMA difference as the momentum proxy.',
        bestFor:'Breakout detection after consolidation. Excellent on 15mâ€“4H for crypto.'
    },
    vwap:{
        formula:'VWAP = Î£(TP Ã— Volume) / Î£(Volume), TP = (H+L+C)/3',
        signal:'BUY if close < VWAPÃ—0.999 | SELL if close > VWAPÃ—1.001',
        interpretation:'VWAP provides the volume-weighted average price for the session. Institutional traders often buy below VWAP and sell above it. Reversion to VWAP is a common target.',
        bestFor:'Intraday mean-reversion on 1mâ€“15m. Most reliable on high-volume pairs.'
    },
    obv:{
        formula:'OBV = OBV[-1] + volume (if up close), âˆ’ volume (if down close)',
        signal:'BUY if OBV trend rising over last 5 bars | SELL if declining',
        interpretation:'On-Balance Volume accumulates volume on up days and subtracts on down days. Rising OBV while price is flat or lagging is a bullish divergence signal (accumulation phase).',
        bestFor:'Detecting smart money accumulation/distribution. Divergence signals are most powerful.'
    },
    cmf:{
        formula:'CMF = Î£(MFV, 21) / Î£(volume, 21); MFV = ((Câˆ’L)âˆ’(Hâˆ’C))/(Hâˆ’L) Ã— volume',
        signal:'BUY if CMF > 0.05 (buying pressure) | SELL if CMF < âˆ’0.05 (selling pressure)',
        interpretation:'Chaikin Money Flow measures the cumulative money flow over 21 periods. A positive CMF means money is flowing in (buyers in control); negative means money is flowing out (sellers).',
        bestFor:'Confirming breakout direction. Strong when combined with price action near key levels.'
    },
    mfi:{
        formula:'MFI = 100 âˆ’ 100/(1 + PMF/NMF), MF = TP Ã— volume, N=14',
        signal:'BUY if MFI < 20 | SELL if MFI > 80',
        interpretation:'Money Flow Index is an RSI-equivalent that incorporates volume. Overbought (>80) with declining price is a strong sell; oversold (<20) with rising volume is a strong accumulation signal.',
        bestFor:'Volume-weighted reversals. More reliable than plain RSI in high-volume environments.'
    },
    bb:{
        formula:'Upper = SMA20 + 2Ïƒ; Lower = SMA20 âˆ’ 2Ïƒ; Ïƒ = standard deviation (20)',
        signal:'BUY if close < lower band | SELL if close > upper band',
        interpretation:'Bollinger Bands expand during high volatility and contract during low volatility. Price touching the lower band in an uptrend often bounces; touching the upper band in a downtrend often reverses.',
        bestFor:'Mean-reversion in ranging markets. Use band width (squeeze/expansion) for momentum signals.'
    },
    keltner:{
        formula:'Center = EMA(20); Upper = EMA + 2Ã—ATR(10); Lower = EMA âˆ’ 2Ã—ATR(10)',
        signal:'BUY if close < lower Keltner | SELL if close > upper Keltner',
        interpretation:'Keltner Channels use ATR for band width, making them adaptive to volatility unlike Bollinger Bands\'s fixed Ïƒ. Price outside the channels indicates extreme extension and potential mean reversion.',
        bestFor:'Comparing with Bollinger Bands (BB inside Keltner = Squeeze). Volatility breakout detection.'
    },
    donchian:{
        formula:'Upper = max(high, N=20); Lower = min(low, N=20); Mid = (Upper+Lower)/2',
        signal:'BUY if price â‰¥ upper band (breakout) or price > mid | SELL at lower band or below mid',
        interpretation:'Donchian Channels were popularised by the "Turtle Traders". A break above the 20-period high is a classic trend-following entry. Price relative to midpoint also gives a directional bias.',
        bestFor:'Trend-following and breakout trading on 4Hâ€“1D. The basis of many systematic strategies.'
    },
    zscore:{
        formula:'Z = (close âˆ’ Î¼â‚‚â‚€) / Ïƒâ‚‚â‚€',
        signal:'BUY if Z < âˆ’2 (2 std devs below mean) | SELL if Z > +2',
        interpretation:'Z-Score measures how many standard deviations the current price is from its 20-period mean. Extreme Z values indicate statistically unusual prices that tend to revert â€” a quantitative mean-reversion signal.',
        bestFor:'Statistical mean-reversion pairs trading and crypto on 1Hâ€“4H. Robust in ranging regimes.'
    },
    lrchannel:{
        formula:'Least-squares regression line through last 100 closes; channel = fit Â± 1 RMSE',
        signal:'BUY if price < lower regression channel | SELL if price > upper regression channel',
        interpretation:'Fits a linear regression to recent prices. The channel bounds (Â±1 RMSE) act as dynamic support/resistance. Price outside the channel is statistically overextended relative to recent trend trajectory.',
        bestFor:'Trending markets on 1Hâ€“1D. The slope of the regression line also reveals trend strength.'
    }
};

// â”€â”€ MATH HELPERS â”€â”€
const emaFull=(arr,n)=>{const k=2/(n+1),out=[arr[0]];for(let i=1;i<arr.length;i++)out.push(arr[i]*k+out[i-1]*(1-k));return out;};
const smaLast=(arr,n)=>{const sl=arr.slice(-n);return sl.reduce((a,b)=>a+b,0)/sl.length;};
const emaLast=(arr,n)=>{const k=2/(n+1);let e=arr[0];for(let i=1;i<arr.length;i++)e=arr[i]*k+e*(1-k);return e;};
const wmaLast=(arr,n)=>{const sl=arr.slice(-n);let w=0,s=0;sl.forEach((x,i)=>{s+=x*(i+1);w+=i+1;});return s/w;};
const std=(arr)=>{const m=arr.reduce((a,b)=>a+b,0)/arr.length;return Math.sqrt(arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length);};
const trv=(h,l,pc)=>Math.max(h-l,Math.abs(h-pc),Math.abs(l-pc));
function calcRSI(cls,n=14){let g=0,l=0;for(let i=1;i<=n;i++){const d=cls[i]-cls[i-1];g+=d>0?d:0;l+=d<0?-d:0;}let ag=g/n,al=l/n;for(let i=n+1;i<cls.length;i++){const d=cls[i]-cls[i-1];ag=(ag*(n-1)+(d>0?d:0))/n;al=(al*(n-1)+(d<0?-d:0))/n;}return al===0?100:100-100/(1+ag/al);}

// â”€â”€ SIGNAL FUNCTIONS â”€â”€
const SIG={
    // â”€â”€ Trend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    sma({closes}){
        if(closes.length<22)return 0;
        const s=smaLast(closes,20),c=closes[closes.length-1];
        return c>s*1.001?1:c<s*0.999?-1:0;
    },
    ema({closes}){
        if(closes.length<22)return 0;
        const e=emaLast(closes.slice(-30),20),c=closes[closes.length-1];
        return c>e*1.001?1:c<e*0.999?-1:0;
    },
    hma({closes}){
        // WMA(2*WMA(n/2) - WMA(n), sqrt(n)), n=16
        if(closes.length<30)return 0;
        const n=16;
        const raw=[];
        for(let i=n;i<closes.length;i++){
            const sl=closes.slice(0,i+1);
            raw.push(2*wmaLast(sl,Math.floor(n/2))-wmaLast(sl,n));
        }
        if(raw.length<5)return 0;
        const sqn=Math.ceil(Math.sqrt(n));
        const now=wmaLast(raw,Math.min(sqn,raw.length));
        const prev=wmaLast(raw.slice(0,-1),Math.min(sqn,raw.length-1));
        return now>prev*1.0001?1:now<prev*0.9999?-1:0;
    },
    tema({closes}){
        // TEMA = 3*EMA1 - 3*EMA2 + EMA3
        if(closes.length<50)return 0;
        const sl=closes.slice(-50),n=20;
        const e1=emaFull(sl,n),e2=emaFull(e1,n),e3=emaFull(e2,n);
        const tema=3*e1[e1.length-1]-3*e2[e2.length-1]+e3[e3.length-1];
        const temaPrev=3*e1[e1.length-2]-3*e2[e2.length-2]+e3[e3.length-2];
        const c=closes[closes.length-1];
        return tema>temaPrev&&c>tema?1:tema<temaPrev&&c<tema?-1:0;
    },
    parabolicsar({data}){
        if(data.length<20)return 0;
        const af0=0.02,afMax=0.2;
        let bull=data[1].close>data[0].close;
        let sar=bull?Math.min(data[0].low,data[1].low):Math.max(data[0].high,data[1].high);
        let ep=bull?data[1].high:data[1].low,af=af0;
        for(let i=2;i<data.length;i++){
            sar=sar+af*(ep-sar);
            if(bull){
                sar=Math.min(sar,data[i-1].low);
                if(i>=2)sar=Math.min(sar,data[i-2].low);
                if(data[i].low<=sar){bull=false;sar=ep;ep=data[i].low;af=af0;}
                else{if(data[i].high>ep){ep=data[i].high;af=Math.min(af+af0,afMax);}}
            }else{
                sar=Math.max(sar,data[i-1].high);
                if(i>=2)sar=Math.max(sar,data[i-2].high);
                if(data[i].high>=sar){bull=true;sar=ep;ep=data[i].high;af=af0;}
                else{if(data[i].low<ep){ep=data[i].low;af=Math.min(af+af0,afMax);}}
            }
        }
        return bull?1:-1;
    },
    ichimoku({data}){
        if(data.length<55)return 0;
        const mid=n=>{const s=data.slice(-n);return(Math.max(...s.map(d=>d.high))+Math.min(...s.map(d=>d.low)))/2;};
        const sA=(mid(9)+mid(26))/2;
        const sB=(()=>{const s=data.slice(-52);return(Math.max(...s.map(d=>d.high))+Math.min(...s.map(d=>d.low)))/2;})();
        const c=data[data.length-1].close;
        return c>Math.max(sA,sB)?1:c<Math.min(sA,sB)?-1:0;
    },
    adx({data}){
        if(data.length<30)return 0;
        let smTR=0.001,smP=0,smM=0;
        for(let i=1;i<data.length;i++){
            const p=14,tr=trv(data[i].high,data[i].low,data[i-1].close);
            const dmp=Math.max(0,data[i].high-data[i-1].high)>Math.max(0,data[i-1].low-data[i].low)?Math.max(0,data[i].high-data[i-1].high):0;
            const dmm=Math.max(0,data[i-1].low-data[i].low)>Math.max(0,data[i].high-data[i-1].high)?Math.max(0,data[i-1].low-data[i].low):0;
            smTR=smTR-smTR/p+tr;smP=smP-smP/p+dmp;smM=smM-smM/p+dmm;
        }
        const pdi=100*smP/smTR,mdi=100*smM/smTR;
        return Math.abs(pdi-mdi)<15?0:pdi>mdi?1:-1;
    },
    // â”€â”€ Momentum â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    rsi({closes}){
        if(closes.length<20)return 0;
        const r=calcRSI(closes.slice(-20));
        return r<30?1:r>70?-1:0;
    },
    macd({closes}){
        if(closes.length<40)return 0;
        const sl=closes.slice(-40),e12=emaFull(sl,12),e26=emaFull(sl,26);
        const ml=e12.map((v,i)=>v-e26[i]);
        const sg=emaFull(ml.slice(-15),9);
        return ml[ml.length-1]>sg[sg.length-1]?1:-1;
    },
    stoch({data}){
        if(data.length<17)return 0;
        const sl=data.slice(-14);
        const hi=Math.max(...sl.map(d=>d.high)),lo=Math.min(...sl.map(d=>d.low));
        if(hi===lo)return 0;
        const k=((data[data.length-1].close-lo)/(hi-lo))*100;
        return k<20?1:k>80?-1:0;
    },
    stochrsi({closes}){
        // Stochastic applied to RSI values
        if(closes.length<40)return 0;
        const rsiArr=[];
        for(let i=closes.length-20;i<closes.length;i++)rsiArr.push(calcRSI(closes.slice(0,i+1)));
        const n=14,sl=rsiArr.slice(-n);
        const hi=Math.max(...sl),lo=Math.min(...sl);
        if(hi===lo)return 0;
        const k=((rsiArr[rsiArr.length-1]-lo)/(hi-lo))*100;
        return k<20?1:k>80?-1:0;
    },
    cci({data}){
        if(data.length<22)return 0;
        const sl=data.slice(-20),tps=sl.map(d=>(d.high+d.low+d.close)/3);
        const m=tps.reduce((a,b)=>a+b,0)/20,mad=tps.reduce((a,b)=>a+Math.abs(b-m),0)/20;
        const c=mad?((tps[tps.length-1]-m)/(0.015*mad)):0;
        return c<-100?1:c>100?-1:0;
    },
    willr({data}){
        if(data.length<16)return 0;
        const sl=data.slice(-14);
        const hi=Math.max(...sl.map(d=>d.high)),lo=Math.min(...sl.map(d=>d.low));
        if(hi===lo)return 0;
        const r=((hi-data[data.length-1].close)/(hi-lo))*-100;
        return r<-80?1:r>-20?-1:0;
    },
    elderray({data}){
        // Bull Power = High - EMA13, Bear Power = Low - EMA13
        if(data.length<16)return 0;
        const cls=data.map(d=>d.close);
        const ema=emaLast(cls.slice(-13),13);
        const bull=data[data.length-1].high-ema,bear=data[data.length-1].low-ema;
        const ema2=emaLast(cls.slice(-14,-1),13);
        const bull2=data[data.length-2].high-ema2;
        if(bull>0&&bull>bull2&&bear<0)return 1;
        if(bear<0&&bear<(data[data.length-2].low-ema2)&&bull>0)return -1;
        return 0;
    },
    roc({closes}){
        // Rate of Change over 10 periods
        if(closes.length<12)return 0;
        const n=10,roc=(closes[closes.length-1]/closes[closes.length-1-n]-1)*100;
        return roc>0.5?1:roc<-0.5?-1:0;
    },
    squeeze({data}){
        if(data.length<32)return 0;
        const cls=data.map(d=>d.close),sl=cls.slice(-20);
        const m=sl.reduce((a,b)=>a+b,0)/20;
        const hh=Math.max(...data.slice(-20).map(d=>d.high)),ll=Math.min(...data.slice(-20).map(d=>d.low));
        const val=cls[cls.length-1]-((hh+ll)/2+m)/2;
        return val>0?1:val<0?-1:0;
    },
    // â”€â”€ Volume â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    vwap({data}){
        if(data.length<5)return 0;
        let cpv=0,cv=0;
        for(const d of data){const tp=(d.high+d.low+d.close)/3;cpv+=tp*d.volume;cv+=d.volume;}
        const vw=cpv/cv,c=data[data.length-1].close;
        return c<vw*0.999?1:c>vw*1.001?-1:0;
    },
    obv({data}){
        if(data.length<10)return 0;
        let o=0;const arr=[0];
        for(let i=1;i<data.length;i++){o+=data[i].close>data[i-1].close?data[i].volume:data[i].close<data[i-1].close?-data[i].volume:0;arr.push(o);}
        const r=arr.slice(-5);return r[4]-r[0]>0?1:-1;
    },
    cmf({data}){
        if(data.length<23)return 0;
        const sl=data.slice(-21);let n=0,de=0;
        for(const d of sl){const hl=d.high-d.low;if(!hl)continue;n+=((d.close-d.low)-(d.high-d.close))/hl*d.volume;de+=d.volume;}
        const v=de?n/de:0;return v>0.05?1:v<-0.05?-1:0;
    },
    mfi({data}){
        if(data.length<16)return 0;
        const sl=data.slice(-15);let pos=0,neg=0;
        for(let i=1;i<sl.length;i++){const tp=(sl[i].high+sl[i].low+sl[i].close)/3,ptp=(sl[i-1].high+sl[i-1].low+sl[i-1].close)/3,mf=tp*sl[i].volume;if(tp>ptp)pos+=mf;else if(tp<ptp)neg+=mf;}
        const r=neg===0?100:100-100/(1+pos/neg);
        return r<20?1:r>80?-1:0;
    },
    // â”€â”€ Volatility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    bb({closes}){
        if(closes.length<22)return 0;
        const sl=closes.slice(-20),m=sl.reduce((a,b)=>a+b,0)/20,sd=std(sl),c=closes[closes.length-1];
        return c<m-2*sd?1:c>m+2*sd?-1:0;
    },
    keltner({data}){
        if(data.length<22)return 0;
        const cls=data.map(d=>d.close),em=emaLast(cls.slice(-20),20);
        let atr=0;const sl=data.slice(-11);
        for(let i=1;i<sl.length;i++)atr=(atr*9+trv(sl[i].high,sl[i].low,sl[i-1].close))/10;
        const c=cls[cls.length-1];
        return c<em-2*atr?1:c>em+2*atr?-1:0;
    },
    donchian({data}){
        // Donchian Channel breakout â€” upper/lower and midpoint bias
        if(data.length<22)return 0;
        const sl=data.slice(-20);
        const hi=Math.max(...sl.map(d=>d.high)),lo=Math.min(...sl.map(d=>d.low));
        const mid=(hi+lo)/2,c=data[data.length-1].close;
        // Price breaking channel = continuation; near midpoint = mild bias
        if(c>=hi*0.999)return 1;
        if(c<=lo*1.001)return -1;
        return c>mid?1:-1;
    },
    // â”€â”€ Statistical â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    zscore({closes}){
        if(closes.length<22)return 0;
        const sl=closes.slice(-20),m=sl.reduce((a,b)=>a+b,0)/20,sd=std(sl)||1;
        const z=(closes[closes.length-1]-m)/sd;
        return z<-2?1:z>2?-1:0;
    },
    lrchannel({closes}){
        if(closes.length<50)return 0;
        const n=Math.min(100,closes.length),sl=closes.slice(-n);
        let sx=0,sy=0,sxy=0,sx2=0;
        for(let i=0;i<n;i++){sx+=i;sy+=sl[i];sxy+=i*sl[i];sx2+=i*i;}
        const D=n*sx2-sx*sx,slope=D?((n*sxy-sx*sy)/D):0,ic=(sy-slope*sx)/n;
        const fit=slope*(n-1)+ic,rsd=Math.sqrt(sl.reduce((a,b,i)=>a+(b-(ic+slope*i))**2,0)/n);
        const c=closes[closes.length-1];
        return c<fit-rsd?1:c>fit+rsd?-1:0;
    },
};

// â”€â”€ SEARCH â”€â”€
function bindSearch(inId,dropId,onSel){
    const inp=document.getElementById(inId),drop=document.getElementById(dropId);
    inp.addEventListener('input',()=>{
        const q=inp.value.toUpperCase().trim();
        if(!q){drop.classList.remove('show');return;}
        const m=symbols.filter(s=>s.symbol.includes(q)||s.base.includes(q)).slice(0,25);
        drop.innerHTML=m.map(s=>`<div class="sdrop-item" onclick="${onSel}('${s.symbol}')"><span style="font-weight:700">${s.symbol}</span><span style="color:var(--text-muted);font-size:10px">${s.base}/${s.quote}</span></div>`).join('')||'<div class="sdrop-item" style="color:#3a424e">No results</div>';
        drop.classList.add('show');
    });
    document.addEventListener('click',e=>{if(!e.target.closest(`#${inId}`)&&!e.target.closest(`#${dropId}`))drop.classList.remove('show');});
}

function switchTab(tab){
    ['backtest','live','docs'].forEach(t=>{
        document.getElementById(`mtab-${t}`).classList.remove('active');
        document.getElementById(`tab-${t}`).classList.remove('active');
    });
    document.getElementById(`mtab-${tab}`).classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');
    if(tab==='docs')renderDocs();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB 1 â€” BACKTEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let btSym=null,btResults=null,btSortKey='accuracy',btSortDir=-1;
bindSearch('bt-sym','bt-sym-drop','btSel');
function btSel(sym){btSym=sym;document.getElementById('bt-sym').value=sym;document.getElementById('bt-sym-drop').classList.remove('show');document.getElementById('bt-sym-sel').textContent='âœ“ '+sym;document.getElementById('bt-sym-sel').style.color='#0ecb81';document.getElementById('bt-run').disabled=false;document.getElementById('hdr-symbol').textContent=sym;}
(()=>{const chips=document.getElementById('bt-chips');chips.innerHTML=ALGOS.map(a=>`<div class="algo-chip active" id="bc-${a.key}" onclick="btChip('${a.key}',this)">${a.name}</div>`).join('');})();
function btChip(k,el){btActive.has(k)?btActive.delete(k):btActive.add(k);el.classList.toggle('active');}
function btAll(on){ALGOS.forEach(a=>{on?btActive.add(a.key):btActive.delete(a.key);const el=document.getElementById(`bc-${a.key}`);on?el.classList.add('active'):el.classList.remove('active');});}
function updateBtLbl(){const tf=document.getElementById('bt-tf').value,h=parseInt(document.getElementById('bt-horizon').value)||1;const mins={'1m':1,'5m':5,'15m':15,'30m':30,'1h':60,'4h':240,'1d':1440};const t=(mins[tf]||60)*h;document.getElementById('bt-horizon-lbl').textContent=`â‰ˆ ${t<60?t+'m':t<1440?(t/60).toFixed(1)+'h':(t/1440).toFixed(1)+'d'} lookahead`;}
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
function btLog(msg,cls=''){const el=document.getElementById('bt-log');const d=document.createElement('div');if(cls)d.className='log-'+cls;d.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;el.appendChild(d);el.scrollTop=el.scrollHeight;}
function btProg(pct,lbl){document.getElementById('bt-fill').style.width=pct+'%';document.getElementById('bt-prog-lbl').textContent=lbl;document.getElementById('bt-prog-pct').textContent=pct+'%';}

async function runBT(){
    if(!btSym)return;
    const tf=document.getElementById('bt-tf').value,limit=+document.getElementById('bt-limit').value;
    const horizon=Math.max(1,+document.getElementById('bt-horizon').value||5);
    const warmup=Math.max(50,+document.getElementById('bt-warmup').value||100);
    const chosen=ALGOS.filter(a=>btActive.has(a.key));
    if(!chosen.length){alert('Select at least one algorithm.');return;}
    document.getElementById('bt-idle').style.display='none';document.getElementById('bt-results').style.display='none';
    document.getElementById('bt-running').style.display='block';document.getElementById('bt-run').disabled=true;
    document.getElementById('bt-log').innerHTML='';btProg(0,'Fetching klinesâ€¦');btLog(`Fetching ${limit}Ã—${tf} for ${btSym}â€¦`);
    let raw;try{raw=await fetch(`${API}/klines?symbol=${btSym}&interval=${tf}&limit=${limit}`).then(r=>r.json());}catch(e){btLog('Network error: '+e.message,'err');document.getElementById('bt-run').disabled=false;return;}
    if(!Array.isArray(raw)||raw.length<warmup+horizon+10){btLog('Insufficient data','err');document.getElementById('bt-run').disabled=false;return;}
    const data=raw.map(k=>({time:+k[0]/1000|0,open:+k[1],high:+k[2],low:+k[3],close:+k[4],volume:+k[5]}));
    btLog(`Loaded ${data.length} candles`,'ok');
    const acc={};chosen.forEach(a=>{acc[a.key]={name:a.name,group:a.group,key:a.key,signals:0,correct:0,returns:[],maxStreak:0,curStreak:0};});
    const te=data.length-horizon-1;
    for(let i=warmup;i<=te;i++){
        const sub=data.slice(0,i+1),cls=sub.map(d=>d.close);
        const actual=data[i+horizon].close>data[i].close?1:-1;
        const ret=(data[i+horizon].close-data[i].close)/data[i].close*100;
        for(const algo of chosen){
            let sig;try{sig=SIG[algo.key]({data:sub,closes:cls});}catch(_){sig=0;}
            if(!sig)continue;const r=acc[algo.key];r.signals++;
            const ok=sig===actual;
            if(ok){r.correct++;r.curStreak++;r.maxStreak=Math.max(r.maxStreak,r.curStreak);r.returns.push(Math.abs(ret));}
            else{r.curStreak=0;r.returns.push(-Math.abs(ret));}
        }
        if(i%50===0||i===te){btProg(Math.round(((i-warmup)/(te-warmup))*100),`Tested ${i-warmup}/${te-warmup}â€¦`);await sleep(0);}
    }
    btLog('Processingâ€¦','ok');
    btResults=chosen.map(a=>{
        const r=acc[a.key],acc2=r.signals?r.correct/r.signals*100:0;
        const rets=r.returns,avg=rets.length?rets.reduce((a,b)=>a+b,0)/rets.length:0;
        const sd=rets.length>1?std(rets):1;const sh=sd>0?(avg/sd)*Math.sqrt(252):0;
        const g=acc2>=70?'S':acc2>=60?'A':acc2>=55?'B':acc2>=50?'C':'D';
        return{...r,accuracy:acc2,avgReturn:avg,sharpe:sh,grade:g};
    }).sort((a,b)=>b.accuracy-a.accuracy).map((r,i)=>({...r,rank:i+1}));
    btLog(`Best: ${btResults[0].name} @ ${btResults[0].accuracy.toFixed(1)}%`,'ok');
    renderBT(data,horizon,warmup);
    document.getElementById('bt-running').style.display='none';document.getElementById('bt-results').style.display='block';
    document.getElementById('bt-run').disabled=false;document.getElementById('bt-csv').style.display='inline-block';
    document.getElementById('bt-filter').oninput=()=>{const q=document.getElementById('bt-filter').value.toLowerCase();renderBTTable(btResults.filter(r=>r.name.toLowerCase().includes(q)));};
}

function renderBT(data,horizon,warmup){
    const tot=btResults.reduce((a,r)=>a+r.signals,0),cor=btResults.reduce((a,r)=>a+r.correct,0),ov=tot?(cor/tot*100):0;
    document.getElementById('bt-stats').innerHTML=[{val:btResults.length,lbl:'Algorithms',c:'#fcd535'},{val:tot.toLocaleString(),lbl:'Total Signals',c:'#29b6f6'},{val:ov.toFixed(1)+'%',lbl:'Ensemble Acc',c:ov>=55?'#0ecb81':ov>=50?'#fcd535':'#f6465d'},{val:btResults[0].name.split(' ')[0],lbl:`Best(${btResults[0].accuracy.toFixed(1)}%)`,c:'#0ecb81'}].map(s=>`<div class="stat-box"><div class="stat-val" style="color:${s.c}">${s.val}</div><div class="stat-lbl">${s.lbl}</div></div>`).join('');
    const lastData=data.slice(-102),lc=lastData.map(d=>d.close);
    let b=0,s=0,n=0;btResults.forEach(r=>{try{const sig=SIG[r.key]({data:lastData,closes:lc});if(sig===1)b++;else if(sig===-1)s++;else n++;}catch(_){}});
    const tot2=b+s+n,dom=b>s?'BUY':s>b?'SELL':'NEUTRAL',dc=dom==='BUY'?'#0ecb81':dom==='SELL'?'#f6465d':'#fcd535';
    document.getElementById('bt-ensemble').innerHTML=`<div><div class="label" style="margin-bottom:4px">Ensemble Signal (current)</div><div class="esig" style="color:${dc}">${dom}</div></div><div style="margin-left:auto;text-align:right"><div class="label">Confidence</div><div style="font-size:22px;font-weight:800">${tot2?Math.round(Math.max(b,s,n)/tot2*100):0}%</div><div style="font-size:10px;color:#3a424e;margin-top:4px">ğŸŸ¢Ã—${b} ğŸ”´Ã—${s} âšªÃ—${n}</div></div>`;
    const top3=btResults.slice(0,3),cols=['#fcd535','#0ecb81','#29b6f6'];
    const cv=document.getElementById('bt-equity');const ctx=cv.getContext('2d');const W=cv.offsetWidth||660,H=160;cv.width=W;cv.height=H;
    const curves=top3.map(algo=>{let eq=[1];for(let i=warmup;i<=data.length-horizon-2;i++){const sub=data.slice(0,i+1),cls=sub.map(d=>d.close);let sig;try{sig=SIG[algo.key]({data:sub,closes:cls});}catch(_){sig=0;}if(sig){const ret=(data[i+horizon].close-data[i].close)/data[i].close;eq.push(eq[eq.length-1]*(1+sig*ret));}else eq.push(eq[eq.length-1]);}return eq;});
    const all=curves.flat(),minV=Math.min(...all),maxV=Math.max(...all),rng=(maxV-minV)||0.01;
    ctx.fillStyle='#11151c';ctx.fillRect(0,0,W,H);
    const zy=H-8-((1-minV)/rng)*(H-20);ctx.strokeStyle='#2b3139';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(0,zy);ctx.lineTo(W,zy);ctx.stroke();ctx.setLineDash([]);
    curves.forEach((c,ci)=>{ctx.strokeStyle=cols[ci];ctx.lineWidth=ci===0?2:1.5;ctx.beginPath();c.forEach((v,i)=>{const x=(i/c.length)*W,y=H-8-((v-minV)/rng)*(H-20);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.stroke();});
    document.getElementById('bt-eq-legend').innerHTML=top3.map((a,i)=>`<span style="color:${cols[i]}">â— ${a.name}</span>`).join('');
    renderBTTable(btResults);
}

function renderBTTable(rows){
    document.getElementById('bt-body').innerHTML=rows.map(r=>{
        const bw=Math.min(100,r.accuracy),bc=r.accuracy>=65?'#0ecb81':r.accuracy>=55?'#fcd535':r.accuracy>=50?'#ff7043':'#f6465d';
        const rc=r.rank===1?'#fcd535':r.rank===2?'#c0c0c0':r.rank===3?'#cd7f32':'#2b3139';
        return`<tr><td><span class="rank-badge" style="background:${rc}22;color:${rc}">#${r.rank}</span></td><td><div style="font-weight:700">${r.name}</div><div style="font-size:10px;color:var(--text-muted)">${r.group}</div></td><td style="font-family:'Courier New',monospace;color:var(--text-muted)">${r.signals.toLocaleString()}</td><td style="color:#0ecb81;font-family:'Courier New',monospace">${r.correct.toLocaleString()}</td><td style="font-weight:700;color:${bc};font-family:'Courier New',monospace">${r.accuracy.toFixed(1)}%</td><td><div class="acc-bar-wrap"><div class="acc-bar" style="width:${bw}%;background:${bc}"></div></div></td><td style="color:${r.avgReturn>=0?'#0ecb81':'#f6465d'};font-family:'Courier New',monospace">${r.avgReturn>=0?'+':''}${r.avgReturn.toFixed(3)}%</td><td style="color:${r.sharpe>=1?'#0ecb81':r.sharpe>=0?'#fcd535':'#f6465d'};font-family:'Courier New',monospace">${r.sharpe.toFixed(2)}</td><td class="col-streak" style="color:var(--text-muted);font-family:'Courier New',monospace">${r.maxStreak}</td><td><span class="grade grade-${r.grade}">${r.grade}</span></td></tr>`;
    }).join('');
}
function btSort(k){if(btSortKey===k)btSortDir*=-1;else{btSortKey=k;btSortDir=-1;}renderBTTable([...btResults].sort((a,b)=>{const va=a[k],vb=b[k];return typeof va==='string'?va.localeCompare(vb)*btSortDir:(va-vb)*btSortDir;}));}
function exportBT(){if(!btResults)return;const rows=['Rank,Algorithm,Group,Signals,Correct,Accuracy%,AvgReturn%,Sharpe,BestStreak,Grade'];btResults.forEach(r=>rows.push(`${r.rank},"${r.name}","${r.group}",${r.signals},${r.correct},${r.accuracy.toFixed(2)},${r.avgReturn.toFixed(4)},${r.sharpe.toFixed(3)},${r.maxStreak},${r.grade}`));dlCSV(rows.join('\n'),`bt_${btSym}_${Date.now()}.csv`);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB 2 â€” LIVE PAPER TRADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lvSym=null,lvSess=null,lvEqHist=[],lvRoundLog=[],cdInt=null;
bindSearch('lv-sym','lv-sym-drop','lvSel');
function lvSel(sym){lvSym=sym;document.getElementById('lv-sym').value=sym;document.getElementById('lv-sym-drop').classList.remove('show');document.getElementById('lv-sym-sel').textContent='âœ“ '+sym;document.getElementById('lv-sym-sel').style.color='#0ecb81';document.getElementById('lv-start').disabled=false;document.getElementById('hdr-symbol').textContent=sym;updateLvPerAlgo();}
(()=>{const chips=document.getElementById('lv-chips');chips.innerHTML=ALGOS.map(a=>`<div class="algo-chip active" id="lc-${a.key}" onclick="lvChip('${a.key}',this)">${a.name}</div>`).join('');})();
function lvChip(k,el){lvActive.has(k)?lvActive.delete(k):lvActive.add(k);el.classList.toggle('active');updateLvPerAlgo();}
function lvAll(on){ALGOS.forEach(a=>{on?lvActive.add(a.key):lvActive.delete(a.key);const el=document.getElementById(`lc-${a.key}`);on?el.classList.add('active'):el.classList.remove('active');});updateLvPerAlgo();}
function updateLvDuration(){const tf=document.getElementById('lv-tf').value,r=+document.getElementById('lv-rounds').value||10;const mins={'1m':1,'3m':3,'5m':5,'15m':15,'30m':30};const t=(mins[tf]||1)*r;document.getElementById('lv-dur-lbl').textContent=`â‰ˆ ${t<60?t+' min':(t/60).toFixed(1)+' h'} total`;}
function updateLvPerAlgo(){const n=lvActive.size||1,amt=+document.getElementById('lv-amount').value||100,cur=document.getElementById('lv-cur').value,per=(amt/n).toFixed(2);document.getElementById('lv-per-algo').textContent=`${per} ${cur} / algo`;document.getElementById('lv-usdt-eq').textContent=`â‰ˆ ${toUSDT(amt,cur).toFixed(4)} USDT total`;}
function lvLog(msg,cls=''){const el=document.getElementById('lv-log');const d=document.createElement('div');if(cls)d.className='log-'+cls;d.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;el.appendChild(d);el.scrollTop=el.scrollHeight;}
function setPhase(icon,txt,col='#fcd535'){document.getElementById('lv-phase-icon').textContent=icon;document.getElementById('lv-phase-txt').textContent=txt;document.getElementById('lv-phase').style.borderColor=col+'55';document.getElementById('lv-phase').style.background=col+'12';}
function startCD(secs){clearInterval(cdInt);const ring=document.getElementById('lv-cd-ring'),num=document.getElementById('lv-cd-num'),circ=163.4;let rem=secs;function tick(){ring.style.strokeDashoffset=(circ*(1-rem/secs)).toFixed(2);const m=Math.floor(rem/60).toString().padStart(2,'0'),s=(rem%60).toString().padStart(2,'0');num.textContent=rem>=60?`${m}:${s}`:`${rem}s`;if(rem>0)rem--;}tick();cdInt=setInterval(tick,1000);}
function stopCD(){clearInterval(cdInt);document.getElementById('lv-cd-ring').style.strokeDashoffset='0';document.getElementById('lv-cd-num').textContent='--';}

async function fetchKlines(sym,tf,limit=200){const r=await fetch(`${API}/klines?symbol=${sym}&interval=${tf}&limit=${limit}`);const d=await r.json();return d.map(k=>({time:+k[0]/1000|0,open:+k[1],high:+k[2],low:+k[3],close:+k[4],volume:+k[5]}));}

async function startSession(){
    if(!lvSym)return;
    const chosen=ALGOS.filter(a=>lvActive.has(a.key));
    if(!chosen.length){alert('Select at least one algorithm.');return;}
    const tf=document.getElementById('lv-tf').value;
    const totalRounds=+document.getElementById('lv-rounds').value||10;
    const amount=+document.getElementById('lv-amount').value||100;
    const currency=document.getElementById('lv-cur').value;
    const allocMode=document.getElementById('lv-alloc').value;
    const perAlgo=amount/chosen.length;
    lvSess={sym:lvSym,tf,totalRounds,amount,currency,perAlgo,round:0,running:true,algos:{}};
    chosen.forEach(a=>{
        let bal=perAlgo;
        if(allocMode==='weighted'&&btResults){const f=btResults.find(r=>r.key===a.key);if(f)bal=amount*(f.accuracy/100)/chosen.reduce((s,b2)=>{const g=btResults.find(r=>r.key===b2.key);return s+(g?g.accuracy/100:0.5);},0);}
        // Clamp to minimum 1 unit so no algo starts with 0 balance in weighted mode
        bal=Math.max(bal,0.0001);
        lvSess.algos[a.key]={name:a.name,group:a.group,key:a.key,balance:bal,startingBalance:bal,trades:0,wins:0,losses:0,flats:0,currentSignal:0,entryPrice:0,pendingVerify:false,history:[]};
    });
    lvEqHist=[{round:0,total:amount}];lvRoundLog=[];
    document.getElementById('lv-idle').style.display='none';document.getElementById('lv-done').style.display='none';
    document.getElementById('lv-session').style.display='block';document.getElementById('lv-start').style.display='none';
    document.getElementById('lv-stop').style.display='block';document.getElementById('lv-log').innerHTML='';
    document.getElementById('lv-history').innerHTML='';
    renderCards();updatePortHdr();
    lvLog(`Session started: ${lvSym} ${tf} | ${chosen.length} algos | ${amount} ${currency}`,'ok');
    if(allocMode==='weighted'&&btResults){
        lvLog(`Allocation: WEIGHTED (backtest-accuracy weighted). Balances differ per algo.`,'info');
        const sorted=Object.values(lvSess.algos).sort((a,b)=>b.startingBalance-a.startingBalance);
        lvLog(`  Top: ${sorted[0].name} = ${sorted[0].startingBalance.toFixed(2)} ${currency}`);
        lvLog(`  Bottom: ${sorted[sorted.length-1].name} = ${sorted[sorted.length-1].startingBalance.toFixed(2)} ${currency}`);
    } else {
        lvLog(`Allocation: EQUAL â€” ${perAlgo.toFixed(2)} ${currency} per algo`,'info');
    }
    await runRound();
}

async function runRound(){
    if(!lvSess||!lvSess.running)return;
    const s=lvSess;s.round++;
    document.getElementById('lv-round-disp').textContent=`${s.round}/${s.totalRounds}`;
    document.getElementById('hdr-status').textContent=`ROUND ${s.round}`;
    setPhase('ğŸ“¡',`Round ${s.round}/${s.totalRounds} â€” Fetching market dataâ€¦`,'#fcd535');
    lvLog(`â”€â”€â”€ Round ${s.round} â”€â”€â”€`,'info');
    let data;try{data=await fetchKlines(s.sym,s.tf,200);}catch(e){lvLog('Fetch error: '+e.message,'err');s.running=false;endSession();return;}
    const closes=data.map(d=>d.close),entryPrice=closes[closes.length-1];
    lvLog(`Entry price: ${entryPrice.toFixed(6)}`);
    document.getElementById('hdr-price').textContent=entryPrice.toFixed(4);
    setPhase('ğŸ§®',`Round ${s.round} â€” Generating signalsâ€¦`,'#29b6f6');

    // Generate signals for all active algos
    Object.values(s.algos).forEach(algo=>{
        let sig=0;try{sig=SIG[algo.key]({data,closes});}catch(_){}
        algo.currentSignal=sig;algo.entryPrice=entryPrice;algo.pendingVerify=sig!==0;
        if(sig!==0)lvLog(`  ${algo.name}: ${sig===1?'â–² BUY':'â–¼ SELL'} @ ${entryPrice.toFixed(6)}`);
    });

    const activeSignals=Object.values(s.algos).filter(a=>a.pendingVerify).length;
    if(activeSignals===0){
        lvLog('No signals this round â€” all HOLD','warn');
        setPhase('â­',`Round ${s.round} â€” No signals, skipping waitâ€¦`,'#848e9c');
    } else {
        renderCards('predicting');
        const tfSecs={'1m':60,'3m':180,'5m':300,'15m':900,'30m':1800};
        const waitSecs=tfSecs[s.tf]||60;
        setPhase('â±',`Round ${s.round} â€” Waiting ${waitSecs}s for candle closeâ€¦`,'#fcd535');
        lvLog(`Waiting ${waitSecs}s for candle to closeâ€¦`);startCD(waitSecs);
        await sleep(waitSecs*1000);
        if(!lvSess||!lvSess.running)return;
        stopCD();
    }

    setPhase('âœ…',`Round ${s.round} â€” Verifying resultsâ€¦`,'#0ecb81');
    let exitData;try{exitData=await fetchKlines(s.sym,s.tf,5);}catch(_){exitData=null;}
    const exitPrice=exitData?exitData[exitData.length-1].close:entryPrice;
    const actualRet=(exitPrice-entryPrice)/entryPrice;
    const actualRetPct=(actualRet*100);

    // â”€â”€ FLAT CANDLE DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // A candle is "flat" if the price moved less than 0.001% (essentially zero)
    // Flat rounds: P&L = 0, do NOT count as win or loss (no penalty for random tie)
    const FLAT_THRESHOLD=0.00001;
    const isFlat=Math.abs(actualRet)<=FLAT_THRESHOLD;
    const actualDir=exitPrice>entryPrice?1:exitPrice<entryPrice?-1:0;

    lvLog(`Exit: ${exitPrice.toFixed(6)} | Move: ${actualRetPct>=0?'+':''}${actualRetPct.toFixed(4)}%${isFlat?' [FLAT â€” skipped]':''}`);

    let rW=0,rL=0,rFlat=0,rPnl=0;
    Object.values(s.algos).forEach(algo=>{
        if(!algo.pendingVerify)return;
        const sig=algo.currentSignal;
        if(isFlat){
            // Flat market â€” no gain, no loss, no win/loss count
            algo.flats++;
            lvLog(`  ${algo.name}: â– FLAT | Â±0.0000 ${s.currency}  (price unchanged)`,'warn');
            rFlat++;
            algo.history.push({round:s.round,sig,entryPrice,exitPrice,pnl:0,won:null,flat:true});
            return;
        }
        // Normal round â€” calculate P&L
        const pnl=sig*actualRet*algo.balance;
        const won=sig===actualDir;
        algo.balance+=pnl;
        algo.trades++;
        won?algo.wins++:algo.losses++;
        rPnl+=pnl;
        if(won)rW++;else rL++;
        // Show P&L with more precision to see small movements
        const pnlPct=(pnl/algo.balance*100);
        lvLog(`  ${algo.name}: ${won?'âœ… WIN':'âŒ LOSS'} | ${pnl>=0?'+':''}${pnl.toFixed(6)} ${s.currency} (${pnlPct>=0?'+':''}${pnlPct.toFixed(4)}%)`);
        algo.history.push({round:s.round,sig,entryPrice,exitPrice,pnl,won,flat:false});
    });

    const realTotal=Object.values(s.algos).reduce((a,b)=>a+b.balance,0);
    const totalPnlPct=((realTotal-s.amount)/s.amount*100);
    lvEqHist.push({round:s.round,total:realTotal});
    lvRoundLog.push({round:s.round,entryPrice,exitPrice,wins:rW,losses:rL,flats:rFlat,pnl:rPnl});
    const rc=rPnl>=0?'#0ecb81':'#f6465d';
    const rh=document.getElementById('lv-history');
    const row=document.createElement('div');row.className='round-row';
    const flatNote=rFlat>0?` <span style="color:#3a424e;font-size:10px">${rFlat}flat</span>`:'';
    row.innerHTML=`<span style="font-size:10px;color:var(--text-muted);width:24px;flex-shrink:0">R${s.round}</span><span style="font-size:11px;font-family:'Courier New',monospace">${entryPrice.toFixed(isFlat?6:4)}â†’${exitPrice.toFixed(isFlat?6:4)}</span><span style="margin-left:auto;font-size:11px;color:${rc};font-weight:700">${isFlat?'FLAT':(rPnl>=0?'+':'')+rPnl.toFixed(4)+' '+s.currency}</span><span style="margin-left:8px;font-size:10px;color:var(--text-muted)">W${rW}/L${rL}${flatNote}</span>`;
    rh.prepend(row);
    renderCards('verified');updatePortHdr();drawMiniEq();
    lvLog(`Round ${s.round} done. Total: ${realTotal.toFixed(4)} ${s.currency} (${totalPnlPct>=0?'+':''}${totalPnlPct.toFixed(4)}% overall)`,'ok');
    if(s.round<s.totalRounds&&s.running){setPhase('ğŸ”„',`Round ${s.round} complete. Next in 2sâ€¦`,'#0ecb81');await sleep(2000);if(s.running)await runRound();}
    else endSession();
}

function stopSession(){if(lvSess)lvSess.running=false;stopCD();lvLog('Session stopped by user.','warn');endSession();}
function endSession(){
    stopCD();if(!lvSess)return;
    const s=lvSess;document.getElementById('hdr-status').textContent='DONE';
    document.getElementById('lv-stop').style.display='none';document.getElementById('lv-start').style.display='block';
    document.getElementById('lv-start').disabled=false;document.getElementById('lv-session').style.display='none';
    document.getElementById('lv-done').style.display='block';document.getElementById('lv-csv').style.display='block';
    const finalTotal=Object.values(s.algos).reduce((a,b)=>a+b.balance,0),pnl=finalTotal-s.amount,pnlP=pnl/s.amount*100;
    const won=pnl>=0;
    document.getElementById('lv-done-emoji').textContent=pnlP>5?'ğŸ†':pnlP>0?'âœ…':pnlP>-5?'âš ï¸':'ğŸ“‰';
    document.getElementById('lv-done-title').textContent=won?'Profitable Session!':'Loss Session';
    document.getElementById('lv-done-sub').textContent=`${s.round} rounds on ${s.sym} (${s.tf}) | Started: ${s.amount} ${s.currency} â†’ Final: ${finalTotal.toFixed(4)} ${s.currency}`;
    const totT=Object.values(s.algos).reduce((a,b)=>a+b.trades,0),totW=Object.values(s.algos).reduce((a,b)=>a+b.wins,0);
    const totFlats=Object.values(s.algos).reduce((a,b)=>a+b.flats,0);
    document.getElementById('lv-done-stats').innerHTML=[
        {val:`${finalTotal.toFixed(4)} ${s.currency}`,lbl:'Final Capital',c:won?'#0ecb81':'#f6465d'},
        {val:`${pnl>=0?'+':''}${pnl.toFixed(4)} ${s.currency}`,lbl:'Net P&L',c:won?'#0ecb81':'#f6465d'},
        {val:`${pnlP>=0?'+':''}${pnlP.toFixed(4)}%`,lbl:'Return',c:won?'#0ecb81':'#f6465d'},
        {val:totT>0?((totW/totT)*100).toFixed(1)+'%':'--',lbl:'Win Rate',c:'#fcd535'},
        {val:totFlats.toLocaleString(),lbl:'Flat Rounds (skipped)',c:'#848e9c'}
    ].map(st=>`<div class="stat-box"><div class="stat-val" style="color:${st.c}">${st.val}</div><div class="stat-lbl">${st.lbl}</div></div>`).join('');
    const ranked=Object.values(s.algos).sort((a,b)=>b.balance-a.balance);
    document.getElementById('lv-standings').innerHTML=ranked.map((a,i)=>{
        const rc2=i===0?'#fcd535':i===1?'#c0c0c0':i===2?'#cd7f32':'#2b3139';
        const c=a.balance>=(a.startingBalance||s.perAlgo)?'#0ecb81':'#f6465d';
        const wr=a.trades>0?((a.wins/a.trades)*100).toFixed(0)+'%':'--';
        const flatNote=a.flats>0?` Â· ${a.flats}â†”`:'';
        return`<div class="round-row"><span class="rank-badge" style="background:${rc2}22;color:${rc2}">#${i+1}</span><span style="font-size:12px;font-weight:700;flex:1">${a.name}</span><span style="font-size:11px;color:var(--text-muted);margin-right:12px">${wr} WR Â· ${a.trades}T${flatNote}</span><span style="font-size:13px;font-weight:700;color:${c}">${a.balance.toFixed(4)} ${s.currency}</span></div>`;
    }).join('');
    drawFinalEq();
}
function resetSession(){lvSess=null;lvEqHist=[];lvRoundLog=[];document.getElementById('lv-done').style.display='none';document.getElementById('lv-idle').style.display='block';document.getElementById('lv-csv').style.display='none';}

function renderCards(phase='idle'){
    if(!lvSess)return;
    document.getElementById('lv-cards').innerHTML=Object.values(lvSess.algos).map(a=>{
        const sig=a.currentSignal,sigCls=sig===1?'signal-buy':sig===-1?'signal-sell':'signal-hold';
        const badge=sig===1?'BUY':sig===-1?'SELL':'HOLD',bdgCls=sig===1?'badge-buy':sig===-1?'badge-sell':'badge-hold';
        const sigC=sig===1?'#0ecb81':sig===-1?'#f6465d':'#fcd535';
        const pnl=a.balance-(a.startingBalance||lvSess.perAlgo),last=a.history[a.history.length-1];
        let vrCls='',emoji='';
        if(phase==='verified'&&last&&last.round===lvSess.round){
            if(last.flat){vrCls='';emoji='â–';}
            else{vrCls=last.won?'verified-win':'verified-loss';emoji=last.won?'âœ…':'âŒ';}
        }
        const wr=a.trades>0?((a.wins/a.trades)*100).toFixed(0)+'%':'--';
        const pnlDisplay=`${pnl>=0?'+':''}${Math.abs(pnl)<0.001?pnl.toFixed(6):pnl.toFixed(4)}`;
        return`<div class="algo-card ${sigCls} ${vrCls}"><div class="acard-name" title="${a.name}">${a.name}</div><div style="display:flex;align-items:center;gap:6px"><div class="acard-signal" style="color:${sigC}">${sig===0?'â€“':sig===1?'â–²':'â–¼'}</div><span class="signal-badge ${bdgCls}">${badge}</span></div><div class="acard-alloc">${a.balance.toFixed(4)} ${lvSess.currency}</div><div class="acard-pnl" style="color:${pnl>=0?'#0ecb81':'#f6465d'}">${pnlDisplay}</div><div style="display:flex;justify-content:space-between;margin-top:4px"><span style="font-size:9px;color:var(--text-muted)">W${a.wins}/L${a.losses}${a.flats?'/F'+a.flats:''}</span><span style="font-size:9px;color:var(--text-muted)">${wr} WR</span></div>${emoji?`<div class="acard-result">${emoji}</div>`:''}</div>`;
    }).join('');
}

function updatePortHdr(){
    if(!lvSess)return;const s=lvSess;
    const total=Object.values(s.algos).reduce((a,b)=>a+b.balance,0),pnl=total-s.amount;
    const pnlPct=pnl/s.amount*100;
    const totT=Object.values(s.algos).reduce((a,b)=>a+b.trades,0),totW=Object.values(s.algos).reduce((a,b)=>a+b.wins,0);
    document.getElementById('lv-total').textContent=`${total.toFixed(4)} ${s.currency}`;
    document.getElementById('lv-total').style.color=pnl>=0?'#0ecb81':'#f6465d';
    document.getElementById('lv-total-pct').textContent=`${pnlPct>=0?'+':''}${pnlPct.toFixed(4)}%`;
    document.getElementById('lv-total-pct').style.color=pnl>=0?'#0ecb81':'#f6465d';
    document.getElementById('lv-pnl').textContent=`${pnl>=0?'+':''}${pnl.toFixed(4)} ${s.currency}`;
    document.getElementById('lv-pnl').style.color=pnl>=0?'#0ecb81':'#f6465d';
    document.getElementById('lv-wr').textContent=totT>0?((totW/totT)*100).toFixed(1)+'%':'--';
}

function drawMiniEq(){
    const cv=document.getElementById('lv-eq-mini');if(!cv||lvEqHist.length<2)return;
    const ctx=cv.getContext('2d');const W=cv.offsetWidth||320,H=130;cv.width=W;cv.height=H;
    const vals=lvEqHist.map(e=>e.total),minV=Math.min(...vals),maxV=Math.max(...vals),rng=(maxV-minV)||0.0001;
    ctx.fillStyle='#11151c';ctx.fillRect(0,0,W,H);
    const by=H-8-((lvSess.amount-minV)/rng)*(H-20);ctx.strokeStyle='#2b3139';ctx.lineWidth=1;ctx.setLineDash([3,3]);ctx.beginPath();ctx.moveTo(0,by);ctx.lineTo(W,by);ctx.stroke();ctx.setLineDash([]);
    const col=vals[vals.length-1]>=lvSess.amount?'#0ecb81':'#f6465d';ctx.strokeStyle=col;ctx.lineWidth=2;ctx.beginPath();vals.forEach((v,i)=>{const x=(i/(vals.length-1||1))*W,y=H-8-((v-minV)/rng)*(H-20);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.stroke();
    // Labels
    ctx.fillStyle='#848e9c';ctx.font='9px monospace';ctx.textAlign='left';ctx.fillText(minV.toFixed(4),2,H-2);ctx.textAlign='right';ctx.fillText(maxV.toFixed(4),W-2,10);
}

function drawFinalEq(){
    const cv=document.getElementById('lv-eq-final');if(!cv||lvEqHist.length<2)return;
    const ctx=cv.getContext('2d');const W=cv.offsetWidth||600,H=160;cv.width=W;cv.height=H;
    const vals=lvEqHist.map(e=>e.total),minV=Math.min(...vals),maxV=Math.max(...vals),rng=(maxV-minV)||0.0001;
    ctx.fillStyle='#11151c';ctx.fillRect(0,0,W,H);
    const by=H-12-((lvSess.amount-minV)/rng)*(H-24);ctx.strokeStyle='#2b3139';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(0,by);ctx.lineTo(W,by);ctx.stroke();ctx.setLineDash([]);
    const col=vals[vals.length-1]>=lvSess.amount?'#0ecb81':'#f6465d';
    ctx.beginPath();vals.forEach((v,i)=>{const x=(i/(vals.length-1||1))*W,y=H-12-((v-minV)/rng)*(H-24);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fillStyle=col+'22';ctx.fill();
    ctx.beginPath();vals.forEach((v,i)=>{const x=(i/(vals.length-1||1))*W,y=H-12-((v-minV)/rng)*(H-24);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.strokeStyle=col;ctx.lineWidth=2;ctx.stroke();
    ctx.fillStyle='#848e9c';ctx.font='9px monospace';ctx.textAlign='left';ctx.fillText(minV.toFixed(4),4,H-2);ctx.textAlign='right';ctx.fillText(maxV.toFixed(4),W-4,12);
}

function exportLive(){
    if(!lvSess)return;
    const s=lvSess,rows=['Round,EntryPrice,ExitPrice,Wins,Losses,Flats,RoundPnL'];
    lvRoundLog.forEach(r=>rows.push(`${r.round},${r.entryPrice},${r.exitPrice},${r.wins},${r.losses},${r.flats||0},${r.pnl.toFixed(6)}`));
    rows.push('','Algorithm,StartBalance,FinalBalance,NetPnL,PnL%,Trades,Wins,Losses,Flats,WinRate%');
    Object.values(s.algos).forEach(a=>{const sb=a.startingBalance||s.perAlgo,pnl=a.balance-sb,pnlP=sb>0?(pnl/sb*100):0;rows.push(`"${a.name}",${sb.toFixed(6)},${a.balance.toFixed(6)},${pnl.toFixed(6)},${pnlP.toFixed(4)},${a.trades},${a.wins},${a.losses},${a.flats},${a.trades>0?((a.wins/a.trades)*100).toFixed(1):0}`);});
    dlCSV(rows.join('\n'),`live_${lvSym}_${Date.now()}.csv`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB 3 â€” ALGO DOCS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GROUP_COLORS={Trend:'#fcd535',Momentum:'#0ecb81',Volume:'#29b6f6',Volatility:'#ff7043',Statistical:'#ce93d8'};

function renderDocs(){
    filterDocs();
}

function filterDocs(){
    const q=(document.getElementById('docs-filter').value||'').toLowerCase();
    const g=(document.getElementById('docs-group').value||'');
    const filtered=ALGOS.filter(a=>{
        if(g&&a.group!==g)return false;
        if(q&&!a.name.toLowerCase().includes(q)&&!a.group.toLowerCase().includes(q))return false;
        return true;
    });
    const gc=GROUP_COLORS;
    document.getElementById('docs-grid').innerHTML=filtered.map(a=>{
        const doc=ALGO_DOCS[a.key]||{formula:'â€”',signal:'â€”',interpretation:'Documentation not available.',bestFor:'â€”'};
        const col=gc[a.group]||'#848e9c';
        return`<div class="card" style="border-top:2px solid ${col};transition:transform .15s" onmouseenter="this.style.transform='translateY(-2px)'" onmouseleave="this.style.transform=''">
            <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:12px">
                <div style="flex:1">
                    <div style="font-size:13px;font-weight:800;margin-bottom:3px">${a.name}</div>
                    <span style="font-size:9px;text-transform:uppercase;letter-spacing:.08em;background:${col}22;color:${col};padding:2px 6px;border-radius:3px">${a.group}</span>
                </div>
            </div>
            <div style="margin-bottom:10px">
                <div style="font-size:9px;text-transform:uppercase;letter-spacing:.07em;color:#3a424e;margin-bottom:4px">Formula</div>
                <div style="font-size:11px;font-family:'Courier New',monospace;background:#080a0d;border:1px solid #2b3139;border-radius:4px;padding:8px 10px;line-height:1.6;word-break:break-word;color:#c9d1d9">${doc.formula}</div>
            </div>
            <div style="margin-bottom:10px">
                <div style="font-size:9px;text-transform:uppercase;letter-spacing:.07em;color:#3a424e;margin-bottom:4px">Signal Conditions</div>
                <div style="font-size:11px;color:var(--text-muted);line-height:1.5">${doc.signal}</div>
            </div>
            <div style="margin-bottom:10px">
                <div style="font-size:9px;text-transform:uppercase;letter-spacing:.07em;color:#3a424e;margin-bottom:4px">How it works</div>
                <div style="font-size:11px;color:var(--text-main);line-height:1.6">${doc.interpretation}</div>
            </div>
            <div style="padding-top:8px;border-top:1px solid #2b3139">
                <span style="font-size:9px;text-transform:uppercase;letter-spacing:.07em;color:#3a424e">Best for: </span>
                <span style="font-size:11px;color:#fcd535">${doc.bestFor}</span>
            </div>
        </div>`;
    }).join('');
}

// â”€â”€ SHARED UTILS â”€â”€
function dlCSV(content,filename){const b=new Blob([content],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=filename;a.click();}

// Init
updateBtLbl();updateLvDuration();updateLvPerAlgo();
</script>
</body>
</html>
