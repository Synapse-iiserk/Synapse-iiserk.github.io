<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iFINN | Advanced Market Analytics</title>
    
    <!-- Libraries (Stable Version 4.0.1) -->
    <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        :root {
            --bg-dark: #0b0e11;
            --bg-panel: #1e2329;
            --bg-elev: #11151c;
            --border: #2b3139;
            --text-main: #eaecef;
            --text-muted: #848e9c;
            --primary: #fcd535; /* iFINN Yellow */
            --accent-1: #2962ff;
            --accent-2: #ff6d00;
            --accent-3: #9c27b0;
            --up: #0ecb81;
            --down: #f6465d;
        }

        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            font-family: 'Space Grotesk', 'Inter', sans-serif; 
            letter-spacing: -0.01em;
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
            margin: 0;
        }
        
        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* Layout Grid */
        .dashboard { 
            display: grid; 
            grid-template-columns: 280px 1fr 300px; 
            grid-template-rows: 60px 1fr 250px; 
            width: 100%;
            height: 100%;
            gap: 1px; 
            background-color: var(--border); 
        }
        
        /* Areas */
        .header { 
            grid-column: 1 / -1; 
            background: var(--bg-panel); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 20px; 
            z-index: 10; 
            min-height: 60px;
        }
        .sidebar { 
            grid-row: 2 / -1; 
            background: var(--bg-panel); 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            min-width: 0; /* Fix grid overflow */
            min-height: 0; /* Fix grid collapse */
        }
        .chart-area { 
            grid-column: 2 / 3; 
            grid-row: 2 / 3; 
            background: var(--bg-dark); 
            position: relative; 
            min-width: 0; /* FIX: Prevents collapse */
            min-height: 0; /* FIX: Prevents collapse */
        }
        .oscillator-area { 
            grid-column: 2 / 3; 
            grid-row: 3 / 4; 
            background: var(--bg-dark); 
            border-top: 1px solid var(--border); 
            position: relative; 
            min-width: 0; /* FIX: Prevents collapse */
            min-height: 0; /* FIX: Prevents collapse */
        }
        .right-panel { 
            grid-row: 2 / -1; 
            background: var(--bg-panel); 
            display: flex; 
            flex-direction: column; 
            min-width: 0;
            min-height: 0;
        }

        /* UI Elements */
        .search-box { position: relative; width: 300px; }
        .search-results { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            width: 100%; 
            background: var(--bg-panel); 
            border: 1px solid var(--border); 
            max-height: 300px; 
            overflow-y: auto; 
            z-index: 50; 
            display: none; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .search-item { 
            padding: 8px 12px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            font-size: 0.9rem; 
            border-bottom: 1px solid var(--border); 
            color: var(--text-main);
        }
        .search-item:hover { background: var(--border); }
        
        .btn-tool { 
            width: 100%; 
            padding: 10px; 
            text-align: left; 
            font-size: 0.85rem; 
            color: var(--text-muted); 
            border: none; 
            background: transparent; 
            cursor: pointer; 
            border-bottom: 1px solid var(--border); 
            transition: all 0.2s;
        }
        .btn-tool:hover { color: var(--primary); background: rgba(252, 213, 53, 0.05); }
        .btn-tool.active { color: var(--primary); font-weight: bold; border-left: 3px solid var(--primary); background: rgba(252, 213, 53, 0.1); }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.8rem; margin-bottom: 10px; }
        .stat-label { color: var(--text-muted); }
        .stat-val { text-align: right; font-family: monospace; }
        
        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; font-family: monospace; }
        .data-table th { text-align: left; color: var(--text-muted); padding: 4px; position: sticky; top: 0; background: var(--bg-panel); }
        .data-table td { padding: 2px 4px; }
        
        /* Loader */
        .loader-overlay { 
            position: absolute; 
            inset: 0; 
            background: rgba(11, 14, 17, 0.9); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 100; 
            backdrop-filter: blur(2px); 
        }
        .spinner { 
            width: 40px; 
            height: 40px; 
            border: 3px solid var(--border); 
            border-top-color: var(--primary); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Refresh Button Animation */
        .spin-anim { animation: spin 0.5s linear infinite; }

        /* Utility Cards & Inputs */
        .card { background: var(--bg-elev); border: 1px solid var(--border); border-radius: 10px; }
        .input-dark { background: #0f131a; border: 1px solid var(--border); border-radius: 6px; color: var(--text-main); padding: 6px 8px; font-size: 12px; width: 100%; }
        .input-dark:focus { outline: 1px solid var(--primary); border-color: var(--primary); }
        .pill { padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); background: rgba(255,255,255,0.02); font-size: 11px; }
        .chip { padding: 6px 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 11px; background: rgba(255,255,255,0.03); }
        .side-btn { flex: 1; border: 1px solid var(--border); padding: 6px 0; border-radius: 8px; font-weight: 600; font-size: 12px; background: #0f131a; color: var(--text-muted); }
        .side-btn.active { border-color: var(--primary); color: #0b0e11; background: var(--primary); }
        .cta-btn { background: var(--primary); color: #0b0e11; font-weight: 700; border-radius: 8px; padding: 8px 10px; font-size: 12px; width: 100%; }
        .text-mini { font-size: 11px; }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .dashboard { 
                grid-template-columns: 1fr; 
                grid-template-rows: 60px 1fr 150px; 
                padding-bottom: 56px; /* Space for bottom nav */
            }
            .sidebar { 
                display: none; 
                position: fixed; 
                top: 60px; 
                left: 0; 
                right: 0; 
                bottom: 56px; 
                z-index: 40; 
                background: var(--bg-panel);
            }
            .sidebar.show { display: flex; }
            .right-panel { 
                display: none; 
                position: fixed; 
                top: 60px; 
                left: 0; 
                right: 0; 
                bottom: 56px; 
                z-index: 40; 
                background: var(--bg-panel);
            }
            .right-panel.show { display: flex; }
            .chart-area { grid-column: 1 / -1; grid-row: 2 / 3; }
            .oscillator-area { grid-column: 1 / -1; grid-row: 3 / 4; }
        }
    </style>
</head>
<body>

<div class="dashboard">
    
    <!-- HEADER -->
    <header class="header">
        <div class="flex items-center gap-4">
            <button id="mobile-menu" class="lg:hidden text-gray-400">‚ò∞</button>
            <h1 class="text-2xl font-bold tracking-tighter">
                <span class="text-[#fcd535]">SYNAPSE</span> <span class="text-xs font-normal text-gray-500">BINANCE API</span>
            </h1>
        </div>

        <div class="flex items-center gap-4">
            <!-- Timeframe Selector -->
            <div class="flex bg-[#2b3139] rounded p-0.5 border border-[#474d57] hidden sm:flex">
                <button class="tf-btn px-2 py-1 text-[10px] font-bold rounded hover:bg-[#1e2329]" data-tf="1m">1M</button>
                <button class="tf-btn px-2 py-1 text-[10px] font-bold rounded hover:bg-[#1e2329]" data-tf="5m">5M</button>
                <button class="tf-btn px-2 py-1 text-[10px] font-bold rounded hover:bg-[#1e2329]" data-tf="15m">15M</button>
                <button class="tf-btn px-2 py-1 text-[10px] font-bold rounded bg-[#fcd535] text-black" data-tf="1h">1H</button>
                <button class="tf-btn px-2 py-1 text-[10px] font-bold rounded hover:bg-[#1e2329]" data-tf="4h">4H</button>
                <button class="tf-btn px-2 py-1 text-[10px] font-bold rounded hover:bg-[#1e2329]" data-tf="1d">1D</button>
            </div>

            <!-- REFRESH BUTTON -->
            <button id="refresh-btn" class="px-4 py-1.5 text-sm font-bold bg-[#2b3139] hover:bg-[#fcd535] hover:text-black rounded transition flex items-center gap-2 border border-[#474d57]">
                <span>‚Üª</span> <span class="hidden sm:inline">REFRESH DATA</span>
            </button>

            <!-- Global Search -->
            <div class="search-box">
                <input type="text" id="global-search" placeholder="Search Pairs..." 
                    class="w-full bg-[#2b3139] border border-[#474d57] rounded px-3 py-1.5 text-sm text-white focus:outline-none focus:border-[#fcd535] uppercase">
                <div id="search-results" class="search-results text-sm"></div>
            </div>

            <!-- Live Micro-Metrics -->
            <div class="hidden xl:flex items-center gap-2 text-xs font-mono">
                <div class="chip" id="chip-spread">Spread --</div>
                <div class="chip" id="chip-atr">ATR --</div>
                <div class="chip" id="chip-rr">R:R --</div>
            </div>
        </div>

        <div class="hidden md:flex items-center gap-4 text-xs font-mono">
            <div class="flex flex-col items-end">
                <span class="text-gray-500">SERVER TIME</span>
                <span id="server-time" class="text-[#fcd535]">--:--:--</span>
            </div>
            <div class="w-px h-8 bg-gray-700"></div>
            <div class="flex flex-col items-end">
                <span class="text-gray-500">API</span>
                <span class="text-green-500">‚óè CONNECTED</span>
            </div>
        </div>
    </header>

    <!-- LEFT SIDEBAR: TOOLS -->
    <aside class="sidebar p-2" id="sidebar">
        <div class="mb-4">
            <h3 class="text-xs font-bold text-gray-500 uppercase px-2 mb-2">Watchlist</h3>
            <div id="watchlist" class="space-y-1 px-1">
                <!-- Generated by JS -->
            </div>
        </div>

        <div class="mb-4">
            <h3 class="text-xs font-bold text-gray-500 uppercase px-2 mb-2">Analysis Tools</h3>
            <div id="indicator-list">
                <!-- Generated by JS -->
            </div>
        </div>

        <div class="mb-4">
            <h3 class="text-xs font-bold text-gray-500 uppercase px-2 mb-2">Chart Settings</h3>
            <button id="toggle-log" class="btn-tool">üìà Logarithmic Scale</button>
        </div>

        <!-- Trader Desk: Risk & Position Sizer -->
        <div class="mb-4 card p-3 space-y-2">
            <div class="flex items-center justify-between text-xs text-gray-400">
                <span class="font-semibold">Trade Planner</span>
                <button id="risk-reset" class="text-[10px] text-gray-500 hover:text-[#fcd535]">reset</button>
            </div>
            <div class="grid grid-cols-2 gap-2 text-mini">
                <div class="flex flex-col gap-1">
                    <span class="text-gray-500">Balance ($)</span>
                    <input id="risk-balance" type="number" value="1000" class="input-dark" min="0" step="10">
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-gray-500">Risk %</span>
                    <input id="risk-percent" type="number" value="1" class="input-dark" min="0" step="0.1">
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-gray-500">Entry</span>
                    <input id="risk-entry" type="number" class="input-dark" step="0.1">
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-gray-500">Stop</span>
                    <input id="risk-stop" type="number" class="input-dark" step="0.1">
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-gray-500">Take Profit</span>
                    <input id="risk-tp" type="number" class="input-dark" step="0.1">
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-gray-500">Leverage</span>
                    <input id="risk-lev" type="number" value="5" class="input-dark" min="1" max="125" step="1">
                </div>
            </div>
            <div class="flex gap-2">
                <button class="side-btn active" data-side="long" id="risk-long">Long</button>
                <button class="side-btn" data-side="short" id="risk-short">Short</button>
            </div>
            <div class="grid grid-cols-2 gap-2 text-mini font-mono text-gray-200" id="risk-summary">
                <div class="flex flex-col">
                    <span class="text-gray-500">Size (USDT)</span>
                    <span id="risk-size">-</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-gray-500">Qty</span>
                    <span id="risk-qty">-</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-gray-500">Liq Est.</span>
                    <span id="risk-liq">-</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-gray-500">R:R</span>
                    <span id="risk-rr">-</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-gray-500">Risk $</span>
                    <span id="risk-dollar">-</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-gray-500">TP PnL</span>
                    <span id="risk-pnl">-</span>
                </div>
            </div>
        </div>

        <!-- Price Alert -->
        <div class="mb-4 card p-3 space-y-2">
            <div class="flex items-center justify-between text-xs text-gray-400">
                <span class="font-semibold">Price Alert</span>
                <button id="alert-clear" class="text-[10px] text-gray-500 hover:text-[#fcd535]">clear</button>
            </div>
            <div class="flex gap-2">
                <input id="alert-price" type="number" class="input-dark" placeholder="Set alert price" step="0.1">
                <button id="alert-set" class="cta-btn">Set</button>
            </div>
            <div id="alert-status" class="text-mini text-gray-500">No active alert</div>
        </div>
        
        <div class="mt-auto p-2 border-t border-[#2b3139]">
            <div class="text-xs text-gray-500 mb-1">iFINN v2.1</div>
            <div class="text-[10px] text-gray-600">High-Frequency Market Data</div>
        </div>
    </aside>

    <!-- MAIN CHART AREA -->
    <main class="chart-area">
        <div id="chart-loader" class="loader-overlay">
            <div class="spinner"></div>
            <div class="mt-2 text-sm text-[#fcd535]" id="loader-text">Initializing Stream...</div>
        </div>
        <!-- Legend -->
        <div id="chart-legend" class="absolute top-4 left-4 z-20 pointer-events-none bg-black/40 p-2 rounded backdrop-blur-sm text-[10px] font-mono space-y-1">
            <div class="flex gap-3">
                <span id="leg-symbol" class="font-bold text-white">BTCUSDT</span>
                <span id="leg-interval" class="text-gray-400">1H</span>
            </div>
            <div class="flex gap-2">
                <span>O: <span id="leg-o" class="text-white">--</span></span>
                <span>H: <span id="leg-h" class="text-white">--</span></span>
                <span>L: <span id="leg-l" class="text-white">--</span></span>
                <span>C: <span id="leg-c" class="text-white">--</span></span>
                <span id="leg-chg" class="text-white">--</span>
            </div>
            <div id="leg-indicators" class="flex flex-wrap gap-x-3 gap-y-1"></div>
        </div>
        <!-- Important: Explicit height/width set via CSS, but JS needs to read it -->
        <div id="main-chart" style="width: 100%; height: 100%;"></div>
    </main>

    <!-- BOTTOM OSCILLATORS -->
    <section class="oscillator-area">
        <div id="oscillator-chart" style="width: 100%; height: 100%;"></div>
    </section>

    <!-- RIGHT PANEL: ORDER BOOK & TRADES -->
    <aside class="right-panel border-l border-[#2b3139]">
        
        <!-- Tabs -->
        <div class="flex border-b border-[#2b3139]">
            <button class="flex-1 py-2 text-[10px] font-bold text-[#fcd535] border-b-2 border-[#fcd535]" id="tab-ob">Book</button>
            <button class="flex-1 py-2 text-[10px] font-bold text-gray-500 hover:text-gray-300" id="tab-trades">Trades</button>
            <button class="flex-1 py-2 text-[10px] font-bold text-gray-500 hover:text-gray-300" id="tab-info">Details</button>
            <button class="flex-1 py-2 text-[10px] font-bold text-gray-500 hover:text-gray-300" id="tab-sentiment">Senti.</button>
            <button class="flex-1 py-2 text-[10px] font-bold text-gray-500 hover:text-gray-300" id="tab-stats">Stats</button>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-hidden relative" id="panel-content">
            
            <!-- ORDER BOOK -->
            <div id="view-ob" class="h-full flex flex-col p-2">
                <div class="flex justify-between text-[10px] text-gray-500 px-1 mb-1">
                    <span>PRICE</span><span>AMOUNT</span><span>TOTAL</span>
                </div>
                <div class="flex-1 overflow-hidden flex flex-col">
                    <div id="ob-asks" class="flex flex-col justify-end text-[#f6465d] text-xs font-mono h-full"></div>
                    <div id="current-price" class="py-1 text-center text-lg font-bold font-mono my-1">--</div>
                    <div id="ob-bids" class="text-[#0ecb81] text-xs font-mono h-full"></div>
                </div>
            </div>

            <!-- RECENT TRADES -->
            <div id="view-trades" class="h-full hidden flex flex-col">
                <div class="flex justify-between text-[10px] text-gray-500 px-1 py-1 bg-[#1e2329]">
                    <span>TIME</span><span>PRICE</span><span>AMOUNT</span>
                </div>
                <div id="trades-list" class="overflow-y-auto flex-1 font-mono text-xs"></div>
            </div>

            <!-- SENTIMENT / FEAR & GREED -->
            <div id="view-sentiment" class="h-full hidden p-3 overflow-y-auto space-y-3">
                <!-- Fear & Greed Gauge -->
                <div class="card p-3 text-center space-y-2">
                    <div class="text-[10px] text-gray-500 font-semibold tracking-widest">CRYPTO FEAR &amp; GREED</div>
                    <div id="fg-gauge" class="relative mx-auto" style="width:110px;height:62px;">
                        <svg viewBox="0 0 110 62" width="110" height="62">
                            <path d="M10,55 A45,45 0 0,1 100,55" fill="none" stroke="#2b3139" stroke-width="10" stroke-linecap="round"/>
                            <path id="fg-arc" d="M10,55 A45,45 0 0,1 100,55" fill="none" stroke="#f6465d" stroke-width="10" stroke-linecap="round" stroke-dasharray="0 141.4"/>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-end pb-1">
                            <span id="fg-value" class="text-2xl font-bold font-mono text-white">--</span>
                        </div>
                    </div>
                    <div id="fg-label" class="text-sm font-bold text-gray-400">Loading...</div>
                    <div id="fg-updated" class="text-[10px] text-gray-600"></div>
                </div>
                <!-- Historical F&G (7d) -->
                <div class="card p-3">
                    <div class="text-[10px] text-gray-500 font-semibold tracking-widest mb-2">HISTORY (7d)</div>
                    <div id="fg-history" class="space-y-1"></div>
                </div>
                <!-- Live CoinGecko Prices -->
                <div class="card p-3">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-[10px] text-gray-500 font-semibold tracking-widest">LIVE MARKET</div>
                        <div id="cg-updated" class="text-[10px] text-gray-600"></div>
                    </div>
                    <div id="cg-coins" class="space-y-1.5"></div>
                </div>
                <!-- BTC Dominance -->
                <div class="card p-3">
                    <div class="text-[10px] text-gray-500 font-semibold tracking-widest mb-2">BTC DOMINANCE</div>
                    <div class="flex items-center gap-2">
                        <div class="flex-1 h-2 bg-[#2b3139] rounded-full overflow-hidden">
                            <div id="dom-bar" class="h-full rounded-full bg-[#fcd535] transition-all duration-700" style="width:0%"></div>
                        </div>
                        <span id="dom-pct" class="text-xs font-mono font-bold text-[#fcd535] w-10 text-right">--</span>
                    </div>
                </div>
            </div>

            <!-- DETAILS -->
            <div id="view-info" class="h-full hidden p-4 overflow-y-auto">
                <div class="stat-grid">
                    <div class="stat-label">24h Change</div><div class="stat-val" id="info-change">-</div>
                    <div class="stat-label">24h High</div><div class="stat-val" id="info-high">-</div>
                    <div class="stat-label">24h Low</div><div class="stat-val" id="info-low">-</div>
                    <div class="stat-label">Volume (Base)</div><div class="stat-val" id="info-vol">-</div>
                    <div class="stat-label">Volume (Quote)</div><div class="stat-val" id="info-qvol">-</div>
                    <div class="stat-label">Trades (24h)</div><div class="stat-val" id="info-trades">-</div>
                </div>
                <div class="border-t border-[#2b3139] pt-2 mt-2">
                    <h4 class="text-xs font-bold text-gray-500 mb-2">INDICATOR VALUES</h4>
                    <div class="space-y-1 text-xs font-mono">
                        <div class="flex justify-between"><span>RSI (14):</span><span id="val-rsi" class="text-[#fcd535]">-</span></div>
                        <div class="flex justify-between"><span>MACD:</span><span id="val-macd" class="text-[#2962ff]">-</span></div>
                        <div class="flex justify-between"><span>SMA (20):</span><span id="val-sma" class="text-[#ff6d00]">-</span></div>
                        <div class="flex justify-between"><span>ATR (14):</span><span id="val-atr" class="text-white">-</span></div>
                    </div>
                </div>

                <div class="border-t border-[#2b3139] pt-2 mt-2">
                    <h4 class="text-xs font-bold text-gray-500 mb-2">SESSION METRICS</h4>
                    <div class="space-y-1 text-xs font-mono">
                        <div class="flex justify-between"><span>Spread</span><span id="metric-spread" class="text-[#fcd535]">-</span></div>
                        <div class="flex justify-between"><span>Best Bid / Ask</span><span id="metric-bbo" class="text-gray-200">-</span></div>
                        <div class="flex justify-between"><span>Last Price</span><span id="metric-mark" class="text-gray-200">-</span></div>
                        <div class="flex justify-between"><span>WS Latency</span><span id="metric-latency" class="text-gray-200">-</span></div>
                        <div class="flex justify-between"><span>Last Update</span><span id="metric-updated" class="text-gray-200">-</span></div>
                    </div>
                </div>
            </div>

            <!-- STATS PANEL -->
            <div id="view-stats" class="h-full hidden p-3 overflow-y-auto space-y-3">
                <!-- Returns Distribution Histogram -->
                <div class="card p-3">
                    <div class="text-[10px] text-gray-500 font-semibold tracking-widest mb-2">LOG-RETURNS DISTRIBUTION</div>
                    <canvas id="returns-canvas" width="260" height="100" style="width:100%;height:100px;border-radius:4px;"></canvas>
                </div>
                <!-- Key Statistics -->
                <div class="card p-3">
                    <div class="text-[10px] text-gray-500 font-semibold tracking-widest mb-2">KEY STATISTICS</div>
                    <div class="space-y-2 text-xs font-mono">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Hurst Exponent</span>
                            <div class="text-right">
                                <span id="stat-hurst" class="font-bold text-[#fcd535]">--</span>
                                <span id="stat-hurst-desc" class="text-gray-500 text-[10px] ml-1"></span>
                            </div>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Hist. Volatility (20d ann.)</span>
                            <span id="stat-hv" class="font-bold text-[#ffca28]">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Max Drawdown</span>
                            <span id="stat-maxdd" class="font-bold text-[#f06292]">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Sharpe Ratio (approx)</span>
                            <span id="stat-sharpe" class="font-bold text-gray-200">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Skewness</span>
                            <span id="stat-skew" class="font-bold text-gray-200">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Kurtosis (excess)</span>
                            <span id="stat-kurt" class="font-bold text-gray-200">--</span>
                        </div>
                    </div>
                </div>
                <!-- Regime Guide -->
                <div class="card p-3 text-[10px] text-gray-500 leading-4">
                    <div class="font-semibold text-gray-400 mb-1">Hurst Exponent Guide</div>
                    H &gt; 0.55 ‚Üí Trending (momentum) ¬∑ H &lt; 0.45 ‚Üí Mean-reverting ¬∑ H ‚âà 0.5 ‚Üí Random walk (GBM)
                </div>
                <!-- Annotation -->
                <div class="card p-3 text-[10px] text-gray-500 leading-4">
                    <div class="font-semibold text-gray-400 mb-1">Returns Histogram</div>
                    Green bars = positive returns ¬∑ Red bars = negative returns ¬∑ Dashed line = zero
                </div>
            </div>

        </div><!-- /panel-content -->
    </aside><!-- /right-panel -->

    <!-- MOBILE BOTTOM NAV -->
    <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-[#1e2329] border-t border-[#2b3139] flex justify-around items-center h-14 z-50">
        <button class="mobile-nav-btn flex flex-col items-center gap-1 text-[#fcd535]" data-view="chart">
            <span class="text-lg">üìä</span>
            <span class="text-[10px]">Chart</span>
        </button>
        <button class="mobile-nav-btn flex flex-col items-center gap-1 text-gray-500" data-view="book">
            <span class="text-lg">üìí</span>
            <span class="text-[10px]">Book</span>
        </button>
        <button class="mobile-nav-btn flex flex-col items-center gap-1 text-gray-500" data-view="trades">
            <span class="text-lg">ü§ù</span>
            <span class="text-[10px]">Trades</span>
        </button>
        <button class="mobile-nav-btn flex flex-col items-center gap-1 text-gray-500" data-view="tools">
            <span class="text-lg">üõ†Ô∏è</span>
            <span class="text-[10px]">Tools</span>
        </button>
    </nav>

</div>

<!-- LOGIC -->
<script>
/**
 * STATE & CONFIG
 */
const CONFIG = {
    api: 'https://api.binance.com/api/v3',
    ws: 'wss://stream.binance.com:9443/ws',
    symbols: [], 
    activeSymbol: 'BTCUSDT',
    activeInterval: '1h',
    watchlist: ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'SOLUSDT', 'XRPUSDT'],
    indicators: {
        // Existing
        sma: false, ema: false, bb: false,
        macd: false, rsi: false, atr: false, stoch: false,
        // Overlay ‚Äì price chart
        vwap: false, ichimoku: false, sar: false, keltner: false,
        pivots: false, lrchannel: false,
        // Oscillators
        obv: false, cmf: false, mfi: false,
        adx: false, cci: false, willr: false,
        bbpct: false, zscore: false, squeeze: false,
        hv: false, drawdown: false
    }
};

const CHART_COLORS = {
    bg: '#0b0e11',
    grid: '#1e2329',
    text: '#848e9c',
    candleUp: '#0ecb81',
    candleDown: '#f6465d',
    crosshair: '#787b86',
    sma: '#ff9800',
    ema: '#2979ff',
    bb: '#9c27b0',
    macd: '#2962ff',
    signal: '#ff6d00',
    histUp: 'rgba(14, 203, 129, 0.5)',
    histDown: 'rgba(246, 70, 93, 0.5)',
    stochK: '#00bcd4',
    stochD: '#ff9800',
    // New
    vwap: '#00e5ff', vwapBand: 'rgba(0,229,255,0.25)',
    keltner: '#ff4081',
    ichiTenkan: '#e91e63', ichiKijun: '#1976d2',
    ichiA: 'rgba(14,203,129,0.18)', ichiB: 'rgba(246,70,93,0.18)',
    lr: '#ffd600', lrBand: 'rgba(255,214,0,0.15)',
    obv: '#26c6da', cmf: '#ab47bc', mfi: '#ef5350',
    adx: '#ffffff', diPlus: '#0ecb81', diMinus: '#f6465d',
    cci: '#ff7043', willr: '#29b6f6',
    bbpct: '#ce93d8', bbbw: '#80deea',
    zscore: '#80cbc4',
    hv: '#ffca28', drawdown: '#f06292',
};

// DOM Refs
const UI = {
    loader: document.getElementById('chart-loader'),
    searchIn: document.getElementById('global-search'),
    searchRes: document.getElementById('search-results'),
    tabs: [document.getElementById('tab-ob'), document.getElementById('tab-trades'), document.getElementById('tab-info'), document.getElementById('tab-sentiment'), document.getElementById('tab-stats')],
    views: [document.getElementById('view-ob'), document.getElementById('view-trades'), document.getElementById('view-info'), document.getElementById('view-sentiment'), document.getElementById('view-stats')],
    indicatorsList: document.getElementById('indicator-list'),
    watchlist: document.getElementById('watchlist'),
    price: document.getElementById('current-price'),
    serverTime: document.getElementById('server-time'),
    refreshBtn: document.getElementById('refresh-btn'),
    tfBtns: document.querySelectorAll('.tf-btn'),
    chips: {
        spread: document.getElementById('chip-spread'),
        atr: document.getElementById('chip-atr'),
        rr: document.getElementById('chip-rr')
    },
    metrics: {
        spread: document.getElementById('metric-spread'),
        bbo: document.getElementById('metric-bbo'),
        mark: document.getElementById('metric-mark'),
        latency: document.getElementById('metric-latency'),
        updated: document.getElementById('metric-updated')
    },
    risk: {
        balance: document.getElementById('risk-balance'),
        percent: document.getElementById('risk-percent'),
        entry: document.getElementById('risk-entry'),
        stop: document.getElementById('risk-stop'),
        tp: document.getElementById('risk-tp'),
        lev: document.getElementById('risk-lev'),
        longBtn: document.getElementById('risk-long'),
        shortBtn: document.getElementById('risk-short'),
        reset: document.getElementById('risk-reset'),
        size: document.getElementById('risk-size'),
        qty: document.getElementById('risk-qty'),
        liq: document.getElementById('risk-liq'),
        rr: document.getElementById('risk-rr'),
        dollar: document.getElementById('risk-dollar'),
        pnl: document.getElementById('risk-pnl')
    },
    alert: {
        input: document.getElementById('alert-price'),
        set: document.getElementById('alert-set'),
        clear: document.getElementById('alert-clear'),
        status: document.getElementById('alert-status')
    }
};

// Chart Instances
let chartMain, chartOsc, seriesCandle, seriesVol, seriesSMA, seriesEMA, seriesBBU, seriesBBL;
let seriesMACD, seriesSignal, seriesHist, seriesRSI, seriesStochK, seriesStochD;
// New overlay series
let seriesVWAP, seriesVWAPU1, seriesVWAPL1;
let seriesKeltnerU, seriesKeltnerL;
let seriesIchiTenkan, seriesIchiKijun, seriesIchiSenkouA, seriesIchiSenkouB;
let seriesLRMid, seriesLRU, seriesLRL;
let pivotLines = [];
// New oscillator series
let seriesOBV, seriesCMF, seriesMFI;
let seriesADX, seriesDIPlus, seriesDIMinus;
let seriesCCI, seriesWilliamsR;
let seriesBBPct, seriesBBBW;
let seriesZScore;
let seriesSqueezeHist;
let seriesHV, seriesDrawdown;

const STATE = {
    side: 'long',
    alertPrice: null,
    alertLine: null,
    lastPrice: null,
    lastUpdate: null,
    lastWsTs: null,
    bbo: { bid: null, ask: null }
};

/**
 * INITIALIZATION
 */
async function init() {
    initCharts();
    renderIndicatorsToolbox();
    renderWatchlist();
    
    UI.loader.style.display = 'flex';
    
    // Timeframe Listeners
    UI.tfBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            UI.tfBtns.forEach(b => {
                b.classList.remove('bg-[#fcd535]', 'text-black');
                b.classList.add('hover:bg-[#1e2329]');
            });
            btn.classList.add('bg-[#fcd535]', 'text-black');
            btn.classList.remove('hover:bg-[#1e2329]');
            CONFIG.activeInterval = btn.dataset.tf;
            loadMarket(CONFIG.activeSymbol);
        });
    });

    // Risk inputs
    ['balance','percent','entry','stop','tp','lev'].forEach(key => {
        UI.risk[key].addEventListener('input', recalcRisk);
    });
    UI.risk.longBtn.addEventListener('click', () => setSide('long'));
    UI.risk.shortBtn.addEventListener('click', () => setSide('short'));
    UI.risk.reset.addEventListener('click', resetRisk);
    UI.alert.set.addEventListener('click', setPriceAlert);
    UI.alert.clear.addEventListener('click', clearPriceAlert);

    // Latency ticker
    setInterval(updateMeta, 1000);

    try {
        const res = await fetch(`${CONFIG.api}/exchangeInfo`);
        const data = await res.json();
        CONFIG.symbols = data.symbols.filter(s => s.status === 'TRADING').map(s => s.symbol);
        console.log(`Loaded ${CONFIG.symbols.length} pairs.`);
        
        // Load Initial Data
        await loadMarket(CONFIG.activeSymbol);
        
        // Start Clock
        setInterval(async () => {
            const t = await fetch(`${CONFIG.api}/time`);
            const dt = await t.json();
            UI.serverTime.innerText = new Date(dt.serverTime).toLocaleTimeString();
        }, 5000);

        // Update Watchlist Prices
        setInterval(updateWatchlistPrices, 10000);
        updateWatchlistPrices();

    } catch (e) {
        console.error(e);
        alert("Failed to load market data. Check internet connection.");
        UI.loader.style.display = 'none';
    }
}

/**
 * CHART SETUP
 */
function initCharts() {
    // MAIN CHART
    // We grab dimensions explicitly to ensure chart renders even if CSS is lagging
    const chartContainer = document.getElementById('main-chart');
    const chartWidth = chartContainer.clientWidth;
    const chartHeight = chartContainer.clientHeight;

    chartMain = LightweightCharts.createChart(chartContainer, {
        width: chartWidth,
        height: chartHeight,
        layout: { background: { color: CHART_COLORS.bg }, textColor: CHART_COLORS.text },
        grid: { vertLines: { color: CHART_COLORS.grid }, horzLines: { color: CHART_COLORS.grid } },
        timeScale: { timeVisible: true, secondsVisible: false },
        rightPriceScale: { borderColor: CHART_COLORS.grid },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    });

    seriesCandle = chartMain.addCandlestickSeries({
        upColor: CHART_COLORS.candleUp, downColor: CHART_COLORS.candleDown,
        borderVisible: false, wickUpColor: CHART_COLORS.candleUp, wickDownColor: CHART_COLORS.candleDown
    });

    seriesVol = chartMain.addHistogramSeries({
        priceFormat: { type: 'volume' }, priceScaleId: '', scaleMargins: { top: 0.8, bottom: 0 },
        color: '#26a69a'
    });

    // Indicators Series (Hidden by default)
    seriesSMA = chartMain.addLineSeries({ color: CHART_COLORS.sma, lineWidth: 1, visible: false });
    seriesEMA = chartMain.addLineSeries({ color: CHART_COLORS.ema, lineWidth: 1, visible: false });
    seriesBBU = chartMain.addLineSeries({ color: CHART_COLORS.bb, lineWidth: 1, visible: false });
    seriesBBL = chartMain.addLineSeries({ color: CHART_COLORS.bb, lineWidth: 1, visible: false });

    // Legend Update
    chartMain.subscribeCrosshairMove(param => {
        if (param.time) {
            const data = param.seriesData.get(seriesCandle);
            if (data) {
                document.getElementById('leg-o').innerText = data.open;
                document.getElementById('leg-h').innerText = data.high;
                document.getElementById('leg-l').innerText = data.low;
                document.getElementById('leg-c').innerText = data.close;
                const chg = ((data.close - data.open) / data.open * 100).toFixed(2);
                const chgEl = document.getElementById('leg-chg');
                chgEl.innerText = `${chg}%`;
                chgEl.style.color = chg >= 0 ? CHART_COLORS.candleUp : CHART_COLORS.candleDown;
                
                // Update Indicator Legend
                let indHtml = '';
                if (CONFIG.indicators.sma) {
                    const smaVal = param.seriesData.get(seriesSMA);
                    if(smaVal) indHtml += `<span style="color:${CHART_COLORS.sma}">SMA: ${smaVal.value.toFixed(2)}</span>`;
                }
                if (CONFIG.indicators.ema) {
                    const emaVal = param.seriesData.get(seriesEMA);
                    if(emaVal) indHtml += `<span style="color:${CHART_COLORS.ema}">EMA: ${emaVal.value.toFixed(2)}</span>`;
                }
                document.getElementById('leg-indicators').innerHTML = indHtml;
            }
        }
    });

    // OSCILLATOR CHART
    const oscContainer = document.getElementById('oscillator-chart');
    chartOsc = LightweightCharts.createChart(oscContainer, {
        width: oscContainer.clientWidth,
        height: oscContainer.clientHeight,
        layout: { background: { color: CHART_COLORS.bg }, textColor: CHART_COLORS.text },
        grid: { vertLines: { color: CHART_COLORS.grid }, horzLines: { color: CHART_COLORS.grid } },
        rightPriceScale: { borderColor: CHART_COLORS.grid },
        timeScale: { visible: false }, 
    });
    
    // Sync TimeScale
    chartOsc.timeScale().subscribeVisibleLogicalRangeChange(range => {
        chartMain.timeScale().setVisibleLogicalRange(range);
    });
    chartMain.timeScale().subscribeVisibleLogicalRangeChange(range => {
        chartOsc.timeScale().setVisibleLogicalRange(range);
    });

    seriesMACD = chartOsc.addLineSeries({ color: CHART_COLORS.macd, lineWidth: 1, visible: false });
    seriesSignal = chartOsc.addLineSeries({ color: CHART_COLORS.signal, lineWidth: 1, visible: false });
    seriesHist = chartOsc.addHistogramSeries({ color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: '', visible: false });
    seriesRSI = chartOsc.addLineSeries({ color: '#9c27b0', lineWidth: 1, visible: false });
    seriesStochK = chartOsc.addLineSeries({ color: CHART_COLORS.stochK, lineWidth: 1, visible: false });
    seriesStochD = chartOsc.addLineSeries({ color: CHART_COLORS.stochD, lineWidth: 1, visible: false });

    // New overlay series
    seriesVWAP  = chartMain.addLineSeries({ color: CHART_COLORS.vwap, lineWidth: 2, visible: false, title: 'VWAP' });
    seriesVWAPU1 = chartMain.addLineSeries({ color: CHART_COLORS.vwapBand, lineWidth: 1, lineStyle: 2, visible: false });
    seriesVWAPL1 = chartMain.addLineSeries({ color: CHART_COLORS.vwapBand, lineWidth: 1, lineStyle: 2, visible: false });
    seriesKeltnerU = chartMain.addLineSeries({ color: CHART_COLORS.keltner, lineWidth: 1, lineStyle: 2, visible: false });
    seriesKeltnerL = chartMain.addLineSeries({ color: CHART_COLORS.keltner, lineWidth: 1, lineStyle: 2, visible: false });
    seriesIchiTenkan = chartMain.addLineSeries({ color: CHART_COLORS.ichiTenkan, lineWidth: 1, visible: false, title: 'T' });
    seriesIchiKijun  = chartMain.addLineSeries({ color: CHART_COLORS.ichiKijun,  lineWidth: 2, visible: false, title: 'K' });
    seriesIchiSenkouA = chartMain.addLineSeries({ color: CHART_COLORS.ichiA, lineWidth: 1, lineStyle: 1, visible: false });
    seriesIchiSenkouB = chartMain.addLineSeries({ color: CHART_COLORS.ichiB, lineWidth: 1, lineStyle: 1, visible: false });
    seriesLRMid = chartMain.addLineSeries({ color: CHART_COLORS.lr, lineWidth: 1, lineStyle: 1, visible: false, title: 'LR' });
    seriesLRU   = chartMain.addLineSeries({ color: CHART_COLORS.lrBand, lineWidth: 1, lineStyle: 2, visible: false });
    seriesLRL   = chartMain.addLineSeries({ color: CHART_COLORS.lrBand, lineWidth: 1, lineStyle: 2, visible: false });

    // New oscillator series
    seriesOBV     = chartOsc.addLineSeries({ color: CHART_COLORS.obv, lineWidth: 1, visible: false, title: 'OBV' });
    seriesCMF     = chartOsc.addLineSeries({ color: CHART_COLORS.cmf, lineWidth: 1, visible: false, title: 'CMF' });
    seriesMFI     = chartOsc.addLineSeries({ color: CHART_COLORS.mfi, lineWidth: 1, visible: false, title: 'MFI' });
    seriesADX     = chartOsc.addLineSeries({ color: CHART_COLORS.adx, lineWidth: 2, visible: false, title: 'ADX' });
    seriesDIPlus  = chartOsc.addLineSeries({ color: CHART_COLORS.diPlus, lineWidth: 1, visible: false, title: 'DI+' });
    seriesDIMinus = chartOsc.addLineSeries({ color: CHART_COLORS.diMinus, lineWidth: 1, visible: false, title: 'DI-' });
    seriesCCI     = chartOsc.addLineSeries({ color: CHART_COLORS.cci, lineWidth: 1, visible: false, title: 'CCI' });
    seriesWilliamsR = chartOsc.addLineSeries({ color: CHART_COLORS.willr, lineWidth: 1, visible: false, title: '%R' });
    seriesBBPct   = chartOsc.addLineSeries({ color: CHART_COLORS.bbpct, lineWidth: 1, visible: false, title: '%B' });
    seriesBBBW    = chartOsc.addLineSeries({ color: CHART_COLORS.bbbw, lineWidth: 1, visible: false, title: 'BW' });
    seriesZScore  = chartOsc.addLineSeries({ color: CHART_COLORS.zscore, lineWidth: 1, visible: false, title: 'Z' });
    seriesSqueezeHist = chartOsc.addHistogramSeries({ color: CHART_COLORS.candleUp, priceFormat: { type: 'price' }, visible: false });
    seriesHV      = chartOsc.addLineSeries({ color: CHART_COLORS.hv, lineWidth: 1, visible: false, title: 'HV%' });
    seriesDrawdown = chartOsc.addLineSeries({ color: CHART_COLORS.drawdown, lineWidth: 1, visible: false, title: 'DD%' });

    // Resize Observer (Critical for responsiveness)
    const resizeObserver = new ResizeObserver(entries => {
        const rect = entries[0].contentRect;
        if(rect.width > 0 && rect.height > 0) {
            chartMain.applyOptions({ width: rect.width, height: rect.height });
        }
    });
    resizeObserver.observe(chartContainer);

    const resizeOsc = new ResizeObserver(entries => {
        const rect = entries[0].contentRect;
        if(rect.width > 0 && rect.height > 0) {
            chartOsc.applyOptions({ width: rect.width, height: rect.height });
        }
    });
    resizeOsc.observe(oscContainer);
}

/**
 * DATA FETCHING
 */
async function loadMarket(symbol) {
    CONFIG.activeSymbol = symbol.toUpperCase();
    UI.loader.style.display = 'flex';
    document.getElementById('loader-text').innerText = `Loading ${CONFIG.activeSymbol} Data...`;
    
    // Update Legend
    document.getElementById('leg-symbol').innerText = CONFIG.activeSymbol;
    document.getElementById('leg-interval').innerText = CONFIG.activeInterval.toUpperCase();
    
    try {
        // 1. Klines
        const res = await fetch(`${CONFIG.api}/klines?symbol=${CONFIG.activeSymbol}&interval=${CONFIG.activeInterval}&limit=1000`);
        if(!res.ok) throw new Error("Symbol not found");
        const data = await res.json();
        
        const candles = data.map(d => ({
            time: d[0]/1000, open: +d[1], high: +d[2], low: +d[3], close: +d[4], volume: +d[5]
        }));
        
        seriesCandle.setData(candles);
        seriesVol.setData(candles.map(d => ({ time: d.time, value: d.volume, color: d.close >= d.open ? CHART_COLORS.candleUp : CHART_COLORS.candleDown })));
        const last = candles[candles.length-1];
        STATE.lastPrice = last ? last.close : null;
        STATE.lastUpdate = last ? last.time * 1000 : null;
        if (!UI.risk.entry.value && last) UI.risk.entry.value = last.close;
        recalcRisk();
        updateMeta();
        
        // 2. Ticker Info
        const tRes = await fetch(`${CONFIG.api}/ticker/24hr?symbol=${CONFIG.activeSymbol}`);
        updateTickerUI(await tRes.json());

        // 3. Indicators
        updateIndicators(candles);
        
        // 4. WS
        startWS();
        
        // 5. Static OB & Trades
        fetchOrderBook();
        fetchRecentTrades();
        
        // Force chart content fit to ensure visibility
        setTimeout(() => {
            chartMain.timeScale().fitContent();
            UI.loader.style.display = 'none';
        }, 100);

    } catch (e) {
        console.error(e);
        UI.loader.style.display = 'none';
        alert("Error loading chart data: " + e.message);
    }
}

async function fetchOrderBook() {
    try {
        const res = await fetch(`${CONFIG.api}/depth?symbol=${CONFIG.activeSymbol}&limit=20`);
        const data = await res.json();
        renderOrderBook(data);
    } catch(e){}
}

async function fetchRecentTrades() {
    try {
        const res = await fetch(`${CONFIG.api}/trades?symbol=${CONFIG.activeSymbol}&limit=30`);
        const data = await res.json();
        renderTrades(data);
    } catch(e){}
}

/**
 * WEBSOCKETS
 */
function startWS() {
    if (window.ws) window.ws.close();
    
    const streams = [
        `${CONFIG.activeSymbol.toLowerCase()}@kline_${CONFIG.activeInterval}`,
        `${CONFIG.activeSymbol.toLowerCase()}@depth20@100ms`,
        `${CONFIG.activeSymbol.toLowerCase()}@aggTrade`
    ].join('/');
    
    window.ws = new WebSocket(`${CONFIG.ws}/${streams}`);
    
    window.ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        
        // Kline Update
        if (msg.k) {
            const k = msg.k;
            const candle = { time: k.t/1000, open: +k.o, high: +k.h, low: +k.l, close: +k.c, volume: +k.v };
            seriesCandle.update(candle);
            seriesVol.update({ time: candle.time, value: candle.volume, color: candle.close >= candle.open ? CHART_COLORS.candleUp : CHART_COLORS.candleDown });
            UI.price.innerText = +k.c;
            UI.price.style.color = +k.c >= +k.o ? CHART_COLORS.candleUp : CHART_COLORS.candleDown;
            const prev = STATE.lastPrice;
            STATE.lastPrice = candle.close;
            STATE.lastUpdate = k.T ? k.T : Date.now();
            STATE.lastWsTs = Date.now();
            checkAlert(prev, candle.close);
            updateMeta();
        }
        
        // Depth Update
        if (msg.bids && msg.asks) {
            STATE.lastWsTs = Date.now();
            renderOrderBook(msg);
            updateMeta();
        }
        
        // AggTrade Update
        if (msg.p) { 
            const tradeEl = document.createElement('div');
            tradeEl.className = `flex justify-between border-b border-gray-800 ${msg.m ? 'text-[#f6465d]' : 'text-[#0ecb81]'}`;
            tradeEl.innerHTML = `<span>${new Date(msg.T).toLocaleTimeString()}</span><span>${msg.p}</span><span>${msg.q}</span>`;
            const list = document.getElementById('trades-list');
            list.prepend(tradeEl);
            if(list.children.length > 50) list.lastChild.remove();
        }
    };
}

/**
 * UI RENDERERS
 */
function renderOrderBook(data) {
    // Asks
    let asksHtml = '';
    data.asks.slice(0,10).reverse().forEach(a => {
        asksHtml += `<div class="flex justify-between"><span>${+a[0]}</span><span>${(+a[1]).toFixed(4)}</span><span>${(+a[0]*+a[1]).toFixed(2)}</span></div>`;
    });
    document.getElementById('ob-asks').innerHTML = asksHtml;
    
    // Bids
    let bidsHtml = '';
    data.bids.slice(0,10).forEach(b => {
        bidsHtml += `<div class="flex justify-between"><span>${+b[0]}</span><span>${(+b[1]).toFixed(4)}</span><span>${(+b[0]*+b[1]).toFixed(2)}</span></div>`;
    });
    document.getElementById('ob-bids').innerHTML = bidsHtml;

    const bestAsk = data.asks?.[0]?.[0] ? parseFloat(data.asks[0][0]) : null;
    const bestBid = data.bids?.[0]?.[0] ? parseFloat(data.bids[0][0]) : null;
    if (bestAsk && bestBid) {
        STATE.bbo = { bid: bestBid, ask: bestAsk };
        const spread = bestAsk - bestBid;
        if (UI.metrics.spread) UI.metrics.spread.innerText = spread.toFixed(2);
        if (UI.metrics.bbo) UI.metrics.bbo.innerText = `${bestBid.toFixed(2)} / ${bestAsk.toFixed(2)}`;
        if (UI.chips.spread) UI.chips.spread.innerText = `Spread ${spread.toFixed(2)}`;
    }
}

function renderTrades(data) {
    const list = document.getElementById('trades-list');
    list.innerHTML = data.map(t => `
        <div class="flex justify-between border-b border-gray-800 ${t.isBuyerMaker ? 'text-[#f6465d]' : 'text-[#0ecb81]'}">
            <span>${new Date(t.time).toLocaleTimeString()}</span>
            <span>${t.price}</span>
            <span>${t.qty}</span>
        </div>
    `).join('');
}

function updateTickerUI(data) {
    document.getElementById('info-change').innerText = `${+data.priceChange} (${data.priceChangePercent}%)`;
    document.getElementById('info-high').innerText = +data.highPrice;
    document.getElementById('info-low').innerText = +data.lowPrice;
    document.getElementById('info-vol').innerText = +data.volume;
    document.getElementById('info-qvol').innerText = +data.quoteVolume;
    document.getElementById('info-trades').innerText = +data.count;
    if (UI.metrics.mark) UI.metrics.mark.innerText = (+data.lastPrice).toFixed(2);
}

/**
 * SEARCH FUNCTIONALITY
 */
UI.searchIn.addEventListener('input', (e) => {
    const val = e.target.value.toUpperCase();
    if (val.length < 1) { UI.searchRes.style.display = 'none'; return; }
    
    const matches = CONFIG.symbols.filter(s => s.startsWith(val)).slice(0, 50);
    
    UI.searchRes.innerHTML = matches.map(m => 
        `<div class="search-item" onclick="selectSymbol('${m}')"><span>${m}</span></div>`
    ).join('');
    UI.searchRes.style.display = matches.length ? 'block' : 'none';
});

function selectSymbol(sym) {
    UI.searchIn.value = sym;
    UI.searchRes.style.display = 'none';
    loadMarket(sym);
    // Close mobile sidebar if open
    document.getElementById('sidebar').classList.remove('show');
}

/**
 * TECHNICAL INDICATORS  ‚Äî all 20 tools
 */
function updateIndicators(data) {
    if (!data || data.length < 50) return;
    const closes  = data.map(d => d.close);
    const highs   = data.map(d => d.high);
    const lows    = data.map(d => d.low);
    const volumes = data.map(d => d.volume);
    const times   = data.map(d => d.time);

    // ‚îÄ‚îÄ CORE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcSMA = (period, arr) => {
        const res = [];
        for (let i = period - 1; i < arr.length; i++) {
            let s = 0; for (let j = 0; j < period; j++) s += arr[i - j];
            res.push({ time: times[i], value: s / period });
        }
        return res;
    };

    const calcEMA = (period, arr) => {
        const k = 2 / (period + 1); let ema = arr[0]; const res = [];
        for (let i = 0; i < arr.length; i++) { ema = arr[i] * k + ema * (1 - k); res.push({ time: times[i], value: ema }); }
        return res;
    };

    const calcATR = (period) => {
        const res = []; let atr = 0;
        for (let i = 1; i < data.length; i++) {
            const tr = Math.max(highs[i]-lows[i], Math.abs(highs[i]-closes[i-1]), Math.abs(lows[i]-closes[i-1]));
            atr = i === 1 ? tr : (atr*(period-1)+tr)/period;
            res.push({ time: times[i], value: atr });
        }
        return res;
    };

    const calcBB = (period, sd, arr) => {
        const sma = calcSMA(period, arr); const upper = [], lower = [];
        for (let i = 0; i < sma.length; i++) {
            const sl = arr.slice(i, i+period);
            const mean = sma[i].value;
            const v = sl.reduce((a,b) => a+(b-mean)**2, 0)/period;
            upper.push({ time: sma[i].time, value: mean+sd*Math.sqrt(v) });
            lower.push({ time: sma[i].time, value: mean-sd*Math.sqrt(v) });
        }
        return { upper, lower, middle: sma };
    };

    const calcKeltner = (emaPer, atrPer, mult) => {
        const ema = calcEMA(emaPer, closes); const atrD = calcATR(atrPer);
        const upper = [], lower = [];
        for (let i = 0; i < atrD.length; i++) {
            upper.push({ time: atrD[i].time, value: ema[i+1].value + mult*atrD[i].value });
            lower.push({ time: atrD[i].time, value: ema[i+1].value - mult*atrD[i].value });
        }
        return { upper, lower };
    };

    // ‚îÄ‚îÄ RSI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcRSI = (period, arr) => {
        let g=0,l=0; for(let i=1;i<=period;i++){const c=arr[i]-arr[i-1];if(c>=0)g+=c;else l-=c;}
        let ag=g/period, al=l/period; const res=[];
        for(let i=period+1;i<arr.length;i++){
            const c=arr[i]-arr[i-1]; ag=(ag*(period-1)+(c>0?c:0))/period; al=(al*(period-1)+(c<0?-c:0))/period;
            res.push({time:times[i],value:100-100/(1+(al===0?100:ag/al))});
        }
        return res;
    };

    // ‚îÄ‚îÄ STOCHASTIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcStoch = (kP, dP) => {
        const K = [];
        for(let i=kP-1;i<data.length;i++){
            const sl=data.slice(i-kP+1,i+1);
            const lo=Math.min(...sl.map(d=>d.low)),hi=Math.max(...sl.map(d=>d.high));
            K.push({time:times[i],value:hi===lo?50:((data[i].close-lo)/(hi-lo))*100});
        }
        const D=calcSMA(dP,K.map(v=>v.value));
        return{k:K,d:D.map((v,i)=>({time:K[i+dP-1].time,value:v.value}))};
    };

    // ‚îÄ‚îÄ MACD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcMACD = (arr) => {
        const e12=calcEMA(12,arr),e26=calcEMA(26,arr),off=26-12;
        const ml=e26.map((v,i)=>({time:v.time,value:e12[i+off].value-v.value}));
        const sl=calcEMA(9,ml.map(m=>m.value));
        const hist=ml.map((m,i)=>{const v=m.value-sl[i].value;return{time:m.time,value:v,color:v>=0?CHART_COLORS.histUp:CHART_COLORS.histDown};});
        return{macd:ml,signal:sl.map((s,i)=>({time:ml[i].time,value:s.value})),hist};
    };

    // ‚îÄ‚îÄ VWAP + 1œÉ bands ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcVWAP = () => {
        let cpv=0,cpv2=0,cv=0; const res=[],up=[],dn=[];
        for(let i=0;i<data.length;i++){
            const tp=(highs[i]+lows[i]+closes[i])/3,v=volumes[i];
            cpv+=tp*v; cpv2+=tp*tp*v; cv+=v;
            const vwap=cpv/cv, sd=Math.sqrt(Math.max(0,cpv2/cv-vwap*vwap));
            res.push({time:times[i],value:vwap});
            up.push({time:times[i],value:vwap+sd});
            dn.push({time:times[i],value:vwap-sd});
        }
        return{vwap:res,upper:up,lower:dn};
    };

    // ‚îÄ‚îÄ ICHIMOKU (Tenkan/Kijun/Senkou A&B) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcIchimoku = () => {
        const mid=(n,i)=>{let h=-Infinity,l=Infinity;for(let k=Math.max(0,i-n+1);k<=i;k++){h=Math.max(h,highs[k]);l=Math.min(l,lows[k]);}return(h+l)/2;};
        const tenkan=[],kijun=[],sA=[],sB=[];
        for(let i=8;i<data.length;i++) tenkan.push({time:times[i],value:mid(9,i)});
        for(let i=25;i<data.length;i++){
            const kv=mid(26,i); kijun.push({time:times[i],value:kv});
            sA.push({time:times[i],value:(tenkan[i-8].value+kv)/2});
        }
        for(let i=51;i<data.length;i++) sB.push({time:times[i],value:mid(52,i)});
        return{tenkan,kijun,senkouA:sA,senkouB:sB};
    };

    // ‚îÄ‚îÄ PARABOLIC SAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcSAR = () => {
        const af0=0.02,afMax=0.2,step=0.02;
        let bull=true,af=af0,ep=highs[0],sar=lows[0];
        const markers=[];
        for(let i=1;i<data.length;i++){
            sar=sar+af*(ep-sar);
            if(bull){
                sar=Math.min(sar,lows[Math.max(0,i-1)],i>=2?lows[i-2]:sar);
                if(lows[i]<sar){bull=false;sar=ep;ep=lows[i];af=af0;}
                else if(highs[i]>ep){ep=highs[i];af=Math.min(af+step,afMax);}
            }else{
                sar=Math.max(sar,highs[Math.max(0,i-1)],i>=2?highs[i-2]:sar);
                if(highs[i]>sar){bull=true;sar=ep;ep=highs[i];af=af0;}
                else if(lows[i]<ep){ep=lows[i];af=Math.min(af+step,afMax);}
            }
            markers.push({time:times[i],position:bull?'belowBar':'aboveBar',color:bull?CHART_COLORS.candleUp:CHART_COLORS.candleDown,shape:'circle',text:''});
        }
        return markers;
    };

    // ‚îÄ‚îÄ LR CHANNEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcLRChannel = (lb) => {
        const n=Math.min(lb,closes.length),sl=closes.slice(-n),tl=times.slice(-n);
        let sx=0,sy=0,sxy=0,sx2=0;
        for(let i=0;i<n;i++){sx+=i;sy+=sl[i];sxy+=i*sl[i];sx2+=i*i;}
        const D=n*sx2-sx*sx,slope=D?((n*sxy-sx*sy)/D):0,intc=(sy-slope*sx)/n;
        const fit=sl.map((_,i)=>intc+slope*i);
        const rsd=Math.sqrt(sl.reduce((a,_,i)=>a+(sl[i]-fit[i])**2,0)/n);
        return{
            mid:tl.map((t,i)=>({time:t,value:fit[i]})),
            upper:tl.map((t,i)=>({time:t,value:fit[i]+2*rsd})),
            lower:tl.map((t,i)=>({time:t,value:fit[i]-2*rsd}))
        };
    };

    // ‚îÄ‚îÄ PIVOT POINTS (Classic) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcPivots = () => {
        if(data.length<2)return null;
        const p=data[data.length-2],P=(p.high+p.low+p.close)/3;
        return{P,R1:2*P-p.low,R2:P+(p.high-p.low),S1:2*P-p.high,S2:P-(p.high-p.low)};
    };

    // ‚îÄ‚îÄ OBV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcOBV = () => {
        let obv=0; const res=[{time:times[0],value:0}];
        for(let i=1;i<data.length;i++){
            obv+=closes[i]>closes[i-1]?volumes[i]:closes[i]<closes[i-1]?-volumes[i]:0;
            res.push({time:times[i],value:obv});
        }
        return res;
    };

    // ‚îÄ‚îÄ CMF (21-period) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcCMF = (period) => {
        const res=[];
        for(let i=period-1;i<data.length;i++){
            let smfv=0,sv=0;
            for(let j=i-period+1;j<=i;j++){
                const hl=highs[j]-lows[j],mf=hl===0?0:((closes[j]-lows[j])-(highs[j]-closes[j]))/hl;
                smfv+=mf*volumes[j];sv+=volumes[j];
            }
            res.push({time:times[i],value:sv>0?smfv/sv:0});
        }
        return res;
    };

    // ‚îÄ‚îÄ MFI (14-period) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcMFI = (period) => {
        const res=[];
        for(let i=period;i<data.length;i++){
            let pos=0,neg=0;
            for(let j=i-period+1;j<=i;j++){
                const tp=(highs[j]+lows[j]+closes[j])/3,ptp=(highs[j-1]+lows[j-1]+closes[j-1])/3;
                const mf=tp*volumes[j];
                if(tp>ptp)pos+=mf;else if(tp<ptp)neg+=mf;
            }
            res.push({time:times[i],value:neg===0?100:100-100/(1+pos/neg)});
        }
        return res;
    };

    // ‚îÄ‚îÄ ADX + DI+/DI- (14-period) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcADX = (period) => {
        let smTR=0,smDMP=0,smDMM=0; const adxArr=[],diP=[],diM=[],dxBuf=[];
        for(let i=1;i<data.length;i++){
            const tr=Math.max(highs[i]-lows[i],Math.abs(highs[i]-closes[i-1]),Math.abs(lows[i]-closes[i-1]));
            const dmp=Math.max(0,highs[i]-highs[i-1])>Math.max(0,lows[i-1]-lows[i])?Math.max(0,highs[i]-highs[i-1]):0;
            const dmm=Math.max(0,lows[i-1]-lows[i])>Math.max(0,highs[i]-highs[i-1])?Math.max(0,lows[i-1]-lows[i]):0;
            if(i<=period){smTR+=tr;smDMP+=dmp;smDMM+=dmm;}
            else{
                smTR=smTR-smTR/period+tr;smDMP=smDMP-smDMP/period+dmp;smDMM=smDMM-smDMM/period+dmm;
                const pdi=smTR===0?0:100*smDMP/smTR,mdi=smTR===0?0:100*smDMM/smTR;
                const dx=(pdi+mdi)===0?0:100*Math.abs(pdi-mdi)/(pdi+mdi);
                diP.push({time:times[i],value:pdi});diM.push({time:times[i],value:mdi});dxBuf.push(dx);
                if(dxBuf.length>=period) adxArr.push({time:times[i],value:dxBuf.slice(-period).reduce((a,b)=>a+b,0)/period});
            }
        }
        return{adx:adxArr,diPlus:diP,diMinus:diM};
    };

    // ‚îÄ‚îÄ CCI (20-period) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcCCI = (period) => {
        const res=[];
        for(let i=period-1;i<data.length;i++){
            const tps=[];for(let j=i-period+1;j<=i;j++)tps.push((highs[j]+lows[j]+closes[j])/3);
            const mean=tps.reduce((a,b)=>a+b,0)/period;
            const mad=tps.reduce((a,b)=>a+Math.abs(b-mean),0)/period;
            res.push({time:times[i],value:mad===0?0:(tps[tps.length-1]-mean)/(0.015*mad)});
        }
        return res;
    };

    // ‚îÄ‚îÄ WILLIAMS %R (14-period) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcWilliamsR = (period) => {
        const res=[];
        for(let i=period-1;i<data.length;i++){
            let h=-Infinity,l=Infinity;
            for(let j=i-period+1;j<=i;j++){h=Math.max(h,highs[j]);l=Math.min(l,lows[j]);}
            res.push({time:times[i],value:h===l?-50:((h-closes[i])/(h-l))*-100});
        }
        return res;
    };

    // ‚îÄ‚îÄ BB %B and BANDWIDTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcBBPctBW = (period, sd) => {
        const bb=calcBB(period,sd,closes);
        const pct=bb.upper.map((u,i)=>{
            const bw=u.value-bb.lower[i].value;
            return{time:u.time,value:bw===0?50:((closes[period-1+i]-bb.lower[i].value)/bw)*100};
        });
        const bw=bb.upper.map((u,i)=>({time:u.time,value:bb.middle[i].value===0?0:((u.value-bb.lower[i].value)/bb.middle[i].value)*100}));
        return{pct,bw};
    };

    // ‚îÄ‚îÄ Z-SCORE (20-period) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcZScore = (period) => {
        const res=[];
        for(let i=period-1;i<closes.length;i++){
            let s=0,s2=0;for(let j=i-period+1;j<=i;j++){s+=closes[j];s2+=closes[j]*closes[j];}
            const mean=s/period,sd=Math.sqrt(Math.max(0,s2/period-mean*mean));
            res.push({time:times[i],value:sd===0?0:(closes[i]-mean)/sd});
        }
        return res;
    };

    // ‚îÄ‚îÄ SQUEEZE MOMENTUM (LazyBear style) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcSqueeze = () => {
        const bb=calcBB(20,2,closes),kc=calcKeltner(20,20,1.5),hist=[];
        for(let i=20;i<data.length;i++){
            const bbI=i-19,kcI=i-1;
            if(bbI<0||bbI>=bb.upper.length||kcI>=kc.upper.length)continue;
            // Value for linreg
            const lookback=12;if(i<lookback)continue;
            let sx=0,sy=0,sxy=0,sx2=0;
            for(let k=0;k<lookback;k++){
                const j=i-lookback+1+k;
                let hh=-Infinity,ll=Infinity;
                for(let m=Math.max(0,j-19);m<=j;m++){hh=Math.max(hh,highs[m]);ll=Math.min(ll,lows[m]);}
                let smaS=0,smaN=Math.min(20,j+1);
                for(let m=Math.max(0,j-19);m<=j;m++)smaS+=closes[m];
                const val=closes[j]-((hh+ll)/2+smaS/smaN)/2;
                sx+=k;sy+=val;sxy+=k*val;sx2+=k*k;
            }
            const D=lookback*sx2-sx*sx,sl=D?(lookback*sxy-sx*sy)/D:0,ic=(sy-sl*sx)/lookback;
            const mom=sl*(lookback-1)+ic;
            const prev=hist.length?hist[hist.length-1].value:0;
            hist.push({time:times[i],value:mom,color:mom>=0?(mom>=prev?'#0ecb81':'#26a69a'):(mom<=prev?'#f6465d':'#ef9a9a')});
        }
        return hist;
    };

    // ‚îÄ‚îÄ HISTORICAL VOLATILITY (annualised) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcHV = (period) => {
        const lr=[];for(let i=1;i<closes.length;i++)if(closes[i]>0&&closes[i-1]>0)lr.push(Math.log(closes[i]/closes[i-1]));
        const ann=Math.sqrt(252)*100,res=[];
        for(let i=period-1;i<lr.length;i++){
            let s=0,s2=0;for(let j=i-period+1;j<=i;j++){s+=lr[j];s2+=lr[j]*lr[j];}
            const mean=s/period;res.push({time:times[i+1],value:Math.sqrt(Math.max(0,s2/period-mean*mean))*ann});
        }
        return res;
    };

    // ‚îÄ‚îÄ DRAWDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcDrawdown = () => {
        let peak=closes[0];
        return closes.map((c,i)=>{if(c>peak)peak=c;return{time:times[i],value:peak===0?0:((c-peak)/peak)*100};});
    };

    // ‚îÄ‚îÄ HURST EXPONENT (R/S analysis) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const calcHurst = () => {
        const lr=[];for(let i=1;i<closes.length;i++)if(closes[i]>0&&closes[i-1]>0)lr.push(Math.log(closes[i]/closes[i-1]));
        if(lr.length<20)return 0.5;
        const lags=[4,8,16,32,64].filter(l=>l*2<=lr.length);
        const logRS=[],logLag=[];
        for(const lag of lags){
            const rsl=[];
            for(let start=0;start+lag<=lr.length;start+=lag){
                const sub=lr.slice(start,start+lag);
                const mean=sub.reduce((a,b)=>a+b,0)/lag;
                let cd=0,hi=-Infinity,lo=Infinity;
                for(const r of sub){cd+=r-mean;hi=Math.max(hi,cd);lo=Math.min(lo,cd);}
                const sd=Math.sqrt(sub.reduce((a,b)=>a+(b-mean)**2,0)/lag)||1e-10;
                rsl.push((hi-lo)/sd);
            }
            if(rsl.length){logRS.push(Math.log(rsl.reduce((a,b)=>a+b,0)/rsl.length));logLag.push(Math.log(lag));}
        }
        if(logLag.length<2)return 0.5;
        let sx=0,sy=0,sxy=0,sx2=0;const m=logLag.length;
        for(let i=0;i<m;i++){sx+=logLag[i];sy+=logRS[i];sxy+=logLag[i]*logRS[i];sx2+=logLag[i]*logLag[i];}
        return Math.max(0.01,Math.min(0.99,(m*sxy-sx*sy)/(m*sx2-sx*sx||1)));
    };

    // ‚îÄ‚îÄ RETURNS HISTOGRAM (canvas) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const renderReturnsHist = () => {
        const canvas=document.getElementById('returns-canvas');if(!canvas)return;
        const ctx=canvas.getContext('2d'),w=canvas.offsetWidth||260,h=100;
        canvas.width=w;canvas.height=h;
        const lr=[];for(let i=1;i<closes.length;i++)if(closes[i]>0&&closes[i-1]>0)lr.push(Math.log(closes[i]/closes[i-1])*100);
        if(lr.length<5)return;
        const bins=32,minR=Math.min(...lr),maxR=Math.max(...lr),rng=(maxR-minR)||1,bs=rng/bins;
        const cts=new Array(bins).fill(0);
        for(const r of lr){const b=Math.min(bins-1,Math.floor((r-minR)/bs));cts[b]++;}
        const maxCt=Math.max(...cts);
        ctx.fillStyle='#0b0e11';ctx.fillRect(0,0,w,h);
        const bw=w/bins,zero=Math.min(bins-1,Math.max(0,Math.floor((0-minR)/bs)));
        for(let b=0;b<bins;b++){
            const bh=(cts[b]/maxCt)*(h-16);
            ctx.fillStyle=b<zero?'rgba(246,70,93,0.75)':'rgba(14,203,129,0.75)';
            ctx.fillRect(b*bw,h-16-bh,bw-1,bh);
        }
        ctx.strokeStyle='#fcd535';ctx.lineWidth=1;ctx.setLineDash([3,3]);
        ctx.beginPath();const zx=zero*bw;ctx.moveTo(zx,0);ctx.lineTo(zx,h-16);ctx.stroke();ctx.setLineDash([]);
        ctx.fillStyle='#848e9c';ctx.font='8px monospace';ctx.textAlign='left';ctx.fillText(minR.toFixed(1)+'%',2,h-2);
        ctx.textAlign='center';ctx.fillText('0',zx,h-2);
        ctx.textAlign='right';ctx.fillText(maxR.toFixed(1)+'%',w-2,h-2);
    };

    // ‚îÄ‚îÄ STATS PANEL UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const updateStatsPanel = () => {
        renderReturnsHist();
        // Hurst
        const H=calcHurst();
        const hEl=document.getElementById('stat-hurst'),hdEl=document.getElementById('stat-hurst-desc');
        if(hEl){hEl.textContent=H.toFixed(3);hEl.style.color=H>0.55?'#0ecb81':H<0.45?'#f6465d':'#fcd535';}
        if(hdEl)hdEl.textContent=H>0.55?'Trending':H<0.45?'Mean-Rev':'Rand. Walk';
        // HV
        const hvD=calcHV(20);if(hvD.length){const el=document.getElementById('stat-hv');if(el)el.textContent=hvD[hvD.length-1].value.toFixed(1)+'%';}
        // Drawdown
        const dd=calcDrawdown(),maxDD=Math.min(...dd.map(d=>d.value));
        const ddEl=document.getElementById('stat-maxdd');if(ddEl)ddEl.textContent=maxDD.toFixed(2)+'%';
        // Sharpe (annualised)
        const lr=[];for(let i=1;i<closes.length;i++)if(closes[i]>0&&closes[i-1]>0)lr.push(Math.log(closes[i]/closes[i-1]));
        if(lr.length>1){
            const mean=lr.reduce((a,b)=>a+b,0)/lr.length;
            const sd=Math.sqrt(lr.reduce((a,b)=>a+(b-mean)**2,0)/lr.length)||1e-10;
            const sharpe=(mean*Math.sqrt(252))/sd;
            const shEl=document.getElementById('stat-sharpe');
            if(shEl){shEl.textContent=sharpe.toFixed(2);shEl.style.color=sharpe>=1?'#0ecb81':sharpe>=0?'#fcd535':'#f6465d';}
            // Skewness
            const skewEl=document.getElementById('stat-skew');
            if(skewEl){const skew=lr.reduce((a,b)=>a+((b-mean)/sd)**3,0)/lr.length;skewEl.textContent=skew.toFixed(3);skewEl.style.color=skew>0.5?'#0ecb81':skew<-0.5?'#f6465d':'#848e9c';}
            // Excess Kurtosis
            const kurtEl=document.getElementById('stat-kurt');
            if(kurtEl){const kurt=lr.reduce((a,b)=>a+((b-mean)/sd)**4,0)/lr.length-3;kurtEl.textContent=kurt.toFixed(2);kurtEl.style.color=kurt>1?'#f6465d':'#848e9c';}
        }
    };

    // ‚îÄ‚îÄ APPLY EXISTING INDICATORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (CONFIG.indicators.sma) {
        const d=calcSMA(20,closes);seriesSMA.setData(d);seriesSMA.applyOptions({visible:true});
        const lv=d[d.length-1]?.value;document.getElementById('val-sma').innerText=lv?lv.toFixed(2):'-';
    } else { seriesSMA.applyOptions({visible:false});document.getElementById('val-sma').innerText='-'; }

    if (CONFIG.indicators.ema) { seriesEMA.setData(calcEMA(20,closes));seriesEMA.applyOptions({visible:true}); }
    else seriesEMA.applyOptions({visible:false});

    if (CONFIG.indicators.bb) {
        const bb=calcBB(20,2,closes);
        seriesBBU.setData(bb.upper);seriesBBL.setData(bb.lower);seriesSMA.setData(bb.middle);
        seriesBBU.applyOptions({visible:true});seriesBBL.applyOptions({visible:true});seriesSMA.applyOptions({visible:true});
    } else if (!CONFIG.indicators.sma) { seriesBBU.applyOptions({visible:false});seriesBBL.applyOptions({visible:false});seriesSMA.applyOptions({visible:false}); }

    if (CONFIG.indicators.rsi) {
        const d=calcRSI(14,closes);seriesRSI.setData(d);seriesRSI.applyOptions({visible:true});
        const lv=d[d.length-1]?.value;document.getElementById('val-rsi').innerText=lv?lv.toFixed(2):'-';
    } else seriesRSI.applyOptions({visible:false});

    if (CONFIG.indicators.macd) {
        const m=calcMACD(closes);
        seriesMACD.setData(m.macd);seriesSignal.setData(m.signal);seriesHist.setData(m.hist);
        seriesMACD.applyOptions({visible:true});seriesSignal.applyOptions({visible:true});seriesHist.applyOptions({visible:true});
        const lv=m.macd[m.macd.length-1]?.value;document.getElementById('val-macd').innerText=lv?lv.toFixed(2):'-';
    } else { seriesMACD.applyOptions({visible:false});seriesSignal.applyOptions({visible:false});seriesHist.applyOptions({visible:false}); }

    if (CONFIG.indicators.atr) {
        const d=calcATR(14);seriesStochK.setData(d);seriesStochK.applyOptions({visible:true,title:'ATR',color:'#fff'});
        const lv=d[d.length-1]?.value;document.getElementById('val-atr').innerText=lv?lv.toFixed(2):'-';
        if(UI.chips.atr)UI.chips.atr.innerText=`ATR ${lv?lv.toFixed(2):'-'}`;
    } else if (!CONFIG.indicators.stoch) seriesStochK.applyOptions({visible:false});

    if (!CONFIG.indicators.atr && UI.chips.atr) UI.chips.atr.innerText='ATR --';

    if (CONFIG.indicators.stoch) {
        const s=calcStoch(14,3);
        seriesStochK.setData(s.k);seriesStochD.setData(s.d);
        seriesStochK.applyOptions({visible:true,title:'Stoch K',color:CHART_COLORS.stochK});
        seriesStochD.applyOptions({visible:true,title:'Stoch D',color:CHART_COLORS.stochD});
    } else if (!CONFIG.indicators.atr) { seriesStochK.applyOptions({visible:false});seriesStochD.applyOptions({visible:false}); }

    // ‚îÄ‚îÄ APPLY NEW INDICATORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // VWAP
    if (CONFIG.indicators.vwap) {
        const v=calcVWAP();
        seriesVWAP.setData(v.vwap);seriesVWAP.applyOptions({visible:true});
        seriesVWAPU1.setData(v.upper);seriesVWAPU1.applyOptions({visible:true});
        seriesVWAPL1.setData(v.lower);seriesVWAPL1.applyOptions({visible:true});
    } else { [seriesVWAP,seriesVWAPU1,seriesVWAPL1].forEach(s=>s.applyOptions({visible:false})); }

    // Ichimoku
    if (CONFIG.indicators.ichimoku) {
        const ic=calcIchimoku();
        seriesIchiTenkan.setData(ic.tenkan);seriesIchiTenkan.applyOptions({visible:true});
        seriesIchiKijun.setData(ic.kijun);seriesIchiKijun.applyOptions({visible:true});
        seriesIchiSenkouA.setData(ic.senkouA);seriesIchiSenkouA.applyOptions({visible:true});
        seriesIchiSenkouB.setData(ic.senkouB);seriesIchiSenkouB.applyOptions({visible:true});
    } else { [seriesIchiTenkan,seriesIchiKijun,seriesIchiSenkouA,seriesIchiSenkouB].forEach(s=>s.applyOptions({visible:false})); }

    // Parabolic SAR
    if (CONFIG.indicators.sar) seriesCandle.setMarkers(calcSAR());
    else seriesCandle.setMarkers([]);

    // Keltner Channels
    if (CONFIG.indicators.keltner) {
        const kc=calcKeltner(20,10,2);
        seriesKeltnerU.setData(kc.upper);seriesKeltnerU.applyOptions({visible:true});
        seriesKeltnerL.setData(kc.lower);seriesKeltnerL.applyOptions({visible:true});
    } else { seriesKeltnerU.applyOptions({visible:false});seriesKeltnerL.applyOptions({visible:false}); }

    // Pivot Points (classic)
    pivotLines.forEach(pl=>seriesCandle.removePriceLine(pl)); pivotLines=[];
    if (CONFIG.indicators.pivots) {
        const pv=calcPivots();
        if(pv){
            [{price:pv.P,color:'#fcd535',title:'P'},{price:pv.R1,color:'#0ecb81',title:'R1'},
             {price:pv.R2,color:'#0ecb81',title:'R2'},{price:pv.S1,color:'#f6465d',title:'S1'},
             {price:pv.S2,color:'#f6465d',title:'S2'}].forEach(d=>{
                pivotLines.push(seriesCandle.createPriceLine({price:d.price,color:d.color,lineWidth:1,lineStyle:LightweightCharts.LineStyle.Dashed,title:d.title}));
            });
        }
    }

    // LR Channel
    if (CONFIG.indicators.lrchannel) {
        const lr=calcLRChannel(100);
        seriesLRMid.setData(lr.mid);seriesLRMid.applyOptions({visible:true});
        seriesLRU.setData(lr.upper);seriesLRU.applyOptions({visible:true});
        seriesLRL.setData(lr.lower);seriesLRL.applyOptions({visible:true});
    } else { [seriesLRMid,seriesLRU,seriesLRL].forEach(s=>s.applyOptions({visible:false})); }

    // OBV
    if (CONFIG.indicators.obv) { seriesOBV.setData(calcOBV());seriesOBV.applyOptions({visible:true}); }
    else seriesOBV.applyOptions({visible:false});

    // CMF
    if (CONFIG.indicators.cmf) { seriesCMF.setData(calcCMF(21));seriesCMF.applyOptions({visible:true}); }
    else seriesCMF.applyOptions({visible:false});

    // MFI
    if (CONFIG.indicators.mfi) { seriesMFI.setData(calcMFI(14));seriesMFI.applyOptions({visible:true}); }
    else seriesMFI.applyOptions({visible:false});

    // ADX
    if (CONFIG.indicators.adx) {
        const a=calcADX(14);
        seriesADX.setData(a.adx);seriesADX.applyOptions({visible:true});
        seriesDIPlus.setData(a.diPlus);seriesDIPlus.applyOptions({visible:true});
        seriesDIMinus.setData(a.diMinus);seriesDIMinus.applyOptions({visible:true});
    } else { [seriesADX,seriesDIPlus,seriesDIMinus].forEach(s=>s.applyOptions({visible:false})); }

    // CCI
    if (CONFIG.indicators.cci) { seriesCCI.setData(calcCCI(20));seriesCCI.applyOptions({visible:true}); }
    else seriesCCI.applyOptions({visible:false});

    // Williams %R
    if (CONFIG.indicators.willr) { seriesWilliamsR.setData(calcWilliamsR(14));seriesWilliamsR.applyOptions({visible:true}); }
    else seriesWilliamsR.applyOptions({visible:false});

    // BB %B + Bandwidth
    if (CONFIG.indicators.bbpct) {
        const bd=calcBBPctBW(20,2);
        seriesBBPct.setData(bd.pct);seriesBBPct.applyOptions({visible:true});
        seriesBBBW.setData(bd.bw);seriesBBBW.applyOptions({visible:true});
    } else { seriesBBPct.applyOptions({visible:false});seriesBBBW.applyOptions({visible:false}); }

    // Z-Score
    if (CONFIG.indicators.zscore) { seriesZScore.setData(calcZScore(20));seriesZScore.applyOptions({visible:true}); }
    else seriesZScore.applyOptions({visible:false});

    // Squeeze Momentum
    if (CONFIG.indicators.squeeze) {
        seriesSqueezeHist.setData(calcSqueeze());seriesSqueezeHist.applyOptions({visible:true});
    } else seriesSqueezeHist.applyOptions({visible:false});

    // Historical Volatility
    if (CONFIG.indicators.hv) { seriesHV.setData(calcHV(20));seriesHV.applyOptions({visible:true}); }
    else seriesHV.applyOptions({visible:false});

    // Drawdown
    if (CONFIG.indicators.drawdown) { seriesDrawdown.setData(calcDrawdown());seriesDrawdown.applyOptions({visible:true}); }
    else seriesDrawdown.applyOptions({visible:false});

    // Always refresh stats panel
    updateStatsPanel();
}

/**
 * TRADER TOOLS
 */
function recalcRisk() {
    const fmt = (v, d = 2) => (Number.isFinite(v) ? v.toFixed(d) : '-');
    const balance = parseFloat(UI.risk.balance.value);
    const riskPct = parseFloat(UI.risk.percent.value);
    const entry = parseFloat(UI.risk.entry.value);
    const stop = parseFloat(UI.risk.stop.value);
    const tp = parseFloat(UI.risk.tp.value);
    const lev = Math.max(1, parseFloat(UI.risk.lev.value) || 1);

    const clear = () => {
        UI.risk.size.innerText = '-';
        UI.risk.qty.innerText = '-';
        UI.risk.liq.innerText = '-';
        UI.risk.rr.innerText = '-';
        UI.risk.dollar.innerText = '-';
        UI.risk.pnl.innerText = '-';
        if (UI.chips.rr) UI.chips.rr.innerText = 'R:R --';
    };

    if ([balance, riskPct, entry, stop].some(v => Number.isNaN(v))) { clear(); return; }
    const riskDollar = balance * (riskPct / 100);
    const move = Math.abs(entry - stop);
    if (!move) { clear(); return; }
    const sizeUSDT = riskDollar / move;
    const qty = sizeUSDT / entry;
    const liq = STATE.side === 'long' ? entry * (1 - 1 / lev) : entry * (1 + 1 / lev);
    const rr = Number.isFinite(tp) ? Math.abs(tp - entry) / move : null;
    const tpPnl = Number.isFinite(tp) ? qty * (tp - entry) * (STATE.side === 'long' ? 1 : -1) : null;

    UI.risk.size.innerText = fmt(sizeUSDT);
    UI.risk.qty.innerText = fmt(qty, 5);
    UI.risk.liq.innerText = fmt(liq);
    UI.risk.rr.innerText = rr ? fmt(rr, 2) : '-';
    UI.risk.dollar.innerText = fmt(riskDollar);
    UI.risk.pnl.innerText = tpPnl !== null ? fmt(tpPnl) : '-';
    if (UI.chips.rr) UI.chips.rr.innerText = rr ? `R:R ${fmt(rr, 2)}` : 'R:R --';
}

function setSide(side) {
    STATE.side = side;
    UI.risk.longBtn.classList.toggle('active', side === 'long');
    UI.risk.shortBtn.classList.toggle('active', side === 'short');
    recalcRisk();
}

function resetRisk() {
    UI.risk.balance.value = 1000;
    UI.risk.percent.value = 1;
    UI.risk.entry.value = STATE.lastPrice ? STATE.lastPrice : '';
    UI.risk.stop.value = '';
    UI.risk.tp.value = '';
    UI.risk.lev.value = 5;
    setSide('long');
    recalcRisk();
}

function setPriceAlert() {
    const target = parseFloat(UI.alert.input.value);
    if (Number.isNaN(target)) {
        UI.alert.status.innerText = 'Enter a valid alert price';
        return;
    }
    if (STATE.alertLine) seriesCandle.removePriceLine(STATE.alertLine);
    STATE.alertLine = seriesCandle.createPriceLine({ price: target, color: '#fcd535', lineStyle: LightweightCharts.LineStyle.Dotted, axisLabelVisible: true, title: 'ALERT' });
    STATE.alertPrice = target;
    UI.alert.status.innerText = `Alert set at ${target}`;
    UI.alert.status.classList.remove('text-red-400');
}

function clearPriceAlert() {
    if (STATE.alertLine) seriesCandle.removePriceLine(STATE.alertLine);
    STATE.alertLine = null;
    STATE.alertPrice = null;
    UI.alert.status.innerText = 'No active alert';
    UI.alert.status.classList.remove('text-red-400');
}

function checkAlert(previous, current) {
    if (!STATE.alertPrice || previous === null) return;
    const crossedUp = previous < STATE.alertPrice && current >= STATE.alertPrice;
    const crossedDown = previous > STATE.alertPrice && current <= STATE.alertPrice;
    if (crossedUp || crossedDown) {
        UI.alert.status.innerText = `Alert hit @ ${STATE.alertPrice}`;
        UI.alert.status.classList.add('text-red-400');
        if (STATE.alertLine) seriesCandle.removePriceLine(STATE.alertLine);
        STATE.alertLine = null;
        STATE.alertPrice = null;
    }
}

function updateMeta() {
    const spread = (STATE.bbo.ask !== null && STATE.bbo.bid !== null) ? STATE.bbo.ask - STATE.bbo.bid : null;
    if (spread !== null) {
        if (UI.metrics.spread) UI.metrics.spread.innerText = spread.toFixed(2);
        if (UI.chips.spread) UI.chips.spread.innerText = `Spread ${spread.toFixed(2)}`;
        if (UI.metrics.bbo) UI.metrics.bbo.innerText = `${STATE.bbo.bid.toFixed(2)} / ${STATE.bbo.ask.toFixed(2)}`;
    }
    if (UI.metrics.mark && STATE.lastPrice !== null) UI.metrics.mark.innerText = STATE.lastPrice.toFixed(2);
    if (UI.metrics.updated && STATE.lastUpdate) UI.metrics.updated.innerText = new Date(STATE.lastUpdate).toLocaleTimeString();
    const latencyMs = STATE.lastWsTs ? Math.max(0, Date.now() - STATE.lastWsTs) : null;
    if (UI.metrics.latency) UI.metrics.latency.innerText = latencyMs !== null ? `${latencyMs} ms` : '-';
}

/**
 * CONTROLS
 */
function toggleIndicator(key, btn) {
    CONFIG.indicators[key] = !CONFIG.indicators[key];
    btn.classList.toggle('active');
    btn.style.color = CONFIG.indicators[key] ? '#fcd535' : '#848e9c';
    
    (async () => {
        const res = await fetch(`${CONFIG.api}/klines?symbol=${CONFIG.activeSymbol}&interval=${CONFIG.activeInterval}&limit=500`);
        const data = await res.json();
        const candles = data.map(d => ({ time: d[0]/1000, open: +d[1], high: +d[2], low: +d[3], close: +d[4], volume: +d[5] }));
        updateIndicators(candles);
    })();
}

function renderIndicatorsToolbox() {
    const groups = [
        { label: 'Trend', items: [
            { key:'sma',      name:'SMA (20)',           icon:'üìä' },
            { key:'ema',      name:'EMA (20)',           icon:'üìà' },
            { key:'ichimoku', name:'Ichimoku Cloud',     icon:'üåê' },
            { key:'sar',      name:'Parabolic SAR',      icon:'üî¥' },
            { key:'adx',      name:'ADX + DI¬± (14)',     icon:'üí™' },
        ]},
        { label: 'Momentum', items: [
            { key:'rsi',    name:'RSI (14)',              icon:'üìâ' },
            { key:'macd',   name:'MACD (12,26,9)',        icon:'üåä' },
            { key:'stoch',  name:'Stochastic',            icon:'üîÑ' },
            { key:'cci',    name:'CCI (20)',              icon:'üîÅ' },
            { key:'willr',  name:'Williams %R (14)',      icon:'‚öñÔ∏è' },
            { key:'squeeze',name:'Squeeze Momentum',      icon:'üí•' },
        ]},
        { label: 'Volatility', items: [
            { key:'bb',      name:'Bollinger Bands',      icon:'‚òÅÔ∏è' },
            { key:'atr',     name:'ATR (14)',             icon:'‚ö°' },
            { key:'keltner', name:'Keltner Channels',     icon:'üìê' },
            { key:'bbpct',   name:'BB %B + Bandwidth',    icon:'üìä' },
            { key:'hv',      name:'Hist. Volatility (20)',icon:'üìà' },
        ]},
        { label: 'Volume', items: [
            { key:'vwap', name:'VWAP + 1œÉ Bands', icon:'üíß' },
            { key:'obv',  name:'OBV',              icon:'üì¶' },
            { key:'cmf',  name:'CMF (21)',         icon:'üåä' },
            { key:'mfi',  name:'MFI (14)',         icon:'üí∞' },
        ]},
        { label: 'Statistical', items: [
            { key:'lrchannel', name:'LR Channel (100)', icon:'üìè' },
            { key:'zscore',    name:'Z-Score (20)',      icon:'üìê' },
            { key:'drawdown',  name:'Drawdown %',        icon:'üìâ' },
        ]},
        { label: 'S/R', items: [
            { key:'pivots', name:'Pivot Points', icon:'üéØ' },
        ]},
    ];

    UI.indicatorsList.innerHTML = groups.map(g => `
        <div class="text-[9px] uppercase tracking-widest text-gray-600 mt-3 mb-1 px-1">${g.label}</div>
        ${g.items.map(i => `
            <button id="btn-${i.key}" class="btn-tool" onclick="toggleIndicator('${i.key}', this)">
                <span style="display:inline-block;width:18px">${i.icon}</span> ${i.name}
            </button>
        `).join('')}
    `).join('');
}

function renderWatchlist() {
    UI.watchlist.innerHTML = CONFIG.watchlist.map(sym => `
        <div class="flex justify-between items-center p-2 hover:bg-[#2b3139] cursor-pointer rounded text-sm" onclick="selectSymbol('${sym}')">
            <span class="font-bold">${sym}</span>
            <span id="watch-price-${sym}" class="font-mono text-xs text-gray-400">--</span>
        </div>
    `).join('');
}

async function updateWatchlistPrices() {
    try {
        const symbols = CONFIG.watchlist.join('","');
        const res = await fetch(`${CONFIG.api}/ticker/price?symbols=["${symbols}"]`);
        const data = await res.json();
        data.forEach(item => {
            const el = document.getElementById(`watch-price-${item.symbol}`);
            if (el) {
                const oldPrice = parseFloat(el.innerText);
                const newPrice = parseFloat(item.price);
                el.innerText = newPrice;
                if (!isNaN(oldPrice)) {
                    el.style.color = newPrice >= oldPrice ? CHART_COLORS.candleUp : CHART_COLORS.candleDown;
                }
            }
        });
    } catch (e) {}
}

// Tab Switching
UI.tabs.forEach((tab, idx) => {
    tab.addEventListener('click', () => {
        UI.tabs.forEach(t => { t.classList.remove('text-[#fcd535]', 'border-b-2', 'border-[#fcd535]'); t.classList.add('text-gray-500'); });
        UI.views.forEach(v => v.classList.add('hidden'));
        
        tab.classList.remove('text-gray-500');
        tab.classList.add('text-[#fcd535]', 'border-b-2', 'border-[#fcd535]');
        UI.views[idx].classList.remove('hidden');
    });
});

// Mobile Menu
document.getElementById('mobile-menu').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('show');
});

// Mobile Bottom Nav
const mobileNavBtns = document.querySelectorAll('.mobile-nav-btn');
mobileNavBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        const view = btn.dataset.view;
        mobileNavBtns.forEach(b => {
            b.classList.remove('text-[#fcd535]');
            b.classList.add('text-gray-500');
        });
        btn.classList.add('text-[#fcd535]');
        btn.classList.remove('text-gray-500');

        const sidebar = document.getElementById('sidebar');
        const rightPanel = document.querySelector('.right-panel');
        
        sidebar.classList.remove('show');
        rightPanel.classList.remove('show');

        if (view === 'tools') {
            sidebar.classList.add('show');
        } else if (view === 'book') {
            rightPanel.classList.add('show');
            document.getElementById('tab-ob').click();
        } else if (view === 'trades') {
            rightPanel.classList.add('show');
            document.getElementById('tab-trades').click();
        }
    });
});

// Log Scale
let logScale = false;
document.getElementById('toggle-log').addEventListener('click', (e) => {
    logScale = !logScale;
    chartMain.priceScale().applyOptions({ mode: logScale ? LightweightCharts.PriceScaleMode.Logarithmic : LightweightCharts.PriceScaleMode.Normal });
    e.currentTarget.classList.toggle('active');
});

/**
 * REFRESH BUTTON HANDLER
 */
UI.refreshBtn.addEventListener('click', async () => {
    const icon = UI.refreshBtn.querySelector('span');
    icon.classList.add('spin-anim');
    
    // Reload All Data
    try {
        await loadMarket(CONFIG.activeSymbol);
        // Re-trigger fitContent to ensure chart is visible
        chartMain.timeScale().fitContent();
    } catch(e) {
        console.error(e);
    } finally {
        setTimeout(() => icon.classList.remove('spin-anim'), 500);
    }
});

// ‚îÄ‚îÄ‚îÄ FEAR & GREED INDEX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FG_COLORS = {
    'Extreme Fear': '#f6465d',
    'Fear': '#ff9800',
    'Neutral': '#fcd535',
    'Greed': '#0ecb81',
    'Extreme Greed': '#00e676'
};

async function fetchFearGreed() {
    try {
        const res = await fetch('https://api.alternative.me/fng/?limit=8&format=json');
        const data = await res.json();
        if (!data || !data.data || !data.data.length) return;

        const latest = data.data[0];
        const val = parseInt(latest.value);
        const label = latest.value_classification;
        const color = FG_COLORS[label] || '#fcd535';
        const ts = new Date(parseInt(latest.timestamp) * 1000);

        // Update gauge arc (semi-circle arc length ‚âà 141.4)
        const arcLen = (val / 100) * 141.4;
        const arc = document.getElementById('fg-arc');
        if (arc) {
            arc.setAttribute('stroke-dasharray', arcLen + ' 141.4');
            arc.setAttribute('stroke', color);
        }
        const fgVal = document.getElementById('fg-value');
        if (fgVal) { fgVal.textContent = val; fgVal.style.color = color; }
        const fgLbl = document.getElementById('fg-label');
        if (fgLbl) { fgLbl.textContent = label; fgLbl.style.color = color; }
        const fgUpd = document.getElementById('fg-updated');
        if (fgUpd) fgUpd.textContent = 'Updated: ' + ts.toLocaleDateString();

        // 7-day history bars
        const hist = document.getElementById('fg-history');
        if (hist) {
            hist.innerHTML = data.data.slice(0, 7).map(d => {
                const v = parseInt(d.value);
                const lbl = d.value_classification;
                const c = FG_COLORS[lbl] || '#fcd535';
                const dt = new Date(parseInt(d.timestamp) * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                return '<div class="flex items-center gap-2 text-[11px]">'
                    + '<span class="text-gray-500 w-14">' + dt + '</span>'
                    + '<div class="flex-1 h-1.5 bg-[#2b3139] rounded-full overflow-hidden">'
                    + '<div class="h-full rounded-full" style="width:' + v + '%;background:' + c + '"></div>'
                    + '</div>'
                    + '<span class="font-mono font-bold w-6 text-right" style="color:' + c + '">' + v + '</span>'
                    + '</div>';
            }).join('');
        }
    } catch (e) { console.warn('Fear & Greed fetch failed', e); }
}

// ‚îÄ‚îÄ‚îÄ COINGECKO LIVE MARKET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchCoinGeckoMarket() {
    try {
        const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=6&page=1&sparkline=false');
        const coins = await res.json();
        if (!Array.isArray(coins)) return;

        const container = document.getElementById('cg-coins');
        if (container) {
            container.innerHTML = coins.map(c => {
                const chg = c.price_change_percentage_24h || 0;
                const chgColor = chg >= 0 ? '#0ecb81' : '#f6465d';
                const sign = chg >= 0 ? '+' : '';
                const fmtPrice = c.current_price >= 1000
                    ? c.current_price.toLocaleString('en-US', { maximumFractionDigits: 0 })
                    : c.current_price.toLocaleString('en-US', { maximumFractionDigits: 4 });
                return '<div class="flex items-center gap-1 text-[11px] font-mono py-0.5">'
                    + '<img src="' + c.image + '" class="w-4 h-4 rounded-full" loading="lazy" onerror="this.style.display=\'none\'" />'
                    + '<span class="font-bold text-white w-10 truncate">' + c.symbol.toUpperCase() + '</span>'
                    + '<span class="flex-1 text-right text-gray-200">$' + fmtPrice + '</span>'
                    + '<span class="w-14 text-right font-bold" style="color:' + chgColor + '">' + sign + chg.toFixed(2) + '%</span>'
                    + '</div>';
            }).join('');
        }
        const updEl = document.getElementById('cg-updated');
        if (updEl) updEl.textContent = new Date().toLocaleTimeString();
    } catch (e) { console.warn('CoinGecko fetch failed', e); }
}

// ‚îÄ‚îÄ‚îÄ BTC DOMINANCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchDominance() {
    try {
        const res = await fetch('https://api.coingecko.com/api/v3/global');
        const data = await res.json();
        const pct = (data && data.data && data.data.market_cap_percentage && data.data.market_cap_percentage.btc) || 0;
        const bar = document.getElementById('dom-bar');
        const lbl = document.getElementById('dom-pct');
        if (bar) bar.style.width = pct.toFixed(1) + '%';
        if (lbl) lbl.textContent = pct.toFixed(1) + '%';
    } catch (e) {}
}

// Initialize
init();

// Sentiment data: load immediately, then refresh periodically
fetchFearGreed();
fetchCoinGeckoMarket();
fetchDominance();
setInterval(fetchFearGreed, 5 * 60 * 1000);
setInterval(fetchCoinGeckoMarket, 60 * 1000);
setInterval(fetchDominance, 5 * 60 * 1000);

</script>
</body>
</html>